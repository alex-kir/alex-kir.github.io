import{AmbientLight as e,BoxGeometry as t,Color as s,DirectionalLight as i,GridHelper as o,Group as n,MOUSE as r,Mesh as a,MeshBasicMaterial as l,MeshPhongMaterial as h,PerspectiveCamera as c,PlaneGeometry as u,Raycaster as d,RepeatWrapping as g,Scene as f,TextureLoader as b,Vector2 as w,WebGLRenderer as m}from"./threejs/three.module.js";import{FBXLoader as p}from"./jsm/loaders/FBXLoader.js";import{OrbitControls as C}from"./jsm/controls/OrbitControls.js";import{default as V}from"./jsm/libs/stats.module.js";class S{#e;constructor(e){this.#e=e}Dispose(){this.#e()}}class x{#t=[];constructor(){}Add(e){this.#t.push(e)}Clear(){const e=[...this.#t];this.#t.length=0;for(const t in e)t.Dispose()}}class v{#s=[];constructor(){}subscribe(e){this.Subscribe(e)}subscribeAndNotify(e){this.SubscribeAndNotify(e)}notify(...e){this.Notify(...e)}Subscribe(e){const t=(...t)=>e(...t),s={unsubscribe:()=>{this.#s=this.#s.filter(e=>e.wrapper!==t)}};return this.#s.push(t),s}SubscribeAndNotify(e){const t=this.Subscribe(e);return e(),t}Notify(...e){this.#s.forEach(t=>t(...e))}}class y{#i;#o=[];constructor(e){this.#i=e}get Value(){return this.#i}set Value(e){this.#i=e,this.#n()}Subscribe(e,t=null){const s=this.#o;s.push(e),t&&t.Add(new S(function(){y.#r(s,e)})),e(this.#i)}#n(){for(const e of this.#o)e(this.#i)}static#r(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}}class k{PlatformViewValue=new y(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}ContentValue=new y(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}SizeValue=new y([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}constructor(){this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(!e)return;const t=this.Size;e.Size=t,e.Position=[0,0]}}class _{#a=new Map;Add(e,t){return this.#a.set(e,t),this}With(e,t){return this.#a.set(e,t),this}Has(e){return this.#a.has(e)}GetOrDefault(e,t){return this.#a.has(e)?this.#a.get(e):t}Get(e){return this.#a.get(e)}TryGet(e){return[this.#a.has(e),this.#a.get(e)]}}class T{OnEvent(e){}}class M{PlatformViewValue=new y(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}PositionValue=new y([0,0]);get Position(){return this.PositionValue.Value}set Position(e){this.PositionValue.Value=e}SizeValue=new y([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}VisibleValue=new y(!0);get Visible(){return this.VisibleValue.Value}set Visible(e){this.VisibleValue.Value=e}ConstraintsValue=new y(new _);get Constraints(){return this.ConstraintsValue.Value}set Constraints(e){this.ConstraintsValue.Value=e}ThemeValue=new y(null);get Theme(){return this.ThemeValue.Value}set Theme(e){this.ThemeValue.Value=e}}class P extends M{WidgetsValue=new y(null);get Widgets(){return this.WidgetsValue.Value}set Widgets(e){this.WidgetsValue.Value=e}GesturesValue=new y(null);get Gestures(){return this.GesturesValue.Value}set Gestures(e){this.GesturesValue.Value=e}}class D extends M{static ScrollBarSize=10;ContentValue=new y(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(e){const[t,s]=e.Size,i=this.Size[0]-D.ScrollBarSize;e.Size=[i,s]}}}class z extends M{TextValue=new y("");get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new y("black");get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}TextAlignmentValue=new y([0,0]);get TextAlignment(){return this.TextAlignmentValue.Value}set TextAlignment(e){this.TextAlignmentValue.Value=e}FontSizeValue=new y(16);get FontSize(){return this.FontSizeValue.Value}set FontSize(e){this.FontSizeValue.Value=e}get TextSize(){return this.FontSizeValue.Value}set TextSize(e){this.FontSizeValue.Value=e}}class W extends M{DrawFuncValue=new y(null);get DrawFunc(){return this.DrawFuncValue.Value}set DrawFunc(e){this.DrawFuncValue.Value=e}InvalidateVisual(){this.DrawFuncValue.Value=this.DrawFuncValue.Value}}class A{#l;constructor(e){this.#l=e}#h(e){if(Array.isArray(e)){if(3==e.length)return"#"+e[0].toString(16).padStart(2,"0")+e[1].toString(16).padStart(2,"0")+e[2].toString(16).padStart(2,"0");console.log("#ParseColor | this array not supported yet")}return e}DrawLine(e,t,s,i,o,n){const r=this.#l;r instanceof CanvasRenderingContext2D&&(r.lineWidth=o,r.strokeStyle=this.#h(n),r.beginPath(),r.moveTo(e,t),r.lineTo(s,i),r.stroke())}DrawPath(e,t,s,i,o){const n=this.#l;if(!(n instanceof CanvasRenderingContext2D))return;const r=new Path2D;let a=0;const l=o.length,h=function(){const e=o[a];return a+=1,e};for(;a<l;)switch(h()){case"m":case"move":{const e=h(),t=h();r.moveTo(e,t);break}case"l":case"line":{const e=h(),t=h();r.lineTo(e,t);break}case"a":case"arc":{const e=h(),t=h(),s=h(),i=h(),o=h();r.arcTo(e,t,s,i,o);break}}e&&(n.fillStyle=this.#h(e),n.fill(r)),i&&(t&&r.closePath(),n.lineWidth=s,n.strokeStyle=this.#h(i),n.stroke(r))}}class R{static CreateElement({tagName:e=null,widget:t=null,debugColor:s=null}={}){null==e&&(e="div");const i=document.createElement(e);return i._disposables=new x,i}static SetChildren(e,t){for(;e.fisrtChild;){const t=e.lastChild;t._disposables.Clear(),e.removeChild(t)}for(const s of t)s&&e.appendChild(s)}static GetView(e){if(null==e)return null;if(e instanceof k){const t=R.CreateElement({widget:e,debugColor:"#00000010"});return t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",e.ContentValue.Subscribe(function(){R.SetChildren(t,[R.GetView(e.Content)])},t._disposables),new ResizeObserver(function(){e.Size=[t.offsetWidth,t.offsetHeight]}).observe(t),e.PlatformView=t,t}if(e instanceof D){const t=R.CreateElement({widget:e,debugColor:"#00000015"});return t.style.position="absolute",t.style["overflow-x"]="hidden",t.style["overflow-y"]="scroll",t.style["scrollbar-width"]="thin",t.style["scrollbar-color"]="#00000010 #ffffff10",this.#c(t,e),e.ContentValue.Subscribe(function(){R.SetChildren(t,[R.GetView(e.Content)])},t._disposables),e.PlatformView=t,t}if(e instanceof P){const t=R.CreateElement({widget:e,debugColor:"#ff000005"});return t.style.position="absolute",t.style.overflow="hidden",this.#c(t,e),e.WidgetsValue.Subscribe(function(){const s=e.Widgets?[...e.Widgets.map(function(e){return R.GetView(e)})]:[];R.SetChildren(t,s)},t._disposables),e.GesturesValue.Subscribe(function(){R.#u(t,e)},t._disposables),e.PlatformView=t,t}if(e instanceof z){const t=R.CreateElement({widget:e,debugColor:"#00ff0005"});return t.style.position="absolute",t.style.display="flex",t.style["font-family"]="sans-serif",this.#c(t,e),e.TextValue.Subscribe(function(){t.innerText=e.Text},t._disposables),e.FontSizeValue.Subscribe(function(){t.style["font-size"]=`${e.FontSize}px`},t._disposables),e.TextColorValue.Subscribe(function(){t.style.color=e.TextColor},t._disposables),e.TextAlignmentValue.Subscribe(function(){const[s,i]=e.TextAlignment;switch(s){case-1:case"start":case"left":t.style["justify-content"]="left",t.style["text-align"]="left";break;case 0:case"center":t.style["justify-content"]="center",t.style["text-align"]="center";break;case 1:case"end":case"right":t.style["justify-content"]="right",t.style["text-align"]="right"}switch(i){case-1:case"start":case"top":t.style["align-items"]="flex-start";break;case 0:case"center":t.style["align-items"]="center";break;case 1:case"end":case"bottom":t.style["align-items"]="flex-end"}},t._disposables),e.PlatformView=t,t}if(e instanceof W){const t=R.CreateElement({tagName:"canvas",widget:e});return t.style.position="absolute",this.#c(t,e),e.SizeValue.Subscribe(function(){t.width=""+2*e.Size[0],t.height=""+2*e.Size[1],R.#d(t,e)},t._disposables),e.DrawFuncValue.Subscribe(function(){R.#d(t,e)},t._disposables),e.PlatformView=t,t}return R.CreateElement({widget:e})}static#u(e,t){if(!(e instanceof Element))return void console.log("#SubscribeToEvents() | widget is not instance of Element");const s=t.Gestures;if(s&&s.length>0){const i=function(e){for(const i of s)i.OnEvent(e,t)},o=function(t){e.setPointerCapture(t.pointerId),i(t)},n=function(t){e.releasePointerCapture(t.pointerId),i(t)};e.onpointerdown=o,e.onpointerup=n,e.onpointercancel=i,e.onpointermove=i,e.onpointerenter=i,e.onpointerleave=i,e.onpointerout=i,e.onpointerover=i}else e.onpointerdown=null,e.onpointerup=null,e.onpointercancel=null,e.onpointermove=null,e.onpointerenter=null,e.onpointerleave=null,e.onpointerout=null,e.onpointerover=null}static#d(e,t){if(e.getContext){const s=e.getContext("2d");s.setTransform(1,0,0,1,0,0),s.scale(2,2),s.clearRect(0,0,e.width,e.height);const i=new A(s),o=t.DrawFunc;o&&o(i,t.Size[0],t.Size[1])}}static#c(e,t){t.SizeValue.Subscribe(function(){const s=t.Size;e.style.width=`${s[0]}px`,e.style.height=`${s[1]}px`},e._disposables),t.PositionValue.Subscribe(function(){const s=t.Position;e.style.left=`${s[0]}px`,e.style.top=`${s[1]}px`},e._disposables)}}class E{#g;constructor(e){this.#g=e}Show(e){const t=this.#g;for(;t.fisrtChild;)t.removeChild(t.lastChild);t.appendChild(R.GetView(e))}}class O extends W{RadiusValue=new y(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new y(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new y(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new y(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}constructor(){super(),this.DrawFunc=this.#f.bind(this);const e=this.InvalidateVisual.bind(this);this.RadiusValue.Subscribe(e),this.FillColorValue.Subscribe(e),this.StrokeColorValue.Subscribe(e),this.StrokeThicknessValue.Subscribe(e)}#f(e,t,s){const i=this.StrokeColor?this.StrokeThickness/2:0,o=this.Radius,n=i,r=t/2,a=t-i,l=i,h=s/2,c=s-i;e.DrawPath(this.FillColor,!0,this.StrokeThickness,this.StrokeColor,["m",i,s/2,"arc",n,l,r,l,o,"arc",a,l,a,h,o,"arc",a,c,r,c,o,"arc",n,c,n,h,o])}}class H extends T{#b=!1;#w;#m;#p;#C;constructor(e,{AnimateUp:t,AnimateDown:s,AnimateHover:i}){super(),this.#w=e,this.#p=s,this.#m=t,this.#C=i}OnEvent(e,t){if(e instanceof PointerEvent){if("pointerleave"==e.type&&this.#m&&this.#m(),"pointermove"==e.type){const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i?this.#b?this.#p&&this.#p():this.#C&&this.#C():this.#m&&this.#m()}if("pointerdown"==e.type)return this.#b=!0,void(this.#p&&this.#p());if(!1!==this.#b&&"pointerup"==e.type){this.#b=!1,this.#m&&this.#m();const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i&&this.#w()}}}}class F extends P{constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;const[t,s]=this.Size;if(!(t<1||s<1))for(const i of e){const e=i.Constraints,[o,n]=F.CalculateSize(t,e,"width","left","right"),[r,a]=F.CalculateSize(s,e,"height","top","bottom");i.Position=[o,r],i.Size=[n,a]}}static CalculateSize(e,t,s,i,o){const n=t.TryGet(s),r=t.TryGet(i),a=t.TryGet(o);let l=0,h=0;if(n[0])h=n[1],l=r[0]?r[1]:a[0]?e-a[1]-n[1]:(e-n[1])/2;else{const t=r[0]?r[1]:0;l=t,h=e-t-(a[0]?a[1]:0)}return[l,h]}}class G extends P{SpacingValue=new y(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;let t=0,s=G.CalculatePixelsPerPercent(e,this.Spacing,this.Size[0]-0,"width","width_proportional","left","right");for(const i of e)t+=this.#V(i,t,s),t+=this.Spacing}#V(e,t,s){var i=e.Constraints;const[o,n]=G.CalculateSize(i,"width","width_proportional","left",s);var[r,a]=F.CalculateSize(this.Size[1]-0,i,"height","top","bottom");return e.Position=[t+o,r],e.Size=[n,a],o+n+i.GetOrDefault("right",0)}static CalculateSize(e,t,s,i,o){let[n,r]=e.TryGet(t);return n||(r=e.GetOrDefault(s,1)*o),[e.GetOrDefault(i,0),r]}static CalculatePixelsPerPercent(e,t,s,i,o,n,r){let a=0,l=e.length>1?(e.length-1)*t:0;for(const t of e){const e=t.Constraints;l+=e.GetOrDefault(n,0)+e.GetOrDefault(r,0),e.Has(i)?l+=e.Get(i):a+=e.GetOrDefault(o,1)}var h=s-l;return h>0?h/a:0}}class j extends P{static#S=[0,0,0,0];SpacingValue=new y(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}PaddingValue=new y(j.#S);get Padding(){return this.PaddingValue.Value}set Padding(e){this.PaddingValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e)return;const t=e.length,[s,i,o,n]=this.Padding;let r=i;const a=this.Size[0];for(let i=0;i<t;i++){i>0&&(r+=this.Spacing);const t=e[i],n=t.Constraints,l=n.Has("height")?n.Get("height"):t.Size[1],h=n.Has("left")?n.Get("left"):0,c=n.Has("right")?n.Get("right"):0;t.Position=[h+s,r],t.Size=[a-h-c-s-o,l],r+=t.Size[1]}r+=n;const[l,h]=this.Size;h!=r&&(this.Size=[l,r])}}class N extends F{#x=new O;#v=new z;#y=new O;RadiusValue=new y(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new y(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new y(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new y(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}TextValue=new y(null);get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new y(null);get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}get TextAlignment(){return this.#v.TextAlignment}set TextAlignment(e){this.#v.TextAlignment=e}ClickAction=null;Command=new v;constructor(){super();const e=this;this.Widgets=[this.#x,this.#v,this.#y],this.Gestures=[new H(function(){e.OnClick()},{AnimateDown:function(){e.#y.FillColor="#00000010"},AnimateUp:function(){e.#y.FillColor="#00000000"},AnimateHover:function(){e.#y.FillColor="#ffffff10"}})],this.RadiusValue.Subscribe(function(){e.#x.Radius=e.Radius,e.#y.Radius=e.Radius}),this.FillColorValue.Subscribe(function(){e.#x.FillColor=e.FillColor}),this.StrokeColorValue.Subscribe(function(){e.#x.StrokeColor=e.StrokeColor}),this.StrokeThicknessValue.Subscribe(function(){e.#x.StrokeThickness=e.StrokeThickness}),this.TextValue.Subscribe(function(){e.#v.Text=e.Text}),this.TextColorValue.Subscribe(function(){e.#v.TextColor=e.TextColor})}OnClick(){this.ClickAction&&this.ClickAction(),this.Command.Notify()}}class B{static#k;static{const e=B.#k=new Map;e.set("block|house_6x3",{id:"house_6x3",width:1,height:2,fbxName:"a/home_6x3"}),e.set("block|house_3x3_hi",{id:"house_3x3_hi",width:1,height:1,fbxName:"a/home_3x3_hi"}),e.set("block|house_3x3_lo",{id:"house_3x3_lo",width:1,height:1,fbxName:"a/home_3x3_lo"}),e.set("block|garage_6x3",{id:"garage_6x3",width:1,height:2,fbxName:"a/garage_6x3"}),e.set("block|veranda_3x3_hi",{id:"veranda_3x3_hi",width:1,height:1,fbxName:"a/veranda_3x3_hi"}),e.set("block|veranda_3x3_lo",{id:"veranda_3x3_lo",width:1,height:1,fbxName:"a/veranda_3x3_lo"}),e.set("block_shift|house_6x3",{canShift:!1,order:0}),e.set("block_shift|house_3x3_hi",{canShift:!1,order:0}),e.set("block_shift|house_3x3_lo",{canShift:!1,order:0}),e.set("block_shift|garage_6x3",{canShift:!0,order:1}),e.set("block_shift|veranda_3x3_hi",{canShift:!0,order:2}),e.set("block_shift|veranda_3x3_lo",{canShift:!0,order:2}),e.set("key|1",{id:"house_6x3",title:"1.House\n6x3"}),e.set("key|2",{id:"house_3x3_hi",title:"2.House\n3x3 Hi"}),e.set("key|3",{id:"house_3x3_lo",title:"3.House\n3x3 Lo"}),e.set("key|4",{id:"garage_6x3",title:"4.Gararage\n6x3"}),e.set("key|5",{id:"veranda_3x3_hi",title:"5.Veranda\n3x3 Hi"}),e.set("key|6",{id:"veranda_3x3_lo",title:"6.Veranda\n3x3 Lo"});const t={allowed:!0};e.set("rules|hor|202|202",t),e.set("rules|hor|203|203",t),e.set("rules|hor|204|204",t),e.set("rules|hor|205|205",t),e.set("rules|hor|207|206",t),e.set("rules|hor|208|209",t),e.set("rules|hor|209|302",t),e.set("rules|hor|209|303",t),e.set("rules|hor|209|304",t),e.set("rules|hor|209|305",t),e.set("rules|hor|302|207",t),e.set("rules|hor|302|302",t),e.set("rules|hor|302|522",t),e.set("rules|hor|302|523",t),e.set("rules|hor|302|526",t),e.set("rules|hor|302|527",t),e.set("rules|hor|303|207",t),e.set("rules|hor|303|303",t),e.set("rules|hor|303|526",t),e.set("rules|hor|303|527",t),e.set("rules|hor|304|204",t),e.set("rules|hor|304|207",t),e.set("rules|hor|304|304",t),e.set("rules|hor|304|524",t),e.set("rules|hor|304|525",t),e.set("rules|hor|304|526",t),e.set("rules|hor|304|527",t),e.set("rules|hor|305|205",t),e.set("rules|hor|305|207",t),e.set("rules|hor|305|305",t),e.set("rules|hor|305|525",t),e.set("rules|hor|305|526",t),e.set("rules|hor|305|527",t),e.set("rules|hor|522|302",t),e.set("rules|hor|522|522",t),e.set("rules|hor|523|302",t),e.set("rules|hor|523|523",t),e.set("rules|hor|524|304",t),e.set("rules|hor|524|524",t),e.set("rules|hor|525|304",t),e.set("rules|hor|525|525",t),e.set("rules|hor|528|302",t),e.set("rules|hor|528|303",t),e.set("rules|hor|528|304",t),e.set("rules|hor|528|305",t),e.set("rules|hor|529|302",t),e.set("rules|hor|529|303",t),e.set("rules|hor|529|304",t),e.set("rules|hor|529|305",t),e.set("rules|ver|203|202",t),e.set("rules|ver|204|205",t),e.set("rules|ver|205|304",t),e.set("rules|ver|206|206",t),e.set("rules|ver|207|207",t),e.set("rules|ver|208|208",t),e.set("rules|ver|209|209",t),e.set("rules|ver|302|203",t),e.set("rules|ver|302|522",t),e.set("rules|ver|302|523",t),e.set("rules|ver|303|302",t),e.set("rules|ver|303|522",t),e.set("rules|ver|303|523",t),e.set("rules|ver|303|526",t),e.set("rules|ver|303|527",t),e.set("rules|ver|303|528",t),e.set("rules|ver|303|529",t),e.set("rules|ver|304|305",t),e.set("rules|ver|305|303",t),e.set("rules|ver|305|526",t),e.set("rules|ver|523|522",t),e.set("rules|ver|524|303",t),e.set("rules|ver|524|304",t),e.set("rules|ver|524|305",t),e.set("rules|ver|524|525",t),e.set("rules|ver|525|303",t),e.set("rules|ver|525|304",t),e.set("rules|ver|525|305",t),e.set("rules|ver|526|303",t),e.set("rules|ver|526|305",t),e.set("rules|ver|526|526",t),e.set("rules|ver|527|305",t),e.set("rules|ver|527|526",t),e.set("rules|ver|527|527",t),e.set("rules|ver|528|305",t),e.set("rules|ver|528|528",t),e.set("rules|ver|529|305",t),e.set("rules|ver|529|528",t),e.set("rules|ver|529|529",t),e.set("rules|hor|202|523",t),e.set("rules|hor|203|303",t),e.set("rules|hor|204|525",t),e.set("rules|hor|205|305",t),e.set("rules|hor|303|203",t),e.set("rules|hor|303|523",t),e.set("rules|hor|523|202",t),e.set("rules|hor|523|303",t),e.set("rules|hor|525|204",t),e.set("rules|hor|525|305",t),e.set("rules|ver|205|303",t),e.set("rules|ver|205|305",t),e.set("rules|ver|303|203",t),e.set("rules|ver|305|203",t),e.set("rules|ver|305|523",t)}static findEntity(...e){if(0==e.length)return null;const t=e.join("|");return B.#k.get(t)||null}static getEntity(...e){if(0==e.length)return null;const t=e.join("|");return B.#k.get(t)||(console.log("CMS | entity not found | ",e),null)}static getEntities(...e){const t=e.join("|")+"|",s=[];for(const[e,i]of B.#k)e.startsWith(t)&&s.push(i);return s}}function L(e){return Math.PI*e/180}const X=300;function $(e){return{x:Math.floor(e.x/X),y:-1-Math.floor(e.z/X)}}function U(e,t,s){const[i,o]=Y(e,t);s.set(i,0,o)}function Y(e,t){return[e*X+150,-150-t*X]}class I{#_;#s=[];constructor(e){this.#_=e}get Value(){return this.#_}set Value(e){this.#_=e,this.#n()}Subscribe(e,t=null){const s=this.SubscribeToChanges(listener,t);return e(this.#_),s}SubscribeToChanges(e,t=null){const s=(...t)=>e(...t);this.#s.push(s);const i=new DisposableAction(function(){var e,t,i;e=this.#s,t=s,(i=e.indexOf(t))>-1&&e.splice(i,1)});return t&&t.Add(i),i}#n(){for(const e of this.#s)e(this.#_)}}class K{#T;constructor(e){this.#T=e}ToArray(){return this.#T}ToList(){return this.#T}OrderBy(e){return new K(K.OrderBy(this.#T,e))}Select(e){return new K(K.Select(this.#T,e))}static Select(e,t){return e.map(t)}static OrderBy(e,t){const s=[...e];return s.sort(function(e,s){const i=t(e),o=t(s);return i<o?-1:i>o?1:0}),s}static RemoveAt(e,t){e.splice(t,1)}static Remove(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}static ToArray(e){return[...e]}}function J(e,t){let s=function(e){return e.endsWith(".csv")?"text/csv":e.endsWith(".json")?"application/json":e.endsWith(".txt")?"text/plain":"application/json"}(t);const i=new Blob([e],{type:s}),o=URL.createObjectURL(i),n=document.createElement("a");n.href=o,n.download=t,n.click(),URL.revokeObjectURL(o)}class Z{#M;#P;#D;#z;#W;#A;#R;#E;#O;#H;constructor(e,t,s,i,o,n){switch(this.#P=t,this.#D=s,this.#z=i,this.#W=o,this.#M=e,this.#A=n,n){case 0:this.#R=t,this.#E=s,this.#O=i,this.#H=o;break;case 180:this.#R=t-i+1,this.#E=s-o+1,this.#O=i,this.#H=o;break;case 90:this.#R=t,this.#E=s-i+1,this.#O=o,this.#H=i;break;case 270:this.#R=t-o+1,this.#E=s,this.#O=o,this.#H=i;break;default:throw`unexpected direction: '${n}'`}Object.freeze(this)}get name(){return this.#M}get x(){return this.#P}get y(){return this.#D}get width(){return this.#z}get height(){return this.#W}get direction(){return this.#A}get realX(){return this.#R}get realY(){return this.#E}get realWidth(){return this.#O}get realHeight(){return this.#H}#F=new I([0,0]);get worldPosition(){return this.#F}isIntersected(e){return!(!(e instanceof Z)||this.#R+this.#O-1<e.#R||e.#R+e.#O-1<this.#R||this.#E+this.#H-1<e.#E||e.#E+e.#H-1<this.#E)}forEachCell(e){for(let t=0;t<this.#O;t++)for(let s=0;s<this.#H;s++)e(this,this.#R+t,this.#E+s)}forEachCell_xz(e){for(let t=0;t<this.#O;t++)for(let s=0;s<this.#H;s++)e(this,this.#R+t,-(this.#E+s))}getCode_xz(e,t){const s=-t;return this.getCode(e,s)}getCode(e,t){let s=[0,0,0,0];switch(this.name){case"house_6x3":s=this.x==e&&this.y==t?[303,0,305,0]:[302,0,304,0];break;case"house_3x3_hi":s=[303,0,305,0];break;case"house_3x3_lo":s=[302,0,304,0];break;case"garage_6x3":s=this.x==e&&this.y==t?[203,207,205,209]:[202,206,204,208];break;case"veranda_3x3_hi":s=[523,527,525,529];break;case"veranda_3x3_lo":s=[522,526,524,528]}switch(this.#A){case 0:return s[0];case 90:return s[1];case 180:return s[2];case 270:return s[3];default:throw`unexpected direction: '${direction}'`}return 0}}class q{#G=[];constructor(){}get blocks(){return this.#G}blocksChanged=new v;canAdd(e){if(e instanceof Z){for(const t of this.#G)if(t.isIntersected(e))return!1;return q.#j([e,...this.#G])}return!1}add(e){return!!this.canAdd(e)&&(this.#G.push(e),this.blocksChanged.Notify(),!0)}remove(e){const t=this.#G.indexOf(e);if(-1!==t)return this.#G.splice(t,1),this.blocksChanged.Notify(),!0}printUndefinedRules(){q.#N.clear(),q.#j(this.#G);const e=[...q.#N].join("\n");return console.log(e),e}static#j(e){const t=[];for(const s of e)s instanceof Z&&s.forEachCell(function(e,s,i){t.push([e,s,i])});const s=new Map;let i=!0;const o=q.validatePlacementDefaults;for(const[e,n,r]of t){const t=e.getCode(n,r);s.has(`${n-1}:${r}`)&&(q.#B(s.get(`${n-1}:${r}`),t,"hor",o)||(i=!1)),s.has(`${n+1}:${r}`)&&(q.#B(t,s.get(`${n+1}:${r}`),"hor",o)||(i=!1)),s.has(`${n}:${r-1}`)&&(q.#B(s.get(`${n}:${r-1}`),t,"ver",o)||(i=!1)),s.has(`${n}:${r+1}`)&&(q.#B(t,s.get(`${n}:${r+1}`),"ver",o)||(i=!1)),s.set(`${n}:${r}`,t)}return i}static validatePlacementDefaults=!1;static#N=new Set;static#B(e,t,s,i){if(e&&t){const i=B.findEntity("rules",s,e,t);if(i)return i.allowed;const o=`${s}|${e}|${t}`;q.#N.add(o)}return i}}class Q extends k{#L;view3dHost;imageHost;constructor(e){super(),this.#L=e;const t=this.#L.houseViewModel,s=[];for(let e=1;e<=6;e+=1){const{id:i,title:o}=B.getEntity(`key|${e}`),n="◉ "+o.replace("\n"," "),r="⭘ "+o.replace("\n"," "),a=this.#X(r,function(){t.setBlockName(i)});t.activeToolChanged.SubscribeAndNotify(function(){a.Text=t.activeBlockName==i?n:r}),a.TextAlignment=[-1,0],a.Constraints.With("height",32),s.push(a)}const i=new P,o=new P;o.Constraints.With("top",0),o.Constraints.With("right",0),o.Constraints.With("width",100),o.Constraints.With("height",100);const n=new F;n.Widgets=[i,o];const r=new z;r.Text="⏷ Step 1. Place modules",r.Constraints.With("height",64),r.TextAlignment=[-1,0],r.FontSize=20;const a=new z;a.Constraints.With("height",32),a.Text="Rotate",a.TextAlignment=[-1,0];const l=this.#$("↶ Left",function(){t.rotateLeft()}),h=this.#$("↷ Right",function(){t.rotateRight()}),c=new G;c.Spacing=4,c.Constraints.With("height",32),c.Widgets=[l,h];const u=new z;u.Text="⏷ Rules",u.Constraints.With("height",64),u.TextAlignment=[-1,0],u.FontSize=20;const d=this.#U(),g=this.#$("Copy undefined rules",this.#Y.bind(this));g.Constraints.With("height",32);const f=new z;f.Text="⏷ Step 2. Save to JSON",f.Constraints.With("height",64),f.TextAlignment=[-1,0],f.FontSize=20;const b=new z;b.Text="⏵ Step 3. - - -",b.Constraints.With("height",64),b.TextAlignment=[-1,0],b.FontSize=20;const w=[];e.forEachPlugin(e=>{const t=e.getWidget();t&&w.push(t)});const m=new K(w).OrderBy(e=>e.at(1)).Select(e=>e.at(0)).ToList(),p=new j;p.Padding=[8,8,8,8],p.Spacing=4,p.Widgets=[r,...s,a,c,u,d,g,b,...m];const C=new D;C.Constraints.With("width",300),C.Content=p;const V=new O;V.Constraints.With("width",5),V.FillColor="#ccc";const S=new G;S.Widgets=[n,V,C],this.view3dHost=i,this.imageHost=o,this.Content=S}#U(){const e="Allow if not defined",t="☑ "+e,s="☐ "+e,i=this.#X(s,function(){q.validatePlacementDefaults=!q.validatePlacementDefaults,i.Text=q.validatePlacementDefaults?t:s});return i.Text=q.validatePlacementDefaults?t:s,i.TextAlignment=[-1,0],i.Constraints.With("height",32),i}#Y(){const e=this.#L.houseViewModel.houseModel.printUndefinedRules();e.length?navigator.clipboard.writeText("new rules:\n"+e):navigator.clipboard.writeText("no new rules found")}#X(e,t){const s=new N;return s.Text=e,s.Command.Subscribe(t),s}#$(e,t){const s=new N;return s.Radius=6,s.StrokeColor="#ccc",s.StrokeThickness=1,s.Text=e,s.Command.Subscribe(t),s}}class ee{#I=new q;activeBlockName=B.getEntity("key|1").id;activeDirection=0;activeToolChanged=new v;get houseModel(){return this.#I}get blocksChanged(){return this.#I.blocksChanged}blockToSceneObjMapping=new Map;constructor(){}setDirection(e){this.activeDirection=e,this.#K(),this.#J()}rotateLeft(){switch(this.activeDirection){case 0:this.activeDirection=270;break;case 90:this.activeDirection=0;break;case 180:this.activeDirection=90;break;case 270:this.activeDirection=180}this.#K(-1),this.#J()}rotateRight(){switch(this.activeDirection){case 0:this.activeDirection=90;break;case 90:this.activeDirection=180;break;case 180:this.activeDirection=270;break;case 270:this.activeDirection=0}this.#K(),this.#J()}#K(e){if(this.activeBlockName.startsWith("house_"))if(-1===e)switch(this.activeDirection){case 90:this.activeDirection=0;break;case 270:this.activeDirection=180}else switch(this.activeDirection){case 90:this.activeDirection=180;break;case 270:this.activeDirection=0}}setBlockName(e){this.activeBlockName=e,this.#K(),this.#J()}#J(){this.activeToolChanged.notify()}canPlaceAtCoords(e){const{width:t,height:s}=B.getEntity("block",this.activeBlockName),i=new Z(this.activeBlockName,e.x,e.y,t,s,this.activeDirection);return this.#I.canAdd(i)}placeAtCoords(e){const{width:t,height:s}=B.getEntity("block",this.activeBlockName),i=new Z(this.activeBlockName,e.x,e.y,t,s,this.activeDirection);this.#I.add(i)}removeAtCoords(e){const t=new Z(null,e.x,e.y,1,1,0),s=[];for(const e of this.#I.blocks)e.isIntersected(t)&&s.push(e);for(const e of s)this.#I.remove(e)}}class te{static registeredPluginClasses=[];#Z;get viewManager(){return this.#Z}get scene(){return this.#Z.scene}get houseViewModel(){return this.#Z.rootViewModel.houseViewModel}get houseModel(){return this.#Z.rootViewModel.houseViewModel.houseModel}get resourceManager(){return this.#Z.rootViewModel.resourceManager}onSceneCreated(e){this.#Z=e}onRender(e){}onPointerMove(e,t){}onPointerDown(e,t){}onDocumentKeyDown(e){}onDocumentKeyUp(e){}getWidget(){return null}static registerPlugin(e){te.registeredPluginClasses.push(e)}}class se{#q=[];get plugins(){return this.#q}resourceManager;#Q=new ee;get houseViewModel(){return this.#Q}houseModel=new q;constructor(e){this.resourceManager=e}loadPlugins(){for(const e of te.registeredPluginClasses)this.#q.push(new e)}forEachPlugin(e){for(const t of this.#q)e(t)}}class ie{#L;get rootViewModel(){return this.#L}get canvas(){return this.renderer.domElement}get container(){return this.renderer.domElement.parentNode}camera;scene;renderer;#ee=new d;#te=new w;forEachPlugin(e){this.#L.forEachPlugin(e)}init(t,o){this.#L=o;const n=new c(45,320/240,1,1e4);this.camera=n,this.camera.position.set(1700,800,1600),this.camera.lookAt(0,0,0);const r=new f;this.scene=r,this.scene.background=new s(15790320),this.renderer=new m({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setAnimationLoop(this.render.bind(this)),t.appendChild(this.renderer.domElement);const a=new e(6316128,3);r.add(a);const l=new i(16777215,3);l.position.set(1,.75,.5).normalize(),r.add(l),this.forEachPlugin(e=>e.onSceneCreated(this)),t.addEventListener("pointermove",this.#se.bind(this)),t.addEventListener("pointerdown",this.#ie.bind(this)),document.addEventListener("keydown",this.#oe.bind(this)),document.addEventListener("keyup",this.#ne.bind(this)),new ResizeObserver(this.#re.bind(this)).observe(t),this.#re(),o.resourceManager.requestRender.subscribe(()=>this.render())}#se(e){this.#ae(e),this.forEachPlugin(t=>t.onPointerMove(e,this.#ee))}#ie(e){this.#ae(e),this.forEachPlugin(t=>t.onPointerDown(e,this.#ee))}#oe(e){this.forEachPlugin(t=>t.onDocumentKeyDown(e))}#ne(e){this.forEachPlugin(t=>t.onDocumentKeyUp(e))}#ae(e){const t=e.layerX,s=e.layerY,i=e.target.offsetWidth,o=e.target.offsetHeight;return this.#te.set(t/i*2-1,1-s/o*2),this.#ee.setFromCamera(this.#te,this.camera),!0}#re(){const e=this.container,t=e.offsetWidth,s=e.offsetHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s),this.render()}render(){this.forEachPlugin(e=>e.onRender(this)),this.renderer.render(this.scene,this.camera)}}class oe{#le;#he;#ce;requestRender=new v;constructor(){this.#le=new p,this.#he=new Map,this.#ce=new Map}getObject(e){if("column"==e)return this.#ue();if("grass"==e)return this.#de();const t=new n,s=this.#he;if(s.has(e))t.add(s.get(e).clone());else{const i=this.#ce;if(i.has(e))i.get(e).push(t);else{const o=[];o.push(t),i.set(e,o),this.#le.load("models/"+e+".fbx",t=>{t.scale.set(.1,.1,.1),e.startsWith("a/")&&(t.rotation.set(0,L(0),0),t.position.set(-150,0,150)),s.set(e,t),o.forEach(e=>{e.add(t.clone())}),o.length&&this.requestRender.Notify(),o.length=0})}}return t}#ge;#fe;#ue(){return this.#ge||(this.#ge=new t(10,600,10),this.#ge.translate(0,300,0)),this.#fe||(this.#fe=new l({color:0})),new a(this.#ge,this.#fe)}#be;#we;#de(){if(this.#be||(this.#be=new t(300,10,300),this.#be.translate(0,-6,0)),!this.#we){const e=(new b).load("textures/Grass_001_SD/Grass_001_COLOR.jpg");e.wrapS=g,e.wrapT=g,e.repeat.set(.1,.1);const t=(new b).load("textures/Grass_001_SD/Grass_001_NORM.jpg");t.wrapS=g,t.wrapT=g,t.repeat.set(.1,.1),this.#we=new h({map:e}),this.#we.normalMap=t,this.#we.normalScale.set(1,1)}return new a(this.#be,this.#we)}}te.registerPlugin(class extends te{#me;#pe;#Ce;#Ve;constructor(){super(),this.#me=new o(6e3,20,11206570,11206570)}onSceneCreated(e){super.onSceneCreated(e),e.scene.add(this.#me);for(let e=-10;e<10;e++)for(let t=-10;t<10;t++){const s=this.resourceManager.getObject("grass");this.scene.add(s),U(e,t,s.position)}}}),te.registerPlugin(class extends te{#Se;constructor(){super()}onSceneCreated(e){const t=new C(e.camera,e.renderer.domElement);t.minDistance=500,t.maxDistance=5e3,t.minPolarAngle=L(0),t.maxPolarAngle=L(90),t.target.set(0,175,0),t.mouseButtons={RIGHT:r.ROTATE},t.update(),this.#Se=t}});class ne{#xe;#pe;#ve=!1;#ye=null;get visible(){return this.#ve}constructor(){const e=new t(320,100,320);e.translate(0,50,0);const s=new l({color:10305403,transparent:!0,opacity:.5});this.#pe=new a(e,s),this.#ye=this.#pe}setScene(e){this.#xe=e,this.#ve&&this.#xe.add(this.#ye)}setDirection(e){this.#ye.rotation.set(0,L(-e),0)}setModel(e){if(this.#ye==e)return;const t=this.#ye;this.#ve&&this.#xe.remove(this.#ye),this.#ye=e||this.#pe,this.#ve&&this.#xe.add(this.#ye),this.#ye.position.copy(t.position),this.#ye.rotation.copy(t.rotation)}showAt(e){this.#ve||(this.#ve=!0,this.#xe&&this.#xe.add(this.#ye)),function(e,t){const s=$(e);U(s.x,s.y,t)}(e,this.#ye.position)}hide(){this.#ve&&(this.#ve=!1,this.#xe&&this.#xe.remove(this.#ye))}getCoords(){return $(this.#ye.position)}}function re(e,t,s,i){t.add(e),s.push(e);const o=function(e,t){const s=[];for(const i of t)e!==i&&ae(e,i)&&s.push(i);return s}(e,i);for(const n of o)t.has(n)||n.name!==e.name||re(n,t,s,i)}function ae(e,t){const s=(e.x+e.width===t.x||t.x+t.width===e.x)&&e.y<t.y+t.height&&e.y+e.height>t.y,i=(e.y+e.height===t.y||t.y+t.height===e.y)&&e.x<t.x+t.width&&e.x+e.width>t.x;return s||i}function le(e,t){const s=[];return e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x+e.width===t.x&&s.push("right"),t.x+t.width===e.x&&s.push("left")),e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y+e.height===t.y&&s.push("down"),t.y+t.height===e.y&&s.push("up")),s}function he(e,t){const s=new Set;for(const i of e)for(const e of t){const t=le(i,e);for(const e of t)s.add(e)}return[...s]}function ce(e,t){const s=new Set;for(const i of t){const t=he(e,i);for(const e of t)s.add(e)}return[...s]}te.registerPlugin(class extends te{#ke;#_e=new ne;#Te;#Me;constructor(){super();const e=new u(6e3,6e3);e.rotateX(-Math.PI/2),this.#ke=new a(e,new l({visible:!1}))}onSceneCreated(e){super.onSceneCreated(e),this.#Te=new Map;for(const{id:e,fbxName:t}of B.getEntities("block"))this.#Te.set(e,this.resourceManager.getObject(t));this.houseViewModel.activeToolChanged.subscribeAndNotify(this.#Pe.bind(this)),this.#_e.setScene(e.scene)}#Pe(){this.#_e.setDirection(this.houseViewModel.activeDirection),this.#Me=this.#Te.get(this.houseViewModel.activeBlockName),this.houseViewModel.canPlaceAtCoords(this.#_e.getCoords())?this.#_e.setModel(this.#Me):this.#_e.setModel(null)}onPointerMove(e,t){const s=t.intersectObject(this.#ke,!0);if(0===s.length)return void this.#_e.hide();const i=s[0];this.#_e.showAt(i.point),this.houseViewModel.canPlaceAtCoords(this.#_e.getCoords())?this.#_e.setModel(this.#Me):this.#_e.setModel(null)}onPointerDown(e,t){1===e.buttons&&this.#_e.visible&&(this.houseViewModel.canPlaceAtCoords(this.#_e.getCoords())?this.houseViewModel.placeAtCoords(this.#_e.getCoords()):this.houseViewModel.removeAtCoords(this.#_e.getCoords()),this.#_e.setModel(null))}}),te.registerPlugin(class extends te{#De;constructor(){super(),this.#De=new V}onSceneCreated(e){document.body.appendChild(this.#De.dom)}onRender(e){this.#De.update()}}),te.registerPlugin(class extends te{onDocumentKeyDown(e){switch(e.key){case"ArrowLeft":this.houseViewModel.rotateLeft();break;case"ArrowRight":this.houseViewModel.rotateRight();break;case"1":case"2":case"3":case"4":case"5":case"6":const{id:t}=B.getEntity(`key|${e.key}`);this.houseViewModel.activeBlockName==t?this.houseViewModel.rotateRight():this.houseViewModel.setBlockName(t)}}}),te.registerPlugin(class extends te{constructor(){super()}onSceneCreated(e){super.onSceneCreated(e),this.houseModel.blocksChanged.subscribeAndNotify(this.#ze.bind(this))}#We(e){const t=this.houseViewModel.blockToSceneObjMapping;if(t.has(e))return t.get(e);const{fbxName:s}=B.getEntity("block",e.name),i=this.resourceManager.getObject(s);return i.rotation.set(0,L(-e.direction),0),t.set(e,i),this.scene.add(i),i}#ze(){const e=this.houseViewModel.blockToSceneObjMapping;for(const e of this.houseModel.blocks)this.#We(e);this.#Ae();const t=[];for(const s of e.keys())this.houseModel.blocks.includes(s)||t.push(s);for(const s of t){const t=e.get(s);e.delete(s),this.scene.remove(t)}}#Ae(){const e=this.houseModel.blocks.map(e=>{const{order:t}=B.getEntity("block_shift",e.name);return{block:e,x:e.realX,y:e.realY,width:e.realWidth,height:e.realHeight,name:`${t}`,order:t}}),t=function(e){const t=new Set,s=[];for(const i of e)if(!t.has(i)){const o=[];re(i,t,o,e),s.push(o)}return s}(K.OrderBy(e,e=>e.order));for(let e=0;e<t.length;e++){const s=t.slice(0,e),i=t[e],o=ce(i,s);let n=0,r=0;for(const e of o)switch(e){case"left":n+=42.5;break;case"right":n-=42.5;break;case"up":r+=42.5;break;case"down":r-=42.5}for(const{block:e}of i){const t=this.#We(e);U(e.x,e.y,t.position),t.position.set(t.position.x+n,t.position.y,t.position.z-r)}}}}),te.registerPlugin(class extends te{#Re;#Ee=[];constructor(){super();const e=new z;e.Constraints.With("height",48),e.Text="☑ Show House Columns",e.TextAlignment=[-1,0],this.#Re=e}getWidget(){return[this.#Re,100]}onSceneCreated(e){super.onSceneCreated(e),this.houseModel.blocksChanged.subscribeAndNotify(this.#ze.bind(this))}#ze(){const e=new Set(this.#Ee);for(const t of this.houseModel.blocks)for(const[s,i]of this.#Oe(t)){const t=this.#He(s,i);if(t){e.delete(t);continue}const o=this.resourceManager.getObject("column");this.scene.add(o),this.#Ee.push(o),o.position.set(s,0,i)}for(const t of e)K.Remove(this.#Ee,t),this.scene.remove(t)}#He(e,t){for(const s of this.#Ee){const i=s.position.x,o=s.position.z;if(!(e+1<i||e-1>i||t+1<o||t-1>o))return s}return null}#Fe(e,t){const[s,i]=Y(e,t),[o,n]=Y(e-1,t-1);return[(o+s)/2,(n+i)/2]}#Oe(e){const t=this.houseViewModel.blockToSceneObjMapping.get(e),[s,i]=Y(e.x,e.y),o=t.position.x-s,n=t.position.z-i,r=[this.#Fe(e.realX,e.realY),this.#Fe(e.realX+e.realWidth,e.realY),this.#Fe(e.realX,e.realY+e.realHeight),this.#Fe(e.realX+e.realWidth,e.realY+e.realHeight)],a=[];for(const[e,t]of r)a.push([e+o,t+n]);return a}});class ue extends j{static#Ge="⏷";static#je="⏵";#Ne;#Be;HeaderTitleValue=new y;get HeaderTitle(){return this.HeaderTitleValue.Value}set HeaderTitle(e){this.HeaderTitleValue.Value=e}get BodyWidgets(){return this.#Be.Widgets}set BodyWidgets(e){this.#Be.Widgets=e}constructor(){super();const e=new N;e.Command.Subscribe(()=>{this.#Le()});const t=new z;t.TextAlignment=[-1,0],t.FontSize=20;const s=new O;s.Constraints.With("height",1).With("bottom",0),s.FillColor="#ccc";const i=this.#Ne=new F;i.Constraints.With("height",48),i.Widgets=[t,s,e];const o=this.#Be=new j;o.Padding=[8,4,0,16],o.Spacing=4,this.Widgets=[i,o],this.HeaderTitleValue.Subscribe(()=>{t.Text=ue.#Ge+" "+this.HeaderTitle})}#Le(){}}class de{static findBlocks(e){return e instanceof q?e.blocks:e instanceof ee?de.findBlocks(e.houseModel):e instanceof se?de.findBlocks(e.houseViewModel):null}static toJsonString(e){const t=de.findBlocks(e);if(0==t.size)return;let s=1e7,i=1e7;for(const e of t)e instanceof Z&&e.forEachCell(function(e,t,o){s=Math.min(s,t),i=Math.min(i,o)});const o=[];for(const e of t)e instanceof Z&&e.forEachCell((e,t,n)=>{o.push({code:e.getCode(t,n),x:t-s,z:n-i})});return JSON.stringify(o,null,2)}}te.registerPlugin(class extends te{#Re;constructor(){super();const e=new z;e.Text="JSON",e.TextAlignment=[-1,0],e.Constraints.With("height",32);const t=new N;t.Radius=6,t.StrokeColor="#ccc",t.StrokeThickness=1,t.Text="Download",t.Constraints.With("height",32),t.Command.Subscribe(()=>{J(de.toJsonString(this.houseViewModel),"house.json")});const s=new z;s.Text="CSV",s.TextAlignment=[-1,0],s.Constraints.With("height",32);const i=new N;i.Radius=6,i.StrokeColor="#ccc",i.StrokeThickness=1,i.Text="Download",i.Constraints.With("height",32),i.Command.Subscribe(()=>{J(this.#Xe(),"house.csv")});const o=new N;o.Radius=6,o.StrokeColor="#ccc",o.StrokeThickness=1,o.Text="Copy",o.Constraints.With("height",32),o.Command.Subscribe(()=>{const e=this.#Xe();navigator.clipboard.writeText(e)});const n=this.#Re=new ue;n.HeaderTitle="JSON / CSV",n.BodyWidgets=[e,t,s,o,i]}getWidget(){return[this.#Re,200]}#Xe(){const e=this.houseModel.blocks;if(0==e.size)return;let t=1e7,s=1e7,i=-1,o=-1;for(const n of e)n instanceof Z&&n.forEachCell_xz((e,n,r)=>{t=Math.min(t,n),s=Math.min(s,r),i=Math.max(i,n),o=Math.max(o,r)});const n=i-t+1,r=o-s+1,a=Array.from({length:r},()=>Array(n).fill(""));for(const i of e)i instanceof Z&&i.forEachCell_xz((e,i,o)=>{a[o-s][i-t]=e.getCode_xz(i,o)});return a.map(e=>e.join(",")).join("\n")}}),function(e){e||(e=document.querySelector("#container"));const t=new oe,s=new se(t);s.loadPlugins();const i=new Q(s);new E(e).Show(i),(new ie).init(i.view3dHost.PlatformView,s);var o=document.createElement("img");o.style.position="absolute",o.style.right="0px",o.style.top="0px",o.style.width="100px",o.style.height="100px",o.style.opacity=.7,o.src="./textures/cuby-logo.jpg",i.imageHost.PlatformView.appendChild(o)}();