import{AmbientLight as e,Box3 as t,BoxGeometry as s,Color as i,CubeTextureLoader as o,DirectionalLight as r,Euler as n,GridHelper as a,Group as l,MOUSE as h,Mesh as u,MeshBasicMaterial as c,MeshPhongMaterial as d,MeshStandardMaterial as g,PCFSoftShadowMap as f,PerspectiveCamera as x,PlaneGeometry as p,Raycaster as w,RepeatWrapping as b,Scene as m,TextureLoader as V,Vector2 as S,Vector3 as y,WebGLRenderer as C}from"./threejs/three.module.js";import{FBXLoader as v}from"./threejs/addons/loaders/FBXLoader.js";import"./threejs/addons/utils/ShadowMapViewer.js";import{OrbitControls as k}from"./threejs/addons/controls/OrbitControls.js";import{default as z}from"./threejs/addons/libs/stats.module.js";class M{#e;constructor(e){this.#e=e}Dispose(){this.#e()}}class _{#t=[];constructor(){}Add(e){this.#t.push(e)}Clear(){const e=[...this.#t];this.#t.length=0;for(const t of e)t.Dispose()}}class T{#s=[];constructor(){}subscribe(e){this.Subscribe(e)}subscribeAndNotify(e){this.SubscribeAndNotify(e)}notify(...e){this.Notify(...e)}Subscribe(e){const t=(...t)=>e(...t),s={unsubscribe:()=>{this.#s=this.#s.filter(e=>e.wrapper!==t)}};return this.#s.push(t),s}SubscribeAndNotify(e){const t=this.Subscribe(e);return e(),t}Notify(...e){this.#s.forEach(t=>t(...e))}}class P{#i;#o=[];constructor(e){this.#i=e}get Value(){return this.#i}set Value(e){this.#i=e,this.#r()}Subscribe(e,t=null){const s=this.#o;s.push(e),t&&t.Add(new M(()=>{P.#n(s,e)})),e(this.#i)}#r(){for(const e of this.#o)e(this.#i)}static#n(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}}class D{PlatformViewValue=new P(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}ContentValue=new P(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}SizeValue=new P([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}constructor(){this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(!e)return;const t=this.Size;e.Size=t,e.Position=[0,0]}}class W{#a=new Map;Add(e,t){return this.#a.set(e,t),this}With(e,t){return this.#a.set(e,t),this}Has(e){return this.#a.has(e)}GetOrDefault(e,t){return this.#a.has(e)?this.#a.get(e):t}Get(e){return this.#a.get(e)}TryGet(e){return[this.#a.has(e),this.#a.get(e)]}}class A{OnEvent(e){}}class L{PlatformViewValue=new P(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}PositionValue=new P([0,0]);get Position(){return this.PositionValue.Value}set Position(e){this.PositionValue.Value=e}SizeValue=new P([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}VisibleValue=new P(!0);get Visible(){return this.VisibleValue.Value}set Visible(e){this.VisibleValue.Value=e}ConstraintsValue=new P(new W);get Constraints(){return this.ConstraintsValue.Value}set Constraints(e){this.ConstraintsValue.Value=e}ThemeValue=new P(null);get Theme(){return this.ThemeValue.Value}set Theme(e){this.ThemeValue.Value=e}}class B extends L{WidgetsValue=new P(null);get Widgets(){return this.WidgetsValue.Value}set Widgets(e){this.WidgetsValue.Value=e}GesturesValue=new P(null);get Gestures(){return this.GesturesValue.Value}set Gestures(e){this.GesturesValue.Value=e}}class R extends L{static ScrollBarSize=10;ContentValue=new P(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(e){const[t,s]=e.Size,i=this.Size[0]-R.ScrollBarSize;e.Size=[i,s]}}}class E extends L{TextValue=new P("");get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new P("black");get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}TextAlignmentValue=new P([0,0]);get TextAlignment(){return this.TextAlignmentValue.Value}set TextAlignment(e){this.TextAlignmentValue.Value=e}FontSizeValue=new P(16);get FontSize(){return this.FontSizeValue.Value}set FontSize(e){this.FontSizeValue.Value=e}get TextSize(){return this.FontSizeValue.Value}set TextSize(e){this.FontSizeValue.Value=e}}class O extends L{DrawFuncValue=new P(null);get DrawFunc(){return this.DrawFuncValue.Value}set DrawFunc(e){this.DrawFuncValue.Value=e}InvalidateVisual(){this.DrawFuncValue.Value=this.DrawFuncValue.Value}}class H{#l;constructor(e){this.#l=e}#h(e){if(Array.isArray(e)){if(3==e.length)return"#"+e[0].toString(16).padStart(2,"0")+e[1].toString(16).padStart(2,"0")+e[2].toString(16).padStart(2,"0");console.log("#ParseColor | this array not supported yet")}return e}DrawLine(e,t,s,i,o,r){const n=this.#l;n instanceof CanvasRenderingContext2D&&(n.lineWidth=o,n.strokeStyle=this.#h(r),n.beginPath(),n.moveTo(e,t),n.lineTo(s,i),n.stroke())}DrawPath(e,t,s,i,o){const r=this.#l;if(!(r instanceof CanvasRenderingContext2D))return;const n=new Path2D;let a=0;const l=o.length,h=function(){const e=o[a];return a+=1,e};for(;a<l;)switch(h()){case"m":case"move":{const e=h(),t=h();n.moveTo(e,t);break}case"l":case"line":{const e=h(),t=h();n.lineTo(e,t);break}case"a":case"arc":{const e=h(),t=h(),s=h(),i=h(),o=h();n.arcTo(e,t,s,i,o);break}}e&&(r.fillStyle=this.#h(e),r.fill(n)),i&&(t&&n.closePath(),r.lineWidth=s,r.strokeStyle=this.#h(i),r.stroke(n))}}class j{static CreateElement({tagName:e=null,widget:t=null,debugColor:s=null}={}){null==e&&(e="div");const i=document.createElement(e);return i._disposables=new _,i}static SetChildren(e,t){for(;e.fisrtChild;){const t=e.lastChild;t._disposables.Clear(),e.removeChild(t)}for(const s of t)s&&e.appendChild(s)}static GetView(e){if(null==e)return null;if(e instanceof D){const t=j.CreateElement({widget:e,debugColor:"#00000010"});return t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",e.ContentValue.Subscribe(function(){j.SetChildren(t,[j.GetView(e.Content)])},t._disposables),new ResizeObserver(function(){e.Size=[t.offsetWidth,t.offsetHeight]}).observe(t),e.PlatformView=t,t}if(e instanceof R){const t=j.CreateElement({widget:e,debugColor:"#00000015"});return t.style.position="absolute",t.style["overflow-x"]="hidden",t.style["overflow-y"]="scroll",t.style["scrollbar-width"]="thin",t.style["scrollbar-color"]="#00000010 #ffffff10",this.#u(t,e),e.ContentValue.Subscribe(function(){j.SetChildren(t,[j.GetView(e.Content)])},t._disposables),e.PlatformView=t,t}if(e instanceof B){const t=j.CreateElement({widget:e,debugColor:"#ff000005"});return t.style.position="absolute",t.style.overflow="hidden",this.#u(t,e),e.WidgetsValue.Subscribe(function(){const s=e.Widgets?[...e.Widgets.map(function(e){return j.GetView(e)})]:[];j.SetChildren(t,s)},t._disposables),e.GesturesValue.Subscribe(function(){j.#c(t,e)},t._disposables),e.PlatformView=t,t}if(e instanceof E){const t=j.CreateElement({widget:e,debugColor:"#00ff0005"});return t.style.position="absolute",t.style.display="flex",t.style["font-family"]="sans-serif",this.#u(t,e),e.TextValue.Subscribe(function(){t.innerText=e.Text},t._disposables),e.FontSizeValue.Subscribe(function(){t.style["font-size"]=`${e.FontSize}px`},t._disposables),e.TextColorValue.Subscribe(function(){t.style.color=e.TextColor},t._disposables),e.TextAlignmentValue.Subscribe(function(){const[s,i]=e.TextAlignment;switch(s){case-1:case"start":case"left":t.style["justify-content"]="left",t.style["text-align"]="left";break;case 0:case"center":t.style["justify-content"]="center",t.style["text-align"]="center";break;case 1:case"end":case"right":t.style["justify-content"]="right",t.style["text-align"]="right"}switch(i){case-1:case"start":case"top":t.style["align-items"]="flex-start";break;case 0:case"center":t.style["align-items"]="center";break;case 1:case"end":case"bottom":t.style["align-items"]="flex-end"}},t._disposables),e.PlatformView=t,t}if(e instanceof O){const t=j.CreateElement({tagName:"canvas",widget:e});return t.style.position="absolute",this.#u(t,e),e.SizeValue.Subscribe(function(){t.width=""+2*e.Size[0],t.height=""+2*e.Size[1],j.#d(t,e)},t._disposables),e.DrawFuncValue.Subscribe(function(){j.#d(t,e)},t._disposables),e.PlatformView=t,t}return j.CreateElement({widget:e})}static#c(e,t){if(!(e instanceof Element))return void console.log("#SubscribeToEvents() | widget is not instance of Element");const s=t.Gestures;if(s&&s.length>0){const i=function(e){for(const i of s)i.OnEvent(e,t)},o=function(t){e.setPointerCapture(t.pointerId),i(t)},r=function(t){e.releasePointerCapture(t.pointerId),i(t)};e.onpointerdown=o,e.onpointerup=r,e.onpointercancel=i,e.onpointermove=i,e.onpointerenter=i,e.onpointerleave=i,e.onpointerout=i,e.onpointerover=i}else e.onpointerdown=null,e.onpointerup=null,e.onpointercancel=null,e.onpointermove=null,e.onpointerenter=null,e.onpointerleave=null,e.onpointerout=null,e.onpointerover=null}static#d(e,t){if(e.getContext){const s=e.getContext("2d");s.setTransform(1,0,0,1,0,0),s.scale(2,2),s.clearRect(0,0,e.width,e.height);const i=new H(s),o=t.DrawFunc;o&&o(i,t.Size[0],t.Size[1])}}static#u(e,t){t.SizeValue.Subscribe(function(){const s=t.Size;e.style.width=`${s[0]}px`,e.style.height=`${s[1]}px`},e._disposables),t.PositionValue.Subscribe(function(){const s=t.Position;e.style.left=`${s[0]}px`,e.style.top=`${s[1]}px`},e._disposables)}}class F{#g;constructor(e){this.#g=e}Show(e){const t=this.#g;for(;t.fisrtChild;)t.removeChild(t.lastChild);t.appendChild(j.GetView(e))}}class G{#f;#x;#p=new _;#w;#b=!1;constructor(e,t){this.#f=e,this.#x=t,e.WidgetsValue.Subscribe(()=>this.WidgetsChanged()),e.SizeValue.Subscribe(()=>this.Layout())}WidgetsChanged(){if(this.#p.Clear(),this.#f.Widgets)for(const e of this.#f.Widgets)e.VisibleValue.Subscribe(()=>this.Layout(),this.#p),e.SizeValue.Subscribe(()=>this.Layout(),this.#p);this.Layout()}Layout(){if(this.#b)this.#w=!0;else{this.#w=!1,this.#b=!0;try{this.#x(),this.#w&&this.#x()}finally{this.#b=!1}}}}class N extends O{RadiusValue=new P(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new P(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new P(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new P(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}constructor(){super(),this.DrawFunc=this.#m.bind(this);const e=this.InvalidateVisual.bind(this);this.RadiusValue.Subscribe(e),this.FillColorValue.Subscribe(e),this.StrokeColorValue.Subscribe(e),this.StrokeThicknessValue.Subscribe(e)}#m(e,t,s){const i=this.StrokeColor?this.StrokeThickness/2:0,o=this.Radius,r=i,n=t/2,a=t-i,l=i,h=s/2,u=s-i;e.DrawPath(this.FillColor,!0,this.StrokeThickness,this.StrokeColor,["m",i,s/2,"arc",r,l,n,l,o,"arc",a,l,a,h,o,"arc",a,u,n,u,o,"arc",r,u,r,h,o])}}class I extends A{#V=!1;#S;#y;#C;#v;constructor(e,{AnimateUp:t,AnimateDown:s,AnimateHover:i}){super(),this.#S=e,this.#C=s,this.#y=t,this.#v=i}OnEvent(e,t){if(e instanceof PointerEvent){if("pointerleave"==e.type&&this.#y&&this.#y(),"pointermove"==e.type){const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i?this.#V?this.#C&&this.#C():this.#v&&this.#v():this.#y&&this.#y()}if("pointerdown"==e.type)return this.#V=!0,void(this.#C&&this.#C());if(!1!==this.#V&&"pointerup"==e.type){this.#V=!1,this.#y&&this.#y();const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i&&this.#S()}}}}class $ extends B{constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;const[t,s]=this.Size;if(!(t<1||s<1))for(const i of e){const e=i.Constraints,[o,r]=$.CalculateSize(t,e,"width","left","right"),[n,a]=$.CalculateSize(s,e,"height","top","bottom");i.Position=[o,n],i.Size=[r,a]}}static CalculateSize(e,t,s,i,o){const r=t.TryGet(s),n=t.TryGet(i),a=t.TryGet(o);let l=0,h=0;if(r[0])h=r[1],l=n[0]?n[1]:a[0]?e-a[1]-r[1]:(e-r[1])/2;else{const t=n[0]?n[1]:0;l=t,h=e-t-(a[0]?a[1]:0)}return[l,h]}}class U extends B{SpacingValue=new P(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;let t=0,s=U.CalculatePixelsPerPercent(e,this.Spacing,this.Size[0]-0,"width","width_proportional","left","right");for(const i of e)t+=this.#k(i,t,s),t+=this.Spacing}#k(e,t,s){var i=e.Constraints;const[o,r]=U.CalculateSize(i,"width","width_proportional","left",s);var[n,a]=$.CalculateSize(this.Size[1]-0,i,"height","top","bottom");return e.Position=[t+o,n],e.Size=[r,a],o+r+i.GetOrDefault("right",0)}static CalculateSize(e,t,s,i,o){let[r,n]=e.TryGet(t);return r||(n=e.GetOrDefault(s,1)*o),[e.GetOrDefault(i,0),n]}static CalculatePixelsPerPercent(e,t,s,i,o,r,n){let a=0,l=e.length>1?(e.length-1)*t:0;for(const t of e){const e=t.Constraints;l+=e.GetOrDefault(r,0)+e.GetOrDefault(n,0),e.Has(i)?l+=e.Get(i):a+=e.GetOrDefault(o,1)}var h=s-l;return h>0?h/a:0}}class K extends B{static#z=[0,0,0,0];#M;SpacingValue=new P(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}PaddingValue=new P(K.#z);get Padding(){return this.PaddingValue.Value}set Padding(e){this.PaddingValue.Value=e}constructor(){super(),this.#M=new G(this,()=>this.#_()),this.SizeValue.Subscribe(()=>this.#M.Layout()),this.WidgetsValue.Subscribe(()=>this.#M.Layout())}Layout(){this.#M.Layout()}#_(){const e=this.Widgets;if(!e)return;const t=e.length,[s,i,o,r]=this.Padding;let n=i;const a=this.Size[0];for(let i=0;i<t;i++){i>0&&(n+=this.Spacing);const t=e[i],r=t.Constraints,l=r.Has("height")?r.Get("height"):t.Size[1],h=r.Has("left")?r.Get("left"):0,u=r.Has("right")?r.Get("right"):0;t.Position=[h+s,n],t.Size=[a-h-u-s-o,l],n+=t.Size[1]}n+=r;const[l,h]=this.Size;h!=n&&(this.Size=[l,n])}}class X extends ${#T=new N;#P=new E;#D=new N;RadiusValue=new P(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new P(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new P(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new P(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}TextValue=new P(null);get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new P(null);get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}get TextAlignment(){return this.#P.TextAlignment}set TextAlignment(e){this.#P.TextAlignment=e}ClickAction=null;Command=new T;constructor(){super();const e=this;this.Widgets=[this.#T,this.#P,this.#D],this.Gestures=[new I(function(){e.OnClick()},{AnimateDown:function(){e.#D.FillColor="#00000010"},AnimateUp:function(){e.#D.FillColor="#00000000"},AnimateHover:function(){e.#D.FillColor="#ffffff10"}})],this.RadiusValue.Subscribe(function(){e.#T.Radius=e.Radius,e.#D.Radius=e.Radius}),this.FillColorValue.Subscribe(function(){e.#T.FillColor=e.FillColor}),this.StrokeColorValue.Subscribe(function(){e.#T.StrokeColor=e.StrokeColor}),this.StrokeThicknessValue.Subscribe(function(){e.#T.StrokeThickness=e.StrokeThickness}),this.TextValue.Subscribe(function(){e.#P.Text=e.Text}),this.TextColorValue.Subscribe(function(){e.#P.TextColor=e.TextColor})}OnClick(){this.ClickAction&&this.ClickAction(),this.Command.Notify()}}class q{static#W="?";static isDev(){return!0===q.#W||!1!==q.#W&&(q.#W=-1!==(document.location+"").indexOf("127.0.0.1"),console.log("debug.#isDebug:",q.#W),q.#W)}static log(...e){this.isDev()&&console.log(...e)}static throwUndefined(...e){for(const t of e)if(void 0===t&&this.isDev())throw"undefined is not expected here"}static throw(e){if(this.isDev())throw e}}function J(e){return Math.PI*e/180}function Y(e,t,s){switch(s){case 0:return[e,t];case 90:return function(e,t){return[t,-e]}(e,t);case 180:return function(e,t){return[-e,-t]}(e,t);case 270:return function(e,t){return[-t,e]}(e,t)}q.throw(`unexpected rot(${e}, ${t}, ${s})`)}const Q=300;class Z{static fromVector(e){return{x:Math.round(e.x/Q),z:Math.round(e.z/Q)}}static toVector(e,t){return{x:e*Q,y:0,z:t*Q}}static roundVector(e){const{x:t,z:s}=this.fromVector(e);return this.toVector(t,s)}}class ee{#A;constructor(e){this.#A=e}ToArray(){return this.#A}ToList(){return this.#A}OrderBy(e){return new ee(ee.OrderBy(this.#A,e))}Select(e){return new ee(ee.Select(this.#A,e))}static Select(e,t){return e.map(t)}static OrderBy(e,t){const s=[...e];return s.sort(function(e,s){const i=t(e),o=t(s);return i<o?-1:i>o?1:0}),s}static RemoveAt(e,t){e.splice(t,1)}static Remove(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}static ToArray(e){return[...e]}}function te(e,t){let s=function(e){return e.endsWith(".csv")?"text/csv":e.endsWith(".json")?"application/json":e.endsWith(".txt")?"text/plain":"application/json"}(t);const i=new Blob([e],{type:s}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download=t,r.click(),URL.revokeObjectURL(o)}class se{static#L;static{const e=se.#L=new Map;e.set("block|house_6x3",{id:"house_6x3",width:1,height:2,fbxName:"a/home_6x3"}),e.set("block|house_3x3_hi",{id:"house_3x3_hi",width:1,height:1,fbxName:"a/home_3x3_hi"}),e.set("block|house_3x3_lo",{id:"house_3x3_lo",width:1,height:1,fbxName:"a/home_3x3_lo"}),e.set("block|garage_6x3",{id:"garage_6x3",width:1,height:2,fbxName:"a/garage_6x3"}),e.set("block|veranda_3x3_hi",{id:"veranda_3x3_hi",width:1,height:1,fbxName:"a/veranda_3x3_hi"}),e.set("block|veranda_3x3_lo",{id:"veranda_3x3_lo",width:1,height:1,fbxName:"a/veranda_3x3_lo"}),e.set("block_shift|house_6x3",{canShift:!1,order:0}),e.set("block_shift|house_3x3_hi",{canShift:!1,order:0}),e.set("block_shift|house_3x3_lo",{canShift:!1,order:0}),e.set("block_shift|garage_6x3",{canShift:!0,order:1}),e.set("block_shift|veranda_3x3_hi",{canShift:!0,order:2}),e.set("block_shift|veranda_3x3_lo",{canShift:!0,order:2}),e.set("key|1",{id:"house_6x3",title:"1.House\n6x3"}),e.set("key|2",{id:"house_3x3_hi",title:"2.House\n3x3 Hi"}),e.set("key|3",{id:"house_3x3_lo",title:"3.House\n3x3 Lo"}),e.set("key|4",{id:"garage_6x3",title:"4.Gararage\n6x3"}),e.set("key|5",{id:"veranda_3x3_hi",title:"5.Veranda\n3x3 Hi"}),e.set("key|6",{id:"veranda_3x3_lo",title:"6.Veranda\n3x3 Lo"});const t={allowed:!0};e.set("rules|hor|202|202",t),e.set("rules|hor|203|203",t),e.set("rules|hor|204|204",t),e.set("rules|hor|205|205",t),e.set("rules|hor|207|206",t),e.set("rules|hor|208|209",t),e.set("rules|hor|209|302",t),e.set("rules|hor|209|303",t),e.set("rules|hor|209|304",t),e.set("rules|hor|209|305",t),e.set("rules|hor|302|207",t),e.set("rules|hor|302|302",t),e.set("rules|hor|302|522",t),e.set("rules|hor|302|523",t),e.set("rules|hor|302|526",t),e.set("rules|hor|302|527",t),e.set("rules|hor|303|207",t),e.set("rules|hor|303|303",t),e.set("rules|hor|303|526",t),e.set("rules|hor|303|527",t),e.set("rules|hor|304|204",t),e.set("rules|hor|304|207",t),e.set("rules|hor|304|304",t),e.set("rules|hor|304|524",t),e.set("rules|hor|304|525",t),e.set("rules|hor|304|526",t),e.set("rules|hor|304|527",t),e.set("rules|hor|305|205",t),e.set("rules|hor|305|207",t),e.set("rules|hor|305|305",t),e.set("rules|hor|305|525",t),e.set("rules|hor|305|526",t),e.set("rules|hor|305|527",t),e.set("rules|hor|522|302",t),e.set("rules|hor|522|522",t),e.set("rules|hor|523|302",t),e.set("rules|hor|523|523",t),e.set("rules|hor|524|304",t),e.set("rules|hor|524|524",t),e.set("rules|hor|525|304",t),e.set("rules|hor|525|525",t),e.set("rules|hor|528|302",t),e.set("rules|hor|528|303",t),e.set("rules|hor|528|304",t),e.set("rules|hor|528|305",t),e.set("rules|hor|529|302",t),e.set("rules|hor|529|303",t),e.set("rules|hor|529|304",t),e.set("rules|hor|529|305",t),e.set("rules|ver|203|202",t),e.set("rules|ver|204|205",t),e.set("rules|ver|205|304",t),e.set("rules|ver|206|206",t),e.set("rules|ver|207|207",t),e.set("rules|ver|208|208",t),e.set("rules|ver|209|209",t),e.set("rules|ver|302|203",t),e.set("rules|ver|302|522",t),e.set("rules|ver|302|523",t),e.set("rules|ver|303|302",t),e.set("rules|ver|303|522",t),e.set("rules|ver|303|523",t),e.set("rules|ver|303|526",t),e.set("rules|ver|303|527",t),e.set("rules|ver|303|528",t),e.set("rules|ver|303|529",t),e.set("rules|ver|304|305",t),e.set("rules|ver|305|303",t),e.set("rules|ver|305|526",t),e.set("rules|ver|523|522",t),e.set("rules|ver|524|303",t),e.set("rules|ver|524|304",t),e.set("rules|ver|524|305",t),e.set("rules|ver|524|525",t),e.set("rules|ver|525|303",t),e.set("rules|ver|525|304",t),e.set("rules|ver|525|305",t),e.set("rules|ver|526|303",t),e.set("rules|ver|526|305",t),e.set("rules|ver|526|526",t),e.set("rules|ver|527|305",t),e.set("rules|ver|527|526",t),e.set("rules|ver|527|527",t),e.set("rules|ver|528|305",t),e.set("rules|ver|528|528",t),e.set("rules|ver|529|305",t),e.set("rules|ver|529|528",t),e.set("rules|ver|529|529",t),e.set("rules|hor|202|523",t),e.set("rules|hor|203|303",t),e.set("rules|hor|204|525",t),e.set("rules|hor|205|305",t),e.set("rules|hor|303|203",t),e.set("rules|hor|303|523",t),e.set("rules|hor|523|202",t),e.set("rules|hor|523|303",t),e.set("rules|hor|525|204",t),e.set("rules|hor|525|305",t),e.set("rules|ver|205|303",t),e.set("rules|ver|205|305",t),e.set("rules|ver|303|203",t),e.set("rules|ver|305|203",t),e.set("rules|ver|305|523",t),e.set("rules|hor|527|526",t),e.set("rules|hor|528|529",t),e.set("rules|ver|206|526",t),e.set("rules|ver|207|527",t),e.set("rules|ver|208|528",t),e.set("rules|ver|209|529",t),e.set("rules|ver|526|206",t),e.set("rules|ver|527|207",t),e.set("rules|ver|528|208",t),e.set("rules|ver|529|209",t)}static findEntity(...e){if(0==e.length)return null;const t=e.join("|");return se.#L.get(t)||null}static getEntity(...e){if(0==e.length)return null;const t=e.join("|");return se.#L.get(t)||(console.log("CMS | entity not found | ",e),null)}static getEntities(...e){const t=e.join("|")+"|",s=[];for(const[e,i]of se.#L)e.startsWith(t)&&s.push(i);return s}}class ie{#B;#R;#E;#O;#H;#j;constructor(e,t,s,i,o,r){q.throwUndefined(e,t,s,i,o,r),this.#B=e,this.#R=t,this.#E=s,this.#O=i,this.#H=o,this.#j=r,Object.freeze(this)}get name(){return this.#B}get x(){return this.#R}get z(){return this.#E}get width(){return this.#O}get height(){return this.#H}get direction(){return this.#j}isIntersected(e){if(e instanceof ie){let t=!1;return this.forEachCell((s,i,o)=>{e.forEachCell((e,s,r)=>{i==s&&o==r&&(t=!0)})}),t}return q.throw(`unexpected object ${e}`),!1}forEachCell(e){if(1!=this.#O||1!=this.#H){if(1==this.#O&&2==this.#H)switch(e(this,this.#R,this.#E),this.#j){case 0:return void e(this,this.#R,this.#E-1);case 90:return void e(this,this.#R+1,this.#E);case 180:return void e(this,this.#R,this.#E+1);case 270:return void e(this,this.#R-1,this.#E)}throw`unexpected block: '${this.#R}x${this.#E}A${direction}'`}e(this,this.#R,this.#E)}getOrigin(){return Z.toVector(this.x,this.z)}static#F=[{c:303,n:"house_6x3",d:0,o:!0},{c:305,n:"house_6x3",d:180,o:!0},{c:302,n:"house_6x3",d:0,o:!1},{c:304,n:"house_6x3",d:180,o:!1},{c:303,n:"house_3x3_hi",d:0,o:!0},{c:305,n:"house_3x3_hi",d:180,o:!0},{c:302,n:"house_3x3_lo",d:0,o:!0},{c:304,n:"house_3x3_lo",d:180,o:!0},{c:203,n:"garage_6x3",d:0,o:!0},{c:207,n:"garage_6x3",d:90,o:!0},{c:205,n:"garage_6x3",d:180,o:!0},{c:209,n:"garage_6x3",d:270,o:!0},{c:202,n:"garage_6x3",d:0,o:!1},{c:206,n:"garage_6x3",d:90,o:!1},{c:204,n:"garage_6x3",d:180,o:!1},{c:208,n:"garage_6x3",d:270,o:!1},{c:523,n:"veranda_3x3_hi",d:0,o:!0},{c:527,n:"veranda_3x3_hi",d:90,o:!0},{c:525,n:"veranda_3x3_hi",d:180,o:!0},{c:529,n:"veranda_3x3_hi",d:270,o:!0},{c:522,n:"veranda_3x3_lo",d:0,o:!0},{c:526,n:"veranda_3x3_lo",d:90,o:!0},{c:524,n:"veranda_3x3_lo",d:180,o:!0},{c:528,n:"veranda_3x3_lo",d:270,o:!0}];getCode(e,t){const s=this.name,i=this.#j,o=this.x==e&&this.#E==t;for(const{c:e,n:t,d:r,o:n}of ie.#F)if(t==s&&r==i&&n==o)return e}static fromCode(e,t,s){let i="",o=0;for(const{c:t,n:s,d:r,o:n}of ie.#F)"house_6x3"!=s&&t==e&&n&&(i=s,o=r);if(""==i)return null;const{width:r,height:n}=se.getEntity("block",i),a=new ie(i,t,s,r,n,o);return a.getCode(t,s)!=e&&(console.log(a,a.getCode(),e),q.throw("codes MUST be same")),a}}class oe{#G=[];constructor(){}get blocks(){return this.#G}blocksChanged=new T;canAdd(e){if(e instanceof ie){for(const t of this.#G)if(t.isIntersected(e))return!1;return oe.#N([e,...this.#G])}return!1}add(e){return!!this.canAdd(e)&&(this.#G.push(e),this.blocksChanged.Notify(),!0)}remove(e){const t=this.#G.indexOf(e);if(-1!==t)return this.#G.splice(t,1),this.blocksChanged.Notify(),!0}find(e,t){for(const s of this.#G){let i=!1;if(s.forEachCell((s,o,r)=>{o==e&&r==t&&(i=!0)}),i)return s}return null}printUndefinedRules(){oe.#I.clear(),oe.#N(this.#G);const e=[...oe.#I].join("\n");return console.log(e),e}static#N(e){const t=[];for(const s of e)s instanceof ie&&s.forEachCell(function(e,s,i){t.push([e,s,i])});const s=new Map;let i=!0;const o=oe.validatePlacementDefaults;for(const[e,r,n]of t){const t=-n,a=e.getCode(r,n);s.has(`${r-1}:${t}`)&&(oe.#$(s.get(`${r-1}:${t}`),a,"hor",o)||(i=!1)),s.has(`${r+1}:${t}`)&&(oe.#$(a,s.get(`${r+1}:${t}`),"hor",o)||(i=!1)),s.has(`${r}:${t-1}`)&&(oe.#$(s.get(`${r}:${t-1}`),a,"ver",o)||(i=!1)),s.has(`${r}:${t+1}`)&&(oe.#$(a,s.get(`${r}:${t+1}`),"ver",o)||(i=!1)),s.set(`${r}:${t}`,a)}return i}static validatePlacementDefaults=!1;static#I=new Set;static#$(e,t,s,i){if(e&&t){const i=se.findEntity("rules",s,e,t);if(i)return i.allowed;const o=`${s}|${e}|${t}`;oe.#I.add(o)}return i}}class re{#U;activeBlockName;activeDirection=0;activeToolChanged=new T;get houseModel(){return this.#U}get blocksChanged(){return this.#U.blocksChanged}blockToSceneObjMapping=new Map;constructor(e){this.#U=e,this.activeBlockName=se.getEntity("key|1").id}setDirection(e){this.activeDirection=e,this.#K(),this.#X()}rotateLeft(){switch(this.activeDirection){case 0:this.activeDirection=270;break;case 90:this.activeDirection=0;break;case 180:this.activeDirection=90;break;case 270:this.activeDirection=180}this.#K(-1),this.#X()}rotateRight(){switch(this.activeDirection){case 0:this.activeDirection=90;break;case 90:this.activeDirection=180;break;case 180:this.activeDirection=270;break;case 270:this.activeDirection=0}this.#K(),this.#X()}#K(e){if(this.activeBlockName.startsWith("house_"))if(-1===e)switch(this.activeDirection){case 90:this.activeDirection=0;break;case 270:this.activeDirection=180}else switch(this.activeDirection){case 90:this.activeDirection=180;break;case 270:this.activeDirection=0}}setBlockName(e){this.activeBlockName=e,this.#K(),this.#X()}#X(){this.activeToolChanged.notify()}canPlaceAtCoords(e){const{width:t,height:s}=se.getEntity("block",this.activeBlockName),i=new ie(this.activeBlockName,e.x,e.z,t,s,this.activeDirection);return this.#U.canAdd(i)}placeAtCoords(e){const{width:t,height:s}=se.getEntity("block",this.activeBlockName),i=new ie(this.activeBlockName,e.x,e.z,t,s,this.activeDirection);this.#U.add(i)}removeAtCoords(e){const t=new ie(null,e.x,e.z,1,1,0),s=[];for(const e of this.#U.blocks)e.isIntersected(t)&&s.push(e);for(const e of s)this.#U.remove(e)}}class ne{#q=new v;#J=new o;#Y=new Map;#Q;requestRender=new T;#Z;#ee=new Map;get materials(){return this.#ee}constructor(){this.#Z=this.#q.loadAsync("assets/models/v5/Typical_panel.fbx"),this.getObject("wall-house-tex")}getObject(e){if("column"==e)return this.#te();if("grass"==e)return this.#se();const t=new l;return this.#ie(t,e),t}async#ie(e,t){this.#Y.has(t)||this.#Y.set(t,this.#oe(t));const s=await this.#Y.get(t);e.add(s.clone())}async#oe(e){const t=await this.#re(e);return t.scale.set(.1,.1,.1),e.startsWith("a/")?(t.rotation.set(0,J(0),0),t.position.set(-150,0,150),t):(await this.#ne(t),t)}async#re(e){return"wall-house-tex"==e?await this.#Z:await this.#q.loadAsync("assets/models/"+e+".fbx")}async#ne(e){const t=[];e.traverse(e=>{e.isMesh&&t.push(e)});for(const e of t)e.material=await this.#ae(e.material),e.castShadow=!0,e.receiveShadow=!0}async#ae(e){const t=e.name;if(t.startsWith("FrontColor"))return this.#ee.get("Typical_panel_material:initialShadingGroup");if(this.#ee.has(t))return this.#ee.get(t);console.log("upgrade material:",t);const s=new g;return s.color.copy(e.color),s.map=e.map,s.name=e.name+".upgraded",s.normalMap=e.bumpMap,s.metalness=.95,s.roughness=.3,s.envMap=await this.#le(),console.log("src:",e),console.log("result:",s),this.#ee.set(t,s),s}async#le(){return this.#Q||(this.#Q=(async()=>await this.#J.loadAsync(["assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png"]))()),await this.#Q}#he;#ue;#te(){return this.#he||(this.#he=new s(10,600,10),this.#he.translate(0,300,0)),this.#ue||(this.#ue=new c({color:0})),new u(this.#he,this.#ue)}#ce;#de;#se(){if(this.#ce||(this.#ce=new s(300,10,300),this.#ce.translate(0,-6,0)),!this.#de){const e=(new V).load("assets/textures/grass_2/grass-3.jpg");e.wrapS=b,e.wrapT=b,e.repeat.set(.5,.5),this.#de=new d({map:e})}return new u(this.#ce,this.#de)}}class ae{#ge;get rootViewModel(){return this.#ge}get canvas(){return this.renderer.domElement}get container(){return this.renderer.domElement.parentNode}camera;scene;renderer;#fe;dirLight;dirLightCameraHelper;#xe=new w;#pe=new S;forEachPlugin(e){this.#ge.forEachPlugin(e)}init(t,s){this.#ge=s;const o=new x(45,320/240,1,1e4);this.camera=o,this.camera.position.set(1700,800,1600),this.camera.lookAt(0,0,0);const n=new m;this.scene=n,this.scene.background=new i(15790320),this.renderer=new C({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setAnimationLoop(this.render.bind(this)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=f,t.appendChild(this.renderer.domElement);const a=new e(6316128,3);n.add(a);const l=new r(16777215,2);l.position.set(1e3,1750,500),l.castShadow=!0,l.shadow.bias=-1e-4,l.shadow.normalBias=.05,l.shadow.radius=2,l.shadow.mapSize.width=2048,l.shadow.mapSize.height=2048,l.shadow.camera.near=1,l.shadow.camera.far=1e4,l.shadow.camera.right=150,l.shadow.camera.left=-250,l.shadow.camera.top=150,l.shadow.camera.bottom=-1250,this.dirLight=l,n.add(l),this.dirLightCameraHelper&&n.add(this.dirLightCameraHelper),this.#fe&&(this.#fe.position.x=10,this.#fe.position.y=10,this.#fe.size.width=100,this.#fe.size.height=100,this.#fe.update()),this.forEachPlugin(e=>e.onSceneCreated(this)),t.addEventListener("pointermove",this.#we.bind(this)),t.addEventListener("pointerdown",this.#be.bind(this)),document.addEventListener("keydown",this.#me.bind(this)),document.addEventListener("keyup",this.#Ve.bind(this)),new ResizeObserver(this.#Se.bind(this)).observe(t),this.#Se(),s.resourceManager.requestRender.subscribe(()=>this.render())}#we(e){this.#ye(e),this.forEachPlugin(t=>t.onPointerMove(e,this.#xe))}#be(e){this.#ye(e),this.forEachPlugin(t=>t.onPointerDown(e,this.#xe))}#me(e){this.forEachPlugin(t=>t.onDocumentKeyDown(e))}#Ve(e){this.forEachPlugin(t=>t.onDocumentKeyUp(e))}#ye(e){const t=e.layerX,s=e.layerY,i=e.target.offsetWidth,o=e.target.offsetHeight;return this.#pe.set(t/i*2-1,1-s/o*2),this.#xe.setFromCamera(this.#pe,this.camera),!0}#Se(){const e=this.container,t=e.offsetWidth,s=e.offsetHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s),this.#fe&&(this.#fe.position.x=10,this.#fe.position.y=10,this.#fe.size.width=100,this.#fe.size.height=100,this.#fe.update()),this.render()}render(){this.forEachPlugin(e=>e.onRender(this)),this.renderer.render(this.scene,this.camera),this.#fe&&this.#fe.render(this.renderer)}}class le extends K{static#Ce="⏷";static#ve="⏵";#ke;#ze;#Me;HeaderTitleValue=new P;get HeaderTitle(){return this.HeaderTitleValue.Value}set HeaderTitle(e){this.HeaderTitleValue.Value=e}get BodyWidgets(){return this.#Me.Widgets}set BodyWidgets(e){this.#Me.Widgets=e}constructor(){super();const e=new X;e.Command.Subscribe(()=>{this.#_e()});const t=this.#ke=new E;t.TextAlignment=[-1,0],t.FontSize=20;const s=new N;s.Constraints.With("height",1).With("bottom",0),s.FillColor="#ccc";const i=this.#ze=new $;i.Constraints.With("height",48),i.Widgets=[t,s,e];const o=this.#Me=new K;o.Padding=[8,4,0,16],o.Spacing=4,this.Widgets=[i,o],this.HeaderTitleValue.Subscribe(()=>this.#Te())}#_e(){1==this.Widgets.length?this.Widgets=[this.#ze,this.#Me]:this.Widgets=[this.#ze],this.#Te()}#Te(){1==this.Widgets.length?this.#ke.Text=le.#ve+" "+this.HeaderTitle:this.#ke.Text=le.#Ce+" "+this.HeaderTitle}}class he{pluginSections=[];#Pe=[];addSection(e){this.pluginSections.push(e)}addNewSection(e,...t){const s=new le;s.HeaderTitle=e,s.BodyWidgets=[...t],this.addSection(s)}getSharedSection(e){const t=this.#Pe.find(t=>t.HeaderTitle==e);if(t)return t;const s=new le;return s.HeaderTitle=e,s.BodyWidgets=[],this.pluginSections.push(s),this.#Pe.push(s),s}appendToSharedSection(e,t){const s=this.getSharedSection(e);s.BodyWidgets=[...s.BodyWidgets,t]}}class ue{static registeredPluginClasses=[];#De;get viewManager(){return this.#De}get scene(){return this.#De.scene}get houseViewModel(){return this.#De.rootViewModel.houseViewModel}get houseModel(){return this.#De.rootViewModel.houseViewModel.houseModel}get resourceManager(){return this.#De.rootViewModel.resourceManager}onSceneCreated(e){this.#De=e,this.onEnabled(),this.houseModel.blocksChanged.subscribeAndNotify(()=>this.onHouseBlocksChanged())}onEnabled(){}onHouseBlocksChanged(){}onRender(e){}onPointerMove(e,t){}onPointerDown(e,t){}onDocumentKeyDown(e){}onDocumentKeyUp(e){}getInspectorOrder(){return 0}onBuildInspector(e){}static registerPlugin(e){ue.registeredPluginClasses.push(e)}}class ce{#We=[];get plugins(){return this.#We}resourceManager;#Ae;get houseViewModel(){return this.#Ae}#U=new oe;constructor(e){this.resourceManager=e,this.#Ae=new re(this.#U)}loadPlugins(){for(const e of ue.registeredPluginClasses)this.#We.push(new e)}forEachPlugin(e){for(const t of this.#We)e(t)}}class de extends D{#ge;view3dHost;imageHost;constructor(e){super(),this.#ge=e;const t=new B,s=new B;s.Constraints.With("top",0),s.Constraints.With("right",0),s.Constraints.With("width",100),s.Constraints.With("height",100);const i=new $;i.Widgets=[t,s];const o=new ee(e.plugins).OrderBy(e=>e.getInspectorOrder()).ToList(),r=new he;for(const e of o)e.onBuildInspector(r);const n=new K;n.Padding=[8,8,8,32],n.Widgets=[...r.pluginSections];const a=new R;a.Constraints.With("width",300),a.Content=n;const l=new N;l.Constraints.With("width",5),l.FillColor="#ccc";const h=new U;h.Widgets=[i,l,a],this.view3dHost=t,this.imageHost=s,this.Content=h}}class ge{static Text(e){const t=new E;return t.Text=e,t.TextAlignment=[-1,0],t.Constraints.With("height",32),t}static Button(e,t){const s=new X;return s.Radius=6,s.StrokeColor="#ccc",s.StrokeThickness=1,s.Text=e,s.Constraints.With("height",32),s.Command.Subscribe(()=>t(s)),s}static Checkbox(e,t,s){const i="☑ "+e,o="☐ "+e,r=new X;return r.Text=t?i:o,r.TextAlignment=[-1,0],r.Constraints.With("height",32),r.Command.Subscribe(()=>{const e=s();!0===e&&(r.Text=i),!1===e&&(r.Text=o)}),r}static Checkbox2(e,t){if(t instanceof P)return this.Checkbox(e,t.Value,()=>(t.Value=!t.Value,t.Value))}static Radiobox(e,t,s){const i="◉ "+e,o="⭘ "+e,r=new X;return r.TextAlignment=[-1,0],r.Constraints.With("height",32),r.Command.Subscribe(()=>{s.Value=t}),s.Subscribe(e=>{r.Text=s.Value==t?i:o}),r}static Header(e){const t=new E;return t.Constraints.With("height",32),t.Text=e,t.TextAlignment=[-1,0],t}}ue.registerPlugin(class extends ue{#Le=new P(!0);#Be;constructor(){super();const e=3368499;this.#Be=new a(6300,21,e,e)}onEnabled(){this.viewManager.scene.add(this.#Be);for(let e=-10;e<=10;e++){let t=null;for(let s=-10;s<=10;s++){const i=this.resourceManager.getObject("grass");null==t&&(t=i.material.clone(),t.color.setRGB(.8+.02*e,1,.8-.02*e)),i.material=t,i.receiveShadow=!0,this.scene.add(i),i.position.copy(Z.toVector(s,e))}}this.#Le.Subscribe(()=>this.#Re())}onBuildInspector(e){e.appendToSharedSection("View",ge.Checkbox2("Show grid",this.#Le))}#Re(){this.#Be.visible=this.#Le.Value}}),ue.registerPlugin(class extends ue{constructor(){super()}onEnabled(){const e=new k(this.viewManager.camera,this.viewManager.renderer.domElement);e.minDistance=500,e.maxDistance=5e3,e.minPolarAngle=J(0),e.maxPolarAngle=J(90),e.target.set(0,175,0),e.mouseButtons={RIGHT:h.ROTATE,MIDDLE:h.PAN},e.update()}});class fe{#Ee;#Oe;#He=!1;#je=null;get visible(){return this.#He}constructor(){const e=new s(320,100,320);e.translate(0,50,0);const t=new c({color:10305403,transparent:!0,opacity:.5});this.#Oe=new u(e,t),this.#je=this.#Oe}setScene(e){this.#Ee=e,this.#He&&this.#Ee.add(this.#je)}setDirection(e){this.#je.rotation.set(0,J(-e),0)}setModel(e){if(this.#je==e)return;const t=this.#je;this.#He&&this.#Ee.remove(this.#je),this.#je=e||this.#Oe,this.#He&&this.#Ee.add(this.#je),this.#je.castShadow=!0,this.#je.position.copy(t.position),this.#je.rotation.copy(t.rotation)}showAt(e){this.#He||(this.#He=!0,this.#Ee&&this.#Ee.add(this.#je)),this.#je.position.copy(Z.roundVector(e))}hide(){this.#He&&(this.#He=!1,this.#Ee&&this.#Ee.remove(this.#je))}getCoords(){return Z.fromVector(this.#je.position)}}function xe(e,t,s,i){t.add(e),s.push(e);const o=function(e,t){const s=[];for(const i of t)e!==i&&pe(e,i)&&s.push(i);return s}(e,i);for(const r of o)t.has(r)||r.name!==e.name||xe(r,t,s,i)}function pe(e,t){const s=(e.x+e.width===t.x||t.x+t.width===e.x)&&e.y<t.y+t.height&&e.y+e.height>t.y,i=(e.y+e.height===t.y||t.y+t.height===e.y)&&e.x<t.x+t.width&&e.x+e.width>t.x;return s||i}function we(e,t){const s=[];return e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x+e.width===t.x&&s.push("right"),t.x+t.width===e.x&&s.push("left")),e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y+e.height===t.y&&s.push("down"),t.y+t.height===e.y&&s.push("up")),s}function be(e,t){const s=new Set;for(const i of e)for(const e of t){const t=we(i,e);for(const e of t)s.add(e)}return[...s]}function me(e,t){const s=new Set;for(const i of t){const t=be(e,i);for(const e of t)s.add(e)}return[...s]}ue.registerPlugin(class extends ue{#Fe;#Ge=new fe;#Ne;#Ie;constructor(){super();const e=new p(6300,6300);e.rotateX(-Math.PI/2),this.#Fe=new u(e,new c({visible:!1}))}onSceneCreated(e){super.onSceneCreated(e),this.#Ne=new Map;for(const{id:e,fbxName:t}of se.getEntities("block"))this.#Ne.set(e,this.resourceManager.getObject(t));this.houseViewModel.activeToolChanged.subscribeAndNotify(this.#$e.bind(this)),this.#Ge.setScene(e.scene)}#$e(){this.#Ge.setDirection(this.houseViewModel.activeDirection),this.#Ie=this.#Ne.get(this.houseViewModel.activeBlockName),this.houseViewModel.canPlaceAtCoords(this.#Ge.getCoords())?this.#Ge.setModel(this.#Ie):this.#Ge.setModel(null)}onPointerMove(e,t){const s=t.intersectObject(this.#Fe,!0);if(0===s.length)return void this.#Ge.hide();const i=s[0];this.#Ge.showAt(i.point),this.houseViewModel.canPlaceAtCoords(this.#Ge.getCoords())?this.#Ge.setModel(this.#Ie):this.#Ge.setModel(null)}onPointerDown(e,t){1===e.buttons&&this.#Ge.visible&&(this.houseViewModel.canPlaceAtCoords(this.#Ge.getCoords())?this.houseViewModel.placeAtCoords(this.#Ge.getCoords()):this.houseViewModel.removeAtCoords(this.#Ge.getCoords()),this.#Ge.setModel(null))}#Ue=new P;onEnabled(){this.#Ue.Value=this.houseViewModel.activeBlockName,this.#Ue.Subscribe(e=>{this.houseViewModel.setBlockName(e)})}getInspectorOrder(){return-1e3}onBuildInspector(e){const t=[];for(let e=1;e<=6;e+=1){const{id:s,title:i}=se.getEntity(`key|${e}`);t.push(ge.Radiobox(i.replace("\n"," "),s,this.#Ue))}const s=ge.Header("Rotation"),i=ge.Button("↶ Left",()=>{this.houseViewModel.rotateLeft()}),o=ge.Button("↷ Right",()=>{this.houseViewModel.rotateRight()}),r=new U;r.Spacing=4,r.Constraints.With("height",32),r.Widgets=[i,o];const n=new le;n.HeaderTitle="1. Place modules",n.BodyWidgets=[...t,s,r],e.addSection(n)}onDocumentKeyDown(e){switch(e.key){case"ArrowLeft":this.houseViewModel.rotateLeft();break;case"ArrowRight":this.houseViewModel.rotateRight();break;case"1":case"2":case"3":case"4":case"5":case"6":const{id:t}=se.getEntity(`key|${e.key}`);this.houseViewModel.activeBlockName==t?this.houseViewModel.rotateRight():this.houseViewModel.setBlockName(t)}}}),ue.registerPlugin(class extends ue{#Ke;constructor(){super(),this.#Ke=new z}onSceneCreated(e){document.body.appendChild(this.#Ke.dom)}onRender(e){this.#Ke.update()}}),ue.registerPlugin(class extends ue{#Xe=new P(!1);onEnabled(){this.#Xe.Subscribe(()=>this.#qe())}onBuildInspector(e){const t=e.getSharedSection("View"),s=ge.Checkbox2("Transparent",this.#Xe);t.BodyWidgets=[...t.BodyWidgets,s]}onHouseBlocksChanged(){const e=this.houseViewModel.blockToSceneObjMapping;for(const e of this.houseModel.blocks)this.#Je(e);this.#Ye();const t=[];for(const s of e.keys())this.houseModel.blocks.includes(s)||t.push(s);for(const s of t){const t=e.get(s);e.delete(s),this.scene.remove(t)}}#Je(e){const t=this.houseViewModel.blockToSceneObjMapping;if(t.has(e))return t.get(e);const{fbxName:s}=se.getEntity("block",e.name),i=this.resourceManager.getObject(s);return i.rotation.set(0,J(-e.direction),0),t.set(e,i),this.scene.add(i),this.#qe(),i}#Ye(){const e=[];this.houseModel.blocks.forEach(t=>{t instanceof ie&&t.forEachCell((s,i,o)=>{const{order:r}=se.getEntity("block_shift",t.name);e.push({block:t,x:i,y:o,width:1,height:1,name:`${r}`,order:r})})});const t=function(e){const t=new Set,s=[];for(const i of e)if(!t.has(i)){const o=[];xe(i,t,o,e),s.push(o)}return s}(ee.OrderBy(e,e=>e.order));for(let e=0;e<t.length;e++){const s=t.slice(0,e),i=t[e],o=me(i,s);let r=0,n=0;for(const e of o)switch(e){case"left":r+=42.5;break;case"right":r-=42.5;break;case"up":n+=42.5;break;case"down":n-=42.5}for(const{block:e}of i){const t=this.#Je(e);t.position.copy(Z.toVector(e.x,e.z)),t.position.set(t.position.x+r,-1,t.position.z+n)}}}#qe(){const e=this.houseViewModel.blockToSceneObjMapping;for(const t of e.values())t.traverse(e=>{if(e.isMesh){const t=e.material.clone();t.opacity=this.#Xe.Value?.5:1,t.transparent=this.#Xe.Value,e.material=t}})}}),ue.registerPlugin(class extends ue{#Qe=[];#Ze=new P(!1);onEnabled(){this.#Ze.Subscribe(()=>this.onHouseBlocksChanged())}getInspectorOrder(){return 100}onBuildInspector(e){const t=e.getSharedSection("View"),s=ge.Checkbox2("Show House Columns",this.#Ze);t.BodyWidgets=[...t.BodyWidgets,s]}onHouseBlocksChanged(){const e=new Set(this.#Qe);if(this.#Ze.Value)for(const t of this.houseModel.blocks)for(const[s,i]of this.#et(t)){const t=this.#tt(s,i);if(t){e.delete(t);continue}const o=this.resourceManager.getObject("column");this.scene.add(o),this.#Qe.push(o),o.position.set(s,0,i)}for(const t of e)ee.Remove(this.#Qe,t),this.scene.remove(t)}#tt(e,t){for(const s of this.#Qe){const i=s.position.x,o=s.position.z;if(!(e+1<i||e-1>i||t+1<o||t-1>o))return s}return null}#et(e){const t=this.houseViewModel.blockToSceneObjMapping.get(e);let s=e.x,i=e.x,o=e.z,r=e.z;e.forEachCell((e,t,n)=>{s=Math.min(s,t),i=Math.max(i,t),o=Math.min(o,n),r=Math.max(r,n)});const n=e.getOrigin(),a=t.position,l=a.x-n.x,h=a.z-n.z,u=[Z.toVector(s-.5,o-.5),Z.toVector(i+.5,o-.5),Z.toVector(i+.5,r+.5),Z.toVector(s-.5,r+.5)],c=[];for(const{x:e,z:t}of u)c.push([e+l,t+h]);return c}});class Ve{static findBlocks(e){return e instanceof oe?e.blocks:e instanceof re?Ve.findBlocks(e.houseModel):e instanceof ce?Ve.findBlocks(e.houseViewModel):null}static toJsonString(e){const t=Ve.findBlocks(e);if(0==t.size)return;let s=1e7,i=1e7;for(const e of t)e instanceof ie&&e.forEachCell(function(e,t,o){s=Math.min(s,t),i=Math.min(i,o)});const o=[];for(const e of t)e instanceof ie&&e.forEachCell((e,t,r)=>{o.push({code:e.getCode(t,r),x:t-s,z:r-i})});return JSON.stringify(o,null,2)}}ue.registerPlugin(class extends ue{#st;constructor(){super();const e=ge.Button("Download",()=>{te(Ve.toJsonString(this.houseViewModel),"house.json")}),t=ge.Button("Copy",()=>{const e=this.#it();navigator.clipboard.writeText(e)}),s=ge.Button("Save file...",()=>{te(this.#it(),"house.csv")}),i=ge.Button("Load file...",()=>this.#ot()),o=this.#st=new le;o.HeaderTitle="JSON / CSV",o.BodyWidgets=[ge.Text("JSON"),e,ge.Text("CSV"),t,s,i]}getInspectorOrder(){return 200}onBuildInspector(e){e.addSection(this.#st)}#it(){const e=this.houseModel.blocks;if(0==e.size)return;let t=1e7,s=1e7,i=-1,o=-1;for(const r of e)r instanceof ie&&r.forEachCell((e,r,n)=>{t=Math.min(t,r),s=Math.min(s,n),i=Math.max(i,r),o=Math.max(o,n)});const r=i-t+1,n=o-s+1,a=Array.from({length:n},()=>Array(r).fill(""));for(const i of e)i instanceof ie&&i.forEachCell((e,i,o)=>{a[o-s][i-t]=e.getCode(i,o)});return a.map(e=>e.join(",")).join("\n")}async#ot(){const e=await new Promise((e,t)=>{const s=document.createElement("input");s.type="file",s.addEventListener("change",t=>{const s=t.target.files;e(s)}),s.click()}),t=[...(await function(e){if(e)return new Promise((t,s)=>{const i=new FileReader;i.addEventListener("load",()=>{t(i.result)}),i.readAsText(e)})}(e[0])).split(/\r?\n|\r|\n/g)].map(e=>e.split(",")),s=t.length,i=t.at(0).length,o=this.houseModel;for(;o.blocks.length>0;)o.remove(o.blocks.at(0));const r=-i/2,n=-s/2;for(let e=0;e<i;e++)for(let i=0;i<s;i++){const s=t.at(i).at(e);if(""==s)continue;const a=ie.fromCode(s,r+e,n+i);null!=a&&(o.add(a)||console.log("skipped:",a,o))}}});class Se extends ue{#rt=new P(!0);#nt=[];onEnabled(){this.#rt.Subscribe(()=>this.onHouseBlocksChanged())}onBuildInspector(e){const t=ge.Checkbox2("Show external walls",this.#rt),s=e.getSharedSection("View");s.BodyWidgets=[...s.BodyWidgets,t]}static#at(){const e=[-1,-2,!1],t=[0,-2,!1],s=[1,-2,!1],i=[-1,-1,!1],o=[0,-1,!1],r=[1,-1,!1],n=[-1,0,!1],a=[1,0,!1],l=[-1,1,!1],h=[0,1,!1],u=[1,1,!1],c=[0,-1,!0],d=[-1,0,!0],g=[1,0,!0],f=[0,1,!0],x=[{fbx:"wall-house-tex",pos:{x:-50,z:-450},dir:J(90),rules:[t]},{fbx:"wall-house-tex",pos:{x:50,z:-450},dir:J(90),rules:[t]},{fbx:"wall-house-tex",pos:{x:150,z:-450},dir:J(90),rules:[t,s,[1,-1,!0]]},{fbx:"corner-1",pos:{x:155,z:-455},dir:J(90),rules:[t,s,r]},{fbx:"wall-house-tex",pos:{x:150,z:-350},dir:J(0),rules:[r]},{fbx:"wall-house-tex",pos:{x:150,z:-250},dir:J(0),rules:[r]},{fbx:"wall-house-tex",pos:{x:150,z:-150},dir:J(0),rules:[r,a]},{fbx:"wall-house-tex",pos:{x:150,z:-50},dir:J(0),rules:[a]},{fbx:"wall-house-tex",pos:{x:150,z:50},dir:J(0),rules:[a]},{fbx:"wall-house-tex",pos:{x:150,z:150},dir:J(0),rules:[a,u,f]},{fbx:"corner-1",pos:{x:155,z:155},dir:J(0),rules:[a,u,h]},{fbx:"wall-house-tex",pos:{x:50,z:150},dir:J(270),rules:[h]},{fbx:"wall-house-tex",pos:{x:-50,z:150},dir:J(270),rules:[h]},{fbx:"wall-house-tex",pos:{x:-150,z:150},dir:J(270),rules:[h,l,d]},{fbx:"corner-1",pos:{x:-155,z:155},dir:J(270),rules:[h,l,n]},{fbx:"wall-house-tex",pos:{x:-150,z:50},dir:J(180),rules:[n]},{fbx:"wall-house-tex",pos:{x:-150,z:-50},dir:J(180),rules:[n]},{fbx:"wall-house-tex",pos:{x:-150,z:-150},dir:J(180),rules:[i,n]},{fbx:"wall-house-tex",pos:{x:-150,z:-250},dir:J(180),rules:[i]},{fbx:"wall-house-tex",pos:{x:-150,z:-350},dir:J(180),rules:[i]},{fbx:"wall-house-tex",pos:{x:-150,z:-450},dir:J(180),rules:[i,e,[0,-2,!0]]},{fbx:"corner-1",pos:{x:-155,z:-455},dir:J(180),rules:[i,e,t]},{fbx:"roof-6m-full",pos:{x:150,z:-450},dir:J(270),rules:[h,a]},{fbx:"roof-6m-full",pos:{x:50,z:-450},dir:J(270),rules:[h]},{fbx:"roof-6m-full",pos:{x:-50,z:-450},dir:J(270),rules:[h]},{fbx:"roof-6m-full",pos:{x:-150,z:-450},dir:J(270),rules:[h,l]},{fbx:"roof-6m-cuted",pos:{x:-150,z:-450},dir:J(270),rules:[f]},{fbx:"roof-6m-cuted",pos:{x:-50,z:-450},dir:J(270),rules:[f]},{fbx:"roof-6m-cuted",pos:{x:50,z:-450},dir:J(270),rules:[f]},{fbx:"roof-6m-cuted",pos:{x:150,z:-450},dir:J(270),rules:[f]}],p=[{fbx:"wall-house-tex",pos:{x:-50,z:-150},dir:J(90),rules:[o]},{fbx:"wall-house-tex",pos:{x:50,z:-150},dir:J(90),rules:[o]},{fbx:"wall-house-tex",pos:{x:150,z:-150},dir:J(90),rules:[o,r,g]},{fbx:"corner-1",pos:{x:155,z:-155},dir:J(90),rules:[o,r,a]},{fbx:"wall-house-tex",pos:{x:150,z:-50},dir:J(0),rules:[a]},{fbx:"wall-house-tex",pos:{x:150,z:50},dir:J(0),rules:[a]},{fbx:"wall-house-tex",pos:{x:150,z:150},dir:J(0),rules:[a,u,f]},{fbx:"corner-1",pos:{x:155,z:155},dir:J(0),rules:[a,u,h]},{fbx:"wall-house-tex",pos:{x:50,z:150},dir:J(270),rules:[h]},{fbx:"wall-house-tex",pos:{x:-50,z:150},dir:J(270),rules:[h]},{fbx:"wall-house-tex",pos:{x:-150,z:150},dir:J(270),rules:[h,l,d]},{fbx:"corner-1",pos:{x:-155,z:155},dir:J(270),rules:[h,l,n]},{fbx:"wall-house-tex",pos:{x:-150,z:50},dir:J(180),rules:[n]},{fbx:"wall-house-tex",pos:{x:-150,z:-50},dir:J(180),rules:[n]},{fbx:"wall-house-tex",pos:{x:-150,z:-150},dir:J(180),rules:[n,i,c]},{fbx:"corner-1",pos:{x:-155,z:-155},dir:J(180),rules:[n,i,o]},{fbx:"roof-3m-high-full",pos:{x:150,z:-150},dir:J(270),rules:[h,a]},{fbx:"roof-3m-high-full",pos:{x:50,z:-150},dir:J(270),rules:[h]},{fbx:"roof-3m-high-full",pos:{x:-50,z:-150},dir:J(270),rules:[h]},{fbx:"roof-3m-high-full",pos:{x:-150,z:-150},dir:J(270),rules:[h,l]},{fbx:"roof-3m-high-cuted",pos:{x:-150,z:-150},dir:J(270),rules:[f]},{fbx:"roof-3m-high-cuted",pos:{x:-50,z:-150},dir:J(270),rules:[f]},{fbx:"roof-3m-high-cuted",pos:{x:50,z:-150},dir:J(270),rules:[f]},{fbx:"roof-3m-high-cuted",pos:{x:150,z:-150},dir:J(270),rules:[f]}],w=[{fbx:"wall-house-tex",pos:{x:-50,z:-150},dir:J(90),rules:[o]},{fbx:"wall-house-tex",pos:{x:50,z:-150},dir:J(90),rules:[o]},{fbx:"wall-house-tex",pos:{x:150,z:-150},dir:J(90),rules:[o,r,g]},{fbx:"corner-1",pos:{x:155,z:-155},dir:J(90),rules:[o,r,a]},{fbx:"wall-house-tex",pos:{x:150,z:-50},dir:J(0),rules:[a]},{fbx:"wall-house-tex",pos:{x:150,z:50},dir:J(0),rules:[a]},{fbx:"wall-house-tex",pos:{x:150,z:150},dir:J(0),rules:[a,u,f]},{fbx:"corner-1",pos:{x:155,z:155},dir:J(0),rules:[a,u,h]},{fbx:"wall-house-tex",pos:{x:50,z:150},dir:J(270),rules:[h]},{fbx:"wall-house-tex",pos:{x:-50,z:150},dir:J(270),rules:[h]},{fbx:"wall-house-tex",pos:{x:-150,z:150},dir:J(270),rules:[h,l,d]},{fbx:"corner-1",pos:{x:-155,z:155},dir:J(270),rules:[h,l,n]},{fbx:"wall-house-tex",pos:{x:-150,z:50},dir:J(180),rules:[n]},{fbx:"wall-house-tex",pos:{x:-150,z:-50},dir:J(180),rules:[n]},{fbx:"wall-house-tex",pos:{x:-150,z:-150},dir:J(180),rules:[n,i,c]},{fbx:"corner-1",pos:{x:-155,z:-155},dir:J(180),rules:[n,i,o]},{fbx:"roof-3m-low-full",pos:{x:150,z:-150},dir:J(270),rules:[h,a]},{fbx:"roof-3m-low-full",pos:{x:50,z:-150},dir:J(270),rules:[h]},{fbx:"roof-3m-low-full",pos:{x:-50,z:-150},dir:J(270),rules:[h]},{fbx:"roof-3m-low-full",pos:{x:-150,z:-150},dir:J(270),rules:[h,l]},{fbx:"roof-3m-low-cuted",pos:{x:-150,z:-150},dir:J(270),rules:[f]},{fbx:"roof-3m-low-cuted",pos:{x:-50,z:-150},dir:J(270),rules:[f]},{fbx:"roof-3m-low-cuted",pos:{x:50,z:-150},dir:J(270),rules:[f]},{fbx:"roof-3m-low-cuted",pos:{x:150,z:-150},dir:J(270),rules:[f]}];return new Map([["house_6x3",x],["house_3x3_hi",p],["house_3x3_lo",w]])}static#lt=this.#at();onHouseBlocksChanged(){for(const e of this.#nt)this.scene.remove(e);if(this.#nt.length=0,this.#rt.Value)for(const e of this.houseModel.blocks){if(!(e instanceof ie))continue;const t=Se.#lt.get(e.name);if(!t)continue;const s=e.getOrigin(),i=J(e.direction);for(const{fbx:o,pos:r,dir:a,rules:l}of t){if(!this.#ht(e,l))continue;const t=this.resourceManager.getObject(o);t.position.set(r.x,0,r.z),t.position.applyEuler(new n(0,i,0)),t.position.add(s),t.rotation.set(0,a+i,0),this.#nt.push(t),this.scene.add(t)}}}#ht(e,t){const s=this.houseModel,{order:i}=se.getEntity("block_shift",e.name),{x:o,z:r,direction:n}=e;for(let[e,a,l]of t){[e,a]=Y(e,a,n);const t=s.find(o+e,r+a);let h=!1;if(null!=t){const{order:e}=se.getEntity("block_shift",t.name);h=i==e}if(l!=h)return!1}return!0}}ue.registerPlugin(Se),ue.registerPlugin(class extends ue{#ut=[new y,new y,new y,new y,new y,new y,new y,new y];async onRender(){var e=this.viewManager;const s=e.dirLight.shadow.camera,i=new t;if(this.scene.traverse(e=>{if(e.isMesh&&e.castShadow){const t=e.matrixWorld;e.geometry.computeBoundingBox();const o=e.geometry.boundingBox.min,r=e.geometry.boundingBox.max;this.#ut[0].set(o.x,o.y,o.z),this.#ut[1].set(r.x,o.y,o.z),this.#ut[2].set(o.x,r.y,o.z),this.#ut[3].set(o.x,o.y,r.z),this.#ut[4].set(r.x,r.y,o.z),this.#ut[5].set(r.x,o.y,r.z),this.#ut[6].set(o.x,r.y,r.z),this.#ut[7].set(r.x,r.y,r.z);for(const e of this.#ut)e.applyMatrix4(t),e.project(s),i.expandByPoint(e)}}),!i.isEmpty()){const t=(s.right-s.left)/2,o=(s.top-s.bottom)/2,r=(s.far-s.near)/2;s.left=s.left+t*(i.min.x+1),s.right=s.right+t*(i.max.x-1),s.top=s.top+o*(i.max.y-1),s.bottom=s.bottom+o*(i.min.y+1),s.far=s.far+r*(i.max.z-1)+1e3,s.near=s.near+r*(i.min.z+1),s.updateProjectionMatrix(),e.dirLightCameraHelper&&e.dirLightCameraHelper.update()}}}),ue.registerPlugin(class extends ue{onBuildInspector(e){e.addNewSection("Rules",ge.Checkbox("Allow if not defined",oe.validatePlacementDefaults,()=>(oe.validatePlacementDefaults=!oe.validatePlacementDefaults,oe.validatePlacementDefaults)),ge.Button("Copy rules",()=>this.#ct()))}getInspectorOrder(){return 210}#ct(){const e=this.houseModel.printUndefinedRules();e.length?navigator.clipboard.writeText("new rules:\n"+e):navigator.clipboard.writeText("no new rules found")}}),ue.registerPlugin(class extends ue{onBuildInspector(e){const t=ge.Text("metalness: ?");t.TextAlignment=[0,0];const s=ge.Text("roughness: ?");s.TextAlignment=[0,0];const i=()=>{const e=this.resourceManager.materials.values().next().value;e&&(t.Text="metalness: "+e.metalness.toFixed(2),s.Text="roughness: "+e.roughness.toFixed(2))},o=(e,t)=>{const s=this.resourceManager.materials.values().next().value;s&&(s.metalness=Math.max(0,Math.min(1,s.metalness+e)),s.roughness=Math.max(0,Math.min(1,s.roughness+t)),i())},r=ge.Button("-",()=>o(-.05,0));r.Constraints.With("width",32);const n=ge.Button("+",()=>o(.05,0));n.Constraints.With("width",32);const a=ge.Button("-",()=>o(0,-.05));a.Constraints.With("width",32);const l=ge.Button("+",()=>o(0,.05));l.Constraints.With("width",32);const h=new U;h.Constraints.With("height",32),h.Widgets=[r,t,n];const u=new U;u.Constraints.With("height",32),u.Widgets=[a,s,l],e.addNewSection("Material",h,u)}getInspectorOrder(){return 210}}),function(e){e||(e=document.querySelector("#container"));const t=new ne,s=new ce(t);s.loadPlugins();const i=new de(s);new F(e).Show(i),(new ae).init(i.view3dHost.PlatformView,s);var o=document.createElement("img");o.style.position="absolute",o.style.right="0px",o.style.top="0px",o.style.width="100px",o.style.height="100px",o.style.opacity=.7,o.src="./assets/cuby-logo.jpg",i.imageHost.PlatformView.appendChild(o)}();