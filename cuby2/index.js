import{AmbientLight as e,BoxGeometry as t,Color as s,DirectionalLight as i,Euler as o,GridHelper as n,Group as r,MOUSE as a,Mesh as l,MeshBasicMaterial as h,MeshPhongMaterial as c,PerspectiveCamera as u,PlaneGeometry as d,Raycaster as g,RepeatWrapping as f,Scene as w,TextureLoader as b,Vector2 as m,Vector3 as p,WebGLRenderer as C}from"./threejs/three.module.js";import{FBXLoader as V}from"./three/addons/loaders/FBXLoader.js";import{OrbitControls as S}from"./three/addons/controls/OrbitControls.js";import{default as x}from"./three/addons/libs/stats.module.js";class v{#e;constructor(e){this.#e=e}Dispose(){this.#e()}}class y{#t=[];constructor(){}Add(e){this.#t.push(e)}Clear(){const e=[...this.#t];this.#t.length=0;for(const t in e)t.Dispose()}}class k{#s=[];constructor(){}subscribe(e){this.Subscribe(e)}subscribeAndNotify(e){this.SubscribeAndNotify(e)}notify(...e){this.Notify(...e)}Subscribe(e){const t=(...t)=>e(...t),s={unsubscribe:()=>{this.#s=this.#s.filter(e=>e.wrapper!==t)}};return this.#s.push(t),s}SubscribeAndNotify(e){const t=this.Subscribe(e);return e(),t}Notify(...e){this.#s.forEach(t=>t(...e))}}class _{#i;#o=[];constructor(e){this.#i=e}get Value(){return this.#i}set Value(e){this.#i=e,this.#n()}Subscribe(e,t=null){const s=this.#o;s.push(e),t&&t.Add(new v(function(){_.#r(s,e)})),e(this.#i)}#n(){for(const e of this.#o)e(this.#i)}static#r(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}}class T{PlatformViewValue=new _(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}ContentValue=new _(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}SizeValue=new _([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}constructor(){this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(!e)return;const t=this.Size;e.Size=t,e.Position=[0,0]}}class M{#a=new Map;Add(e,t){return this.#a.set(e,t),this}With(e,t){return this.#a.set(e,t),this}Has(e){return this.#a.has(e)}GetOrDefault(e,t){return this.#a.has(e)?this.#a.get(e):t}Get(e){return this.#a.get(e)}TryGet(e){return[this.#a.has(e),this.#a.get(e)]}}class P{OnEvent(e){}}class D{PlatformViewValue=new _(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}PositionValue=new _([0,0]);get Position(){return this.PositionValue.Value}set Position(e){this.PositionValue.Value=e}SizeValue=new _([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}VisibleValue=new _(!0);get Visible(){return this.VisibleValue.Value}set Visible(e){this.VisibleValue.Value=e}ConstraintsValue=new _(new M);get Constraints(){return this.ConstraintsValue.Value}set Constraints(e){this.ConstraintsValue.Value=e}ThemeValue=new _(null);get Theme(){return this.ThemeValue.Value}set Theme(e){this.ThemeValue.Value=e}}class W extends D{WidgetsValue=new _(null);get Widgets(){return this.WidgetsValue.Value}set Widgets(e){this.WidgetsValue.Value=e}GesturesValue=new _(null);get Gestures(){return this.GesturesValue.Value}set Gestures(e){this.GesturesValue.Value=e}}class z extends D{static ScrollBarSize=10;ContentValue=new _(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(e){const[t,s]=e.Size,i=this.Size[0]-z.ScrollBarSize;e.Size=[i,s]}}}class A extends D{TextValue=new _("");get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new _("black");get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}TextAlignmentValue=new _([0,0]);get TextAlignment(){return this.TextAlignmentValue.Value}set TextAlignment(e){this.TextAlignmentValue.Value=e}FontSizeValue=new _(16);get FontSize(){return this.FontSizeValue.Value}set FontSize(e){this.FontSizeValue.Value=e}get TextSize(){return this.FontSizeValue.Value}set TextSize(e){this.FontSizeValue.Value=e}}class R extends D{DrawFuncValue=new _(null);get DrawFunc(){return this.DrawFuncValue.Value}set DrawFunc(e){this.DrawFuncValue.Value=e}InvalidateVisual(){this.DrawFuncValue.Value=this.DrawFuncValue.Value}}class H{#l;constructor(e){this.#l=e}#h(e){if(Array.isArray(e)){if(3==e.length)return"#"+e[0].toString(16).padStart(2,"0")+e[1].toString(16).padStart(2,"0")+e[2].toString(16).padStart(2,"0");console.log("#ParseColor | this array not supported yet")}return e}DrawLine(e,t,s,i,o,n){const r=this.#l;r instanceof CanvasRenderingContext2D&&(r.lineWidth=o,r.strokeStyle=this.#h(n),r.beginPath(),r.moveTo(e,t),r.lineTo(s,i),r.stroke())}DrawPath(e,t,s,i,o){const n=this.#l;if(!(n instanceof CanvasRenderingContext2D))return;const r=new Path2D;let a=0;const l=o.length,h=function(){const e=o[a];return a+=1,e};for(;a<l;)switch(h()){case"m":case"move":{const e=h(),t=h();r.moveTo(e,t);break}case"l":case"line":{const e=h(),t=h();r.lineTo(e,t);break}case"a":case"arc":{const e=h(),t=h(),s=h(),i=h(),o=h();r.arcTo(e,t,s,i,o);break}}e&&(n.fillStyle=this.#h(e),n.fill(r)),i&&(t&&r.closePath(),n.lineWidth=s,n.strokeStyle=this.#h(i),n.stroke(r))}}class E{static CreateElement({tagName:e=null,widget:t=null,debugColor:s=null}={}){null==e&&(e="div");const i=document.createElement(e);return i._disposables=new y,i}static SetChildren(e,t){for(;e.fisrtChild;){const t=e.lastChild;t._disposables.Clear(),e.removeChild(t)}for(const s of t)s&&e.appendChild(s)}static GetView(e){if(null==e)return null;if(e instanceof T){const t=E.CreateElement({widget:e,debugColor:"#00000010"});return t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",e.ContentValue.Subscribe(function(){E.SetChildren(t,[E.GetView(e.Content)])},t._disposables),new ResizeObserver(function(){e.Size=[t.offsetWidth,t.offsetHeight]}).observe(t),e.PlatformView=t,t}if(e instanceof z){const t=E.CreateElement({widget:e,debugColor:"#00000015"});return t.style.position="absolute",t.style["overflow-x"]="hidden",t.style["overflow-y"]="scroll",t.style["scrollbar-width"]="thin",t.style["scrollbar-color"]="#00000010 #ffffff10",this.#c(t,e),e.ContentValue.Subscribe(function(){E.SetChildren(t,[E.GetView(e.Content)])},t._disposables),e.PlatformView=t,t}if(e instanceof W){const t=E.CreateElement({widget:e,debugColor:"#ff000005"});return t.style.position="absolute",t.style.overflow="hidden",this.#c(t,e),e.WidgetsValue.Subscribe(function(){const s=e.Widgets?[...e.Widgets.map(function(e){return E.GetView(e)})]:[];E.SetChildren(t,s)},t._disposables),e.GesturesValue.Subscribe(function(){E.#u(t,e)},t._disposables),e.PlatformView=t,t}if(e instanceof A){const t=E.CreateElement({widget:e,debugColor:"#00ff0005"});return t.style.position="absolute",t.style.display="flex",t.style["font-family"]="sans-serif",this.#c(t,e),e.TextValue.Subscribe(function(){t.innerText=e.Text},t._disposables),e.FontSizeValue.Subscribe(function(){t.style["font-size"]=`${e.FontSize}px`},t._disposables),e.TextColorValue.Subscribe(function(){t.style.color=e.TextColor},t._disposables),e.TextAlignmentValue.Subscribe(function(){const[s,i]=e.TextAlignment;switch(s){case-1:case"start":case"left":t.style["justify-content"]="left",t.style["text-align"]="left";break;case 0:case"center":t.style["justify-content"]="center",t.style["text-align"]="center";break;case 1:case"end":case"right":t.style["justify-content"]="right",t.style["text-align"]="right"}switch(i){case-1:case"start":case"top":t.style["align-items"]="flex-start";break;case 0:case"center":t.style["align-items"]="center";break;case 1:case"end":case"bottom":t.style["align-items"]="flex-end"}},t._disposables),e.PlatformView=t,t}if(e instanceof R){const t=E.CreateElement({tagName:"canvas",widget:e});return t.style.position="absolute",this.#c(t,e),e.SizeValue.Subscribe(function(){t.width=""+2*e.Size[0],t.height=""+2*e.Size[1],E.#d(t,e)},t._disposables),e.DrawFuncValue.Subscribe(function(){E.#d(t,e)},t._disposables),e.PlatformView=t,t}return E.CreateElement({widget:e})}static#u(e,t){if(!(e instanceof Element))return void console.log("#SubscribeToEvents() | widget is not instance of Element");const s=t.Gestures;if(s&&s.length>0){const i=function(e){for(const i of s)i.OnEvent(e,t)},o=function(t){e.setPointerCapture(t.pointerId),i(t)},n=function(t){e.releasePointerCapture(t.pointerId),i(t)};e.onpointerdown=o,e.onpointerup=n,e.onpointercancel=i,e.onpointermove=i,e.onpointerenter=i,e.onpointerleave=i,e.onpointerout=i,e.onpointerover=i}else e.onpointerdown=null,e.onpointerup=null,e.onpointercancel=null,e.onpointermove=null,e.onpointerenter=null,e.onpointerleave=null,e.onpointerout=null,e.onpointerover=null}static#d(e,t){if(e.getContext){const s=e.getContext("2d");s.setTransform(1,0,0,1,0,0),s.scale(2,2),s.clearRect(0,0,e.width,e.height);const i=new H(s),o=t.DrawFunc;o&&o(i,t.Size[0],t.Size[1])}}static#c(e,t){t.SizeValue.Subscribe(function(){const s=t.Size;e.style.width=`${s[0]}px`,e.style.height=`${s[1]}px`},e._disposables),t.PositionValue.Subscribe(function(){const s=t.Position;e.style.left=`${s[0]}px`,e.style.top=`${s[1]}px`},e._disposables)}}class O{#g;constructor(e){this.#g=e}Show(e){const t=this.#g;for(;t.fisrtChild;)t.removeChild(t.lastChild);t.appendChild(E.GetView(e))}}class F extends R{RadiusValue=new _(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new _(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new _(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new _(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}constructor(){super(),this.DrawFunc=this.#f.bind(this);const e=this.InvalidateVisual.bind(this);this.RadiusValue.Subscribe(e),this.FillColorValue.Subscribe(e),this.StrokeColorValue.Subscribe(e),this.StrokeThicknessValue.Subscribe(e)}#f(e,t,s){const i=this.StrokeColor?this.StrokeThickness/2:0,o=this.Radius,n=i,r=t/2,a=t-i,l=i,h=s/2,c=s-i;e.DrawPath(this.FillColor,!0,this.StrokeThickness,this.StrokeColor,["m",i,s/2,"arc",n,l,r,l,o,"arc",a,l,a,h,o,"arc",a,c,r,c,o,"arc",n,c,n,h,o])}}class B extends P{#w=!1;#b;#m;#p;#C;constructor(e,{AnimateUp:t,AnimateDown:s,AnimateHover:i}){super(),this.#b=e,this.#p=s,this.#m=t,this.#C=i}OnEvent(e,t){if(e instanceof PointerEvent){if("pointerleave"==e.type&&this.#m&&this.#m(),"pointermove"==e.type){const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i?this.#w?this.#p&&this.#p():this.#C&&this.#C():this.#m&&this.#m()}if("pointerdown"==e.type)return this.#w=!0,void(this.#p&&this.#p());if(!1!==this.#w&&"pointerup"==e.type){this.#w=!1,this.#m&&this.#m();const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i&&this.#b()}}}}class G extends W{constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;const[t,s]=this.Size;if(!(t<1||s<1))for(const i of e){const e=i.Constraints,[o,n]=G.CalculateSize(t,e,"width","left","right"),[r,a]=G.CalculateSize(s,e,"height","top","bottom");i.Position=[o,r],i.Size=[n,a]}}static CalculateSize(e,t,s,i,o){const n=t.TryGet(s),r=t.TryGet(i),a=t.TryGet(o);let l=0,h=0;if(n[0])h=n[1],l=r[0]?r[1]:a[0]?e-a[1]-n[1]:(e-n[1])/2;else{const t=r[0]?r[1]:0;l=t,h=e-t-(a[0]?a[1]:0)}return[l,h]}}class N extends W{SpacingValue=new _(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;let t=0,s=N.CalculatePixelsPerPercent(e,this.Spacing,this.Size[0]-0,"width","width_proportional","left","right");for(const i of e)t+=this.#V(i,t,s),t+=this.Spacing}#V(e,t,s){var i=e.Constraints;const[o,n]=N.CalculateSize(i,"width","width_proportional","left",s);var[r,a]=G.CalculateSize(this.Size[1]-0,i,"height","top","bottom");return e.Position=[t+o,r],e.Size=[n,a],o+n+i.GetOrDefault("right",0)}static CalculateSize(e,t,s,i,o){let[n,r]=e.TryGet(t);return n||(r=e.GetOrDefault(s,1)*o),[e.GetOrDefault(i,0),r]}static CalculatePixelsPerPercent(e,t,s,i,o,n,r){let a=0,l=e.length>1?(e.length-1)*t:0;for(const t of e){const e=t.Constraints;l+=e.GetOrDefault(n,0)+e.GetOrDefault(r,0),e.Has(i)?l+=e.Get(i):a+=e.GetOrDefault(o,1)}var h=s-l;return h>0?h/a:0}}class j extends W{static#S=[0,0,0,0];SpacingValue=new _(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}PaddingValue=new _(j.#S);get Padding(){return this.PaddingValue.Value}set Padding(e){this.PaddingValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e)return;const t=e.length,[s,i,o,n]=this.Padding;let r=i;const a=this.Size[0];for(let i=0;i<t;i++){i>0&&(r+=this.Spacing);const t=e[i],n=t.Constraints,l=n.Has("height")?n.Get("height"):t.Size[1],h=n.Has("left")?n.Get("left"):0,c=n.Has("right")?n.Get("right"):0;t.Position=[h+s,r],t.Size=[a-h-c-s-o,l],r+=t.Size[1]}r+=n;const[l,h]=this.Size;h!=r&&(this.Size=[l,r])}}class L extends G{#x=new F;#v=new A;#y=new F;RadiusValue=new _(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new _(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new _(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new _(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}TextValue=new _(null);get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new _(null);get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}get TextAlignment(){return this.#v.TextAlignment}set TextAlignment(e){this.#v.TextAlignment=e}ClickAction=null;Command=new k;constructor(){super();const e=this;this.Widgets=[this.#x,this.#v,this.#y],this.Gestures=[new B(function(){e.OnClick()},{AnimateDown:function(){e.#y.FillColor="#00000010"},AnimateUp:function(){e.#y.FillColor="#00000000"},AnimateHover:function(){e.#y.FillColor="#ffffff10"}})],this.RadiusValue.Subscribe(function(){e.#x.Radius=e.Radius,e.#y.Radius=e.Radius}),this.FillColorValue.Subscribe(function(){e.#x.FillColor=e.FillColor}),this.StrokeColorValue.Subscribe(function(){e.#x.StrokeColor=e.StrokeColor}),this.StrokeThicknessValue.Subscribe(function(){e.#x.StrokeThickness=e.StrokeThickness}),this.TextValue.Subscribe(function(){e.#v.Text=e.Text}),this.TextColorValue.Subscribe(function(){e.#v.TextColor=e.TextColor})}OnClick(){this.ClickAction&&this.ClickAction(),this.Command.Notify()}}class X{static#k;static{const e=X.#k=new Map;e.set("block|house_6x3",{id:"house_6x3",width:1,height:2,fbxName:"a/home_6x3"}),e.set("block|house_3x3_hi",{id:"house_3x3_hi",width:1,height:1,fbxName:"a/home_3x3_hi"}),e.set("block|house_3x3_lo",{id:"house_3x3_lo",width:1,height:1,fbxName:"a/home_3x3_lo"}),e.set("block|garage_6x3",{id:"garage_6x3",width:1,height:2,fbxName:"a/garage_6x3"}),e.set("block|veranda_3x3_hi",{id:"veranda_3x3_hi",width:1,height:1,fbxName:"a/veranda_3x3_hi"}),e.set("block|veranda_3x3_lo",{id:"veranda_3x3_lo",width:1,height:1,fbxName:"a/veranda_3x3_lo"}),e.set("block_shift|house_6x3",{canShift:!1,order:0}),e.set("block_shift|house_3x3_hi",{canShift:!1,order:0}),e.set("block_shift|house_3x3_lo",{canShift:!1,order:0}),e.set("block_shift|garage_6x3",{canShift:!0,order:1}),e.set("block_shift|veranda_3x3_hi",{canShift:!0,order:2}),e.set("block_shift|veranda_3x3_lo",{canShift:!0,order:2}),e.set("key|1",{id:"house_6x3",title:"1.House\n6x3"}),e.set("key|2",{id:"house_3x3_hi",title:"2.House\n3x3 Hi"}),e.set("key|3",{id:"house_3x3_lo",title:"3.House\n3x3 Lo"}),e.set("key|4",{id:"garage_6x3",title:"4.Gararage\n6x3"}),e.set("key|5",{id:"veranda_3x3_hi",title:"5.Veranda\n3x3 Hi"}),e.set("key|6",{id:"veranda_3x3_lo",title:"6.Veranda\n3x3 Lo"});const t={allowed:!0};e.set("rules|hor|202|202",t),e.set("rules|hor|203|203",t),e.set("rules|hor|204|204",t),e.set("rules|hor|205|205",t),e.set("rules|hor|207|206",t),e.set("rules|hor|208|209",t),e.set("rules|hor|209|302",t),e.set("rules|hor|209|303",t),e.set("rules|hor|209|304",t),e.set("rules|hor|209|305",t),e.set("rules|hor|302|207",t),e.set("rules|hor|302|302",t),e.set("rules|hor|302|522",t),e.set("rules|hor|302|523",t),e.set("rules|hor|302|526",t),e.set("rules|hor|302|527",t),e.set("rules|hor|303|207",t),e.set("rules|hor|303|303",t),e.set("rules|hor|303|526",t),e.set("rules|hor|303|527",t),e.set("rules|hor|304|204",t),e.set("rules|hor|304|207",t),e.set("rules|hor|304|304",t),e.set("rules|hor|304|524",t),e.set("rules|hor|304|525",t),e.set("rules|hor|304|526",t),e.set("rules|hor|304|527",t),e.set("rules|hor|305|205",t),e.set("rules|hor|305|207",t),e.set("rules|hor|305|305",t),e.set("rules|hor|305|525",t),e.set("rules|hor|305|526",t),e.set("rules|hor|305|527",t),e.set("rules|hor|522|302",t),e.set("rules|hor|522|522",t),e.set("rules|hor|523|302",t),e.set("rules|hor|523|523",t),e.set("rules|hor|524|304",t),e.set("rules|hor|524|524",t),e.set("rules|hor|525|304",t),e.set("rules|hor|525|525",t),e.set("rules|hor|528|302",t),e.set("rules|hor|528|303",t),e.set("rules|hor|528|304",t),e.set("rules|hor|528|305",t),e.set("rules|hor|529|302",t),e.set("rules|hor|529|303",t),e.set("rules|hor|529|304",t),e.set("rules|hor|529|305",t),e.set("rules|ver|203|202",t),e.set("rules|ver|204|205",t),e.set("rules|ver|205|304",t),e.set("rules|ver|206|206",t),e.set("rules|ver|207|207",t),e.set("rules|ver|208|208",t),e.set("rules|ver|209|209",t),e.set("rules|ver|302|203",t),e.set("rules|ver|302|522",t),e.set("rules|ver|302|523",t),e.set("rules|ver|303|302",t),e.set("rules|ver|303|522",t),e.set("rules|ver|303|523",t),e.set("rules|ver|303|526",t),e.set("rules|ver|303|527",t),e.set("rules|ver|303|528",t),e.set("rules|ver|303|529",t),e.set("rules|ver|304|305",t),e.set("rules|ver|305|303",t),e.set("rules|ver|305|526",t),e.set("rules|ver|523|522",t),e.set("rules|ver|524|303",t),e.set("rules|ver|524|304",t),e.set("rules|ver|524|305",t),e.set("rules|ver|524|525",t),e.set("rules|ver|525|303",t),e.set("rules|ver|525|304",t),e.set("rules|ver|525|305",t),e.set("rules|ver|526|303",t),e.set("rules|ver|526|305",t),e.set("rules|ver|526|526",t),e.set("rules|ver|527|305",t),e.set("rules|ver|527|526",t),e.set("rules|ver|527|527",t),e.set("rules|ver|528|305",t),e.set("rules|ver|528|528",t),e.set("rules|ver|529|305",t),e.set("rules|ver|529|528",t),e.set("rules|ver|529|529",t),e.set("rules|hor|202|523",t),e.set("rules|hor|203|303",t),e.set("rules|hor|204|525",t),e.set("rules|hor|205|305",t),e.set("rules|hor|303|203",t),e.set("rules|hor|303|523",t),e.set("rules|hor|523|202",t),e.set("rules|hor|523|303",t),e.set("rules|hor|525|204",t),e.set("rules|hor|525|305",t),e.set("rules|ver|205|303",t),e.set("rules|ver|205|305",t),e.set("rules|ver|303|203",t),e.set("rules|ver|305|203",t),e.set("rules|ver|305|523",t)}static findEntity(...e){if(0==e.length)return null;const t=e.join("|");return X.#k.get(t)||null}static getEntity(...e){if(0==e.length)return null;const t=e.join("|");return X.#k.get(t)||(console.log("CMS | entity not found | ",e),null)}static getEntities(...e){const t=e.join("|")+"|",s=[];for(const[e,i]of X.#k)e.startsWith(t)&&s.push(i);return s}}function $(e){return Math.PI*e/180}const U=300;function Y(e){return{x:Math.floor(e.x/U),y:-1-Math.floor(e.z/U)}}function I(e,t,s){const[i,o]=K(e,t);s.set(i,0,o)}function K(e,t){return[e*U+150,-150-t*U]}class Z{#_;#s=[];constructor(e){this.#_=e}get Value(){return this.#_}set Value(e){this.#_=e,this.#n()}Subscribe(e,t=null){const s=this.SubscribeToChanges(listener,t);return e(this.#_),s}SubscribeToChanges(e,t=null){const s=(...t)=>e(...t);this.#s.push(s);const i=new DisposableAction(function(){var e,t,i;e=this.#s,t=s,(i=e.indexOf(t))>-1&&e.splice(i,1)});return t&&t.Add(i),i}#n(){for(const e of this.#s)e(this.#_)}}class J{#T;constructor(e){this.#T=e}ToArray(){return this.#T}ToList(){return this.#T}OrderBy(e){return new J(J.OrderBy(this.#T,e))}Select(e){return new J(J.Select(this.#T,e))}static Select(e,t){return e.map(t)}static OrderBy(e,t){const s=[...e];return s.sort(function(e,s){const i=t(e),o=t(s);return i<o?-1:i>o?1:0}),s}static RemoveAt(e,t){e.splice(t,1)}static Remove(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}static ToArray(e){return[...e]}}function q(e,t){let s=function(e){return e.endsWith(".csv")?"text/csv":e.endsWith(".json")?"application/json":e.endsWith(".txt")?"text/plain":"application/json"}(t);const i=new Blob([e],{type:s}),o=URL.createObjectURL(i),n=document.createElement("a");n.href=o,n.download=t,n.click(),URL.revokeObjectURL(o)}class Q{#M;#P;#D;#W;#z;#A;#R;#H;#E;#O;constructor(e,t,s,i,o,n){switch(this.#P=t,this.#D=s,this.#W=i,this.#z=o,this.#M=e,this.#A=n,n){case 0:this.#R=t,this.#H=s,this.#E=i,this.#O=o;break;case 180:this.#R=t-i+1,this.#H=s-o+1,this.#E=i,this.#O=o;break;case 90:this.#R=t,this.#H=s-i+1,this.#E=o,this.#O=i;break;case 270:this.#R=t-o+1,this.#H=s,this.#E=o,this.#O=i;break;default:throw`unexpected direction: '${n}'`}Object.freeze(this)}get name(){return this.#M}get x(){return this.#P}get y(){return this.#D}get width(){return this.#W}get height(){return this.#z}get direction(){return this.#A}get realX(){return this.#R}get realY(){return this.#H}get realWidth(){return this.#E}get realHeight(){return this.#O}#F=new Z([0,0]);get worldPosition(){return this.#F}isIntersected(e){return!(!(e instanceof Q)||this.#R+this.#E-1<e.#R||e.#R+e.#E-1<this.#R||this.#H+this.#O-1<e.#H||e.#H+e.#O-1<this.#H)}forEachCell(e){for(let t=0;t<this.#E;t++)for(let s=0;s<this.#O;s++)e(this,this.#R+t,this.#H+s)}forEachCell_xz(e){for(let t=0;t<this.#E;t++)for(let s=0;s<this.#O;s++)e(this,this.#R+t,-(this.#H+s))}getOriginXZ(){return K(this.x,this.y)}getCode_xz(e,t){const s=-t;return this.getCode(e,s)}getCode(e,t){let s=[0,0,0,0];switch(this.name){case"house_6x3":s=this.x==e&&this.y==t?[303,0,305,0]:[302,0,304,0];break;case"house_3x3_hi":s=[303,0,305,0];break;case"house_3x3_lo":s=[302,0,304,0];break;case"garage_6x3":s=this.x==e&&this.y==t?[203,207,205,209]:[202,206,204,208];break;case"veranda_3x3_hi":s=[523,527,525,529];break;case"veranda_3x3_lo":s=[522,526,524,528]}switch(this.#A){case 0:return s[0];case 90:return s[1];case 180:return s[2];case 270:return s[3];default:throw`unexpected direction: '${direction}'`}return 0}}class ee{#B=[];constructor(){}get blocks(){return this.#B}blocksChanged=new k;canAdd(e){if(e instanceof Q){for(const t of this.#B)if(t.isIntersected(e))return!1;return ee.#G([e,...this.#B])}return!1}add(e){return!!this.canAdd(e)&&(this.#B.push(e),this.blocksChanged.Notify(),!0)}remove(e){const t=this.#B.indexOf(e);if(-1!==t)return this.#B.splice(t,1),this.blocksChanged.Notify(),!0}printUndefinedRules(){ee.#N.clear(),ee.#G(this.#B);const e=[...ee.#N].join("\n");return console.log(e),e}static#G(e){const t=[];for(const s of e)s instanceof Q&&s.forEachCell(function(e,s,i){t.push([e,s,i])});const s=new Map;let i=!0;const o=ee.validatePlacementDefaults;for(const[e,n,r]of t){const t=e.getCode(n,r);s.has(`${n-1}:${r}`)&&(ee.#j(s.get(`${n-1}:${r}`),t,"hor",o)||(i=!1)),s.has(`${n+1}:${r}`)&&(ee.#j(t,s.get(`${n+1}:${r}`),"hor",o)||(i=!1)),s.has(`${n}:${r-1}`)&&(ee.#j(s.get(`${n}:${r-1}`),t,"ver",o)||(i=!1)),s.has(`${n}:${r+1}`)&&(ee.#j(t,s.get(`${n}:${r+1}`),"ver",o)||(i=!1)),s.set(`${n}:${r}`,t)}return i}static validatePlacementDefaults=!1;static#N=new Set;static#j(e,t,s,i){if(e&&t){const i=X.findEntity("rules",s,e,t);if(i)return i.allowed;const o=`${s}|${e}|${t}`;ee.#N.add(o)}return i}}class te{static Text(e){const t=new A;return t.Text=e,t.TextAlignment=[-1,0],t.Constraints.With("height",32),t}static Button(e,t){const s=new L;return s.Radius=6,s.StrokeColor="#ccc",s.StrokeThickness=1,s.Text=e,s.Constraints.With("height",32),s.Command.Subscribe(()=>t(s)),s}static Checkbox(e,t,s){const i="☑ "+e,o="☐ "+e,n=new L;return n.Text=t?i:o,n.TextAlignment=[-1,0],n.Constraints.With("height",32),n.Command.Subscribe(()=>{const e=s();!0===e&&(n.Text=i),!1===e&&(n.Text=o)}),n}}class se extends T{#L;view3dHost;imageHost;constructor(e){super(),this.#L=e;const t=this.#L.houseViewModel,s=[];for(let e=1;e<=6;e+=1){const{id:i,title:o}=X.getEntity(`key|${e}`),n="◉ "+o.replace("\n"," "),r="⭘ "+o.replace("\n"," "),a=this.#X(r,function(){t.setBlockName(i)});t.activeToolChanged.SubscribeAndNotify(function(){a.Text=t.activeBlockName==i?n:r}),a.TextAlignment=[-1,0],a.Constraints.With("height",32),s.push(a)}const i=new W,o=new W;o.Constraints.With("top",0),o.Constraints.With("right",0),o.Constraints.With("width",100),o.Constraints.With("height",100);const n=new G;n.Widgets=[i,o];const r=new A;r.Text="⏷ Step 1. Place modules",r.Constraints.With("height",64),r.TextAlignment=[-1,0],r.FontSize=20;const a=new A;a.Constraints.With("height",32),a.Text="Rotate",a.TextAlignment=[-1,0];const l=this.#$("↶ Left",function(){t.rotateLeft()}),h=this.#$("↷ Right",function(){t.rotateRight()}),c=new N;c.Spacing=4,c.Constraints.With("height",32),c.Widgets=[l,h];const u=new A;u.Text="⏷ Rules",u.Constraints.With("height",64),u.TextAlignment=[-1,0],u.FontSize=20;const d=te.Checkbox("Allow if not defined",ee.validatePlacementDefaults,()=>(ee.validatePlacementDefaults=!ee.validatePlacementDefaults,ee.validatePlacementDefaults)),g=this.#$("Copy undefined rules",this.#U.bind(this));g.Constraints.With("height",32);const f=new A;f.Text="⏷ Step 2. Save to JSON",f.Constraints.With("height",64),f.TextAlignment=[-1,0],f.FontSize=20;const w=new A;w.Text="⏵ Step 3. - - -",w.Constraints.With("height",64),w.TextAlignment=[-1,0],w.FontSize=20;const b=[];e.forEachPlugin(e=>{const t=e.getWidget();t&&b.push(t)});const m=new J(b).OrderBy(e=>e.at(1)).Select(e=>e.at(0)).ToList(),p=new j;p.Padding=[8,8,8,8],p.Spacing=4,p.Widgets=[r,...s,a,c,u,d,g,w,...m];const C=new z;C.Constraints.With("width",300),C.Content=p;const V=new F;V.Constraints.With("width",5),V.FillColor="#ccc";const S=new N;S.Widgets=[n,V,C],this.view3dHost=i,this.imageHost=o,this.Content=S}#Y(){}#U(){const e=this.#L.houseViewModel.houseModel.printUndefinedRules();e.length?navigator.clipboard.writeText("new rules:\n"+e):navigator.clipboard.writeText("no new rules found")}#X(e,t){const s=new L;return s.Text=e,s.Command.Subscribe(t),s}#$(e,t){const s=new L;return s.Radius=6,s.StrokeColor="#ccc",s.StrokeThickness=1,s.Text=e,s.Command.Subscribe(t),s}}class ie{#I=new ee;activeBlockName=X.getEntity("key|1").id;activeDirection=0;activeToolChanged=new k;get houseModel(){return this.#I}get blocksChanged(){return this.#I.blocksChanged}blockToSceneObjMapping=new Map;constructor(){}setDirection(e){this.activeDirection=e,this.#K(),this.#Z()}rotateLeft(){switch(this.activeDirection){case 0:this.activeDirection=270;break;case 90:this.activeDirection=0;break;case 180:this.activeDirection=90;break;case 270:this.activeDirection=180}this.#K(-1),this.#Z()}rotateRight(){switch(this.activeDirection){case 0:this.activeDirection=90;break;case 90:this.activeDirection=180;break;case 180:this.activeDirection=270;break;case 270:this.activeDirection=0}this.#K(),this.#Z()}#K(e){if(this.activeBlockName.startsWith("house_"))if(-1===e)switch(this.activeDirection){case 90:this.activeDirection=0;break;case 270:this.activeDirection=180}else switch(this.activeDirection){case 90:this.activeDirection=180;break;case 270:this.activeDirection=0}}setBlockName(e){this.activeBlockName=e,this.#K(),this.#Z()}#Z(){this.activeToolChanged.notify()}canPlaceAtCoords(e){const{width:t,height:s}=X.getEntity("block",this.activeBlockName),i=new Q(this.activeBlockName,e.x,e.y,t,s,this.activeDirection);return this.#I.canAdd(i)}placeAtCoords(e){const{width:t,height:s}=X.getEntity("block",this.activeBlockName),i=new Q(this.activeBlockName,e.x,e.y,t,s,this.activeDirection);this.#I.add(i)}removeAtCoords(e){const t=new Q(null,e.x,e.y,1,1,0),s=[];for(const e of this.#I.blocks)e.isIntersected(t)&&s.push(e);for(const e of s)this.#I.remove(e)}}class oe{static registeredPluginClasses=[];#J;get viewManager(){return this.#J}get scene(){return this.#J.scene}get houseViewModel(){return this.#J.rootViewModel.houseViewModel}get houseModel(){return this.#J.rootViewModel.houseViewModel.houseModel}get resourceManager(){return this.#J.rootViewModel.resourceManager}onSceneCreated(e){this.#J=e,this.onSceneCreated2(e),this.houseModel.blocksChanged.subscribeAndNotify(()=>this.onHouseBlocksChanged())}onSceneCreated2(){}onHouseBlocksChanged(){}onRender(e){}onPointerMove(e,t){}onPointerDown(e,t){}onDocumentKeyDown(e){}onDocumentKeyUp(e){}getWidget(){return null}getInspectorOrder(){return 0}buildInspector(e){}static registerPlugin(e){oe.registeredPluginClasses.push(e)}}class ne{#q=[];get plugins(){return this.#q}resourceManager;#Q=new ie;get houseViewModel(){return this.#Q}houseModel=new ee;constructor(e){this.resourceManager=e}loadPlugins(){for(const e of oe.registeredPluginClasses)this.#q.push(new e)}forEachPlugin(e){for(const t of this.#q)e(t)}}class re{#L;get rootViewModel(){return this.#L}get canvas(){return this.renderer.domElement}get container(){return this.renderer.domElement.parentNode}camera;scene;renderer;#ee=new g;#te=new m;forEachPlugin(e){this.#L.forEachPlugin(e)}init(t,o){this.#L=o;const n=new u(45,320/240,1,1e4);this.camera=n,this.camera.position.set(1700,800,1600),this.camera.lookAt(0,0,0);const r=new w;this.scene=r,this.scene.background=new s(15790320),this.renderer=new C({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setAnimationLoop(this.render.bind(this)),t.appendChild(this.renderer.domElement);const a=new e(6316128,3);r.add(a);const l=new i(16777215,3);l.position.set(1,.75,.5).normalize(),r.add(l),this.forEachPlugin(e=>e.onSceneCreated(this)),t.addEventListener("pointermove",this.#se.bind(this)),t.addEventListener("pointerdown",this.#ie.bind(this)),document.addEventListener("keydown",this.#oe.bind(this)),document.addEventListener("keyup",this.#ne.bind(this)),new ResizeObserver(this.#re.bind(this)).observe(t),this.#re(),o.resourceManager.requestRender.subscribe(()=>this.render())}#se(e){this.#ae(e),this.forEachPlugin(t=>t.onPointerMove(e,this.#ee))}#ie(e){this.#ae(e),this.forEachPlugin(t=>t.onPointerDown(e,this.#ee))}#oe(e){this.forEachPlugin(t=>t.onDocumentKeyDown(e))}#ne(e){this.forEachPlugin(t=>t.onDocumentKeyUp(e))}#ae(e){const t=e.layerX,s=e.layerY,i=e.target.offsetWidth,o=e.target.offsetHeight;return this.#te.set(t/i*2-1,1-s/o*2),this.#ee.setFromCamera(this.#te,this.camera),!0}#re(){const e=this.container,t=e.offsetWidth,s=e.offsetHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s),this.render()}render(){this.forEachPlugin(e=>e.onRender(this)),this.renderer.render(this.scene,this.camera)}}class ae{#le;#he;#ce;requestRender=new k;constructor(){this.#le=new V,this.#he=new Map,this.#ce=new Map}getObject(e){if("column"==e)return this.#ue();if("grass"==e)return this.#de();const t=new r,s=this.#he;if(s.has(e))t.add(s.get(e).clone());else{const i=this.#ce;if(i.has(e))i.get(e).push(t);else{const o=[];o.push(t),i.set(e,o),this.#le.load("assets/models/"+e+".fbx",t=>{t.scale.set(.1,.1,.1),e.startsWith("a/")&&(t.rotation.set(0,$(0),0),t.position.set(-150,0,150)),s.set(e,t),o.forEach(e=>{e.add(t.clone())}),o.length&&this.requestRender.Notify(),o.length=0})}}return t}#ge;#fe;#ue(){return this.#ge||(this.#ge=new t(10,600,10),this.#ge.translate(0,300,0)),this.#fe||(this.#fe=new h({color:0})),new l(this.#ge,this.#fe)}#we;#be;#de(){if(this.#we||(this.#we=new t(300,10,300),this.#we.translate(0,-6,0)),!this.#be){const e=(new b).load("assets/textures/Grass_001_SD/Grass_001_COLOR.jpg");e.wrapS=f,e.wrapT=f,e.repeat.set(.1,.1);const t=(new b).load("assets/textures/Grass_001_SD/Grass_001_NORM.jpg");t.wrapS=f,t.wrapT=f,t.repeat.set(.1,.1),this.#be=new c({map:e}),this.#be.normalMap=t,this.#be.normalScale.set(1,1)}return new l(this.#we,this.#be)}}oe.registerPlugin(class extends oe{#me;#pe;#Ce;#Ve;constructor(){super(),this.#me=new n(6e3,20,11206570,11206570)}onSceneCreated2(e){e.scene.add(this.#me);for(let e=-10;e<10;e++)for(let t=-10;t<10;t++){const s=this.resourceManager.getObject("grass");this.scene.add(s),I(e,t,s.position)}}}),oe.registerPlugin(class extends oe{constructor(){super()}onSceneCreated2(e){const t=new S(e.camera,e.renderer.domElement);t.minDistance=500,t.maxDistance=5e3,t.minPolarAngle=$(0),t.maxPolarAngle=$(90),t.target.set(0,175,0),t.mouseButtons={RIGHT:a.ROTATE,MIDDLE:a.PAN},t.update()}});class le{#Se;#pe;#xe=!1;#ve=null;get visible(){return this.#xe}constructor(){const e=new t(320,100,320);e.translate(0,50,0);const s=new h({color:10305403,transparent:!0,opacity:.5});this.#pe=new l(e,s),this.#ve=this.#pe}setScene(e){this.#Se=e,this.#xe&&this.#Se.add(this.#ve)}setDirection(e){this.#ve.rotation.set(0,$(-e),0)}setModel(e){if(this.#ve==e)return;const t=this.#ve;this.#xe&&this.#Se.remove(this.#ve),this.#ve=e||this.#pe,this.#xe&&this.#Se.add(this.#ve),this.#ve.position.copy(t.position),this.#ve.rotation.copy(t.rotation)}showAt(e){this.#xe||(this.#xe=!0,this.#Se&&this.#Se.add(this.#ve)),function(e,t){const s=Y(e);I(s.x,s.y,t)}(e,this.#ve.position)}hide(){this.#xe&&(this.#xe=!1,this.#Se&&this.#Se.remove(this.#ve))}getCoords(){return Y(this.#ve.position)}}function he(e,t,s,i){t.add(e),s.push(e);const o=function(e,t){const s=[];for(const i of t)e!==i&&ce(e,i)&&s.push(i);return s}(e,i);for(const n of o)t.has(n)||n.name!==e.name||he(n,t,s,i)}function ce(e,t){const s=(e.x+e.width===t.x||t.x+t.width===e.x)&&e.y<t.y+t.height&&e.y+e.height>t.y,i=(e.y+e.height===t.y||t.y+t.height===e.y)&&e.x<t.x+t.width&&e.x+e.width>t.x;return s||i}function ue(e,t){const s=[];return e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x+e.width===t.x&&s.push("right"),t.x+t.width===e.x&&s.push("left")),e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y+e.height===t.y&&s.push("down"),t.y+t.height===e.y&&s.push("up")),s}function de(e,t){const s=new Set;for(const i of e)for(const e of t){const t=ue(i,e);for(const e of t)s.add(e)}return[...s]}function ge(e,t){const s=new Set;for(const i of t){const t=de(e,i);for(const e of t)s.add(e)}return[...s]}oe.registerPlugin(class extends oe{#ye;#ke=new le;#_e;#Te;constructor(){super();const e=new d(6e3,6e3);e.rotateX(-Math.PI/2),this.#ye=new l(e,new h({visible:!1}))}onSceneCreated(e){super.onSceneCreated(e),this.#_e=new Map;for(const{id:e,fbxName:t}of X.getEntities("block"))this.#_e.set(e,this.resourceManager.getObject(t));this.houseViewModel.activeToolChanged.subscribeAndNotify(this.#Me.bind(this)),this.#ke.setScene(e.scene)}#Me(){this.#ke.setDirection(this.houseViewModel.activeDirection),this.#Te=this.#_e.get(this.houseViewModel.activeBlockName),this.houseViewModel.canPlaceAtCoords(this.#ke.getCoords())?this.#ke.setModel(this.#Te):this.#ke.setModel(null)}onPointerMove(e,t){const s=t.intersectObject(this.#ye,!0);if(0===s.length)return void this.#ke.hide();const i=s[0];this.#ke.showAt(i.point),this.houseViewModel.canPlaceAtCoords(this.#ke.getCoords())?this.#ke.setModel(this.#Te):this.#ke.setModel(null)}onPointerDown(e,t){1===e.buttons&&this.#ke.visible&&(this.houseViewModel.canPlaceAtCoords(this.#ke.getCoords())?this.houseViewModel.placeAtCoords(this.#ke.getCoords()):this.houseViewModel.removeAtCoords(this.#ke.getCoords()),this.#ke.setModel(null))}}),oe.registerPlugin(class extends oe{#Pe;constructor(){super(),this.#Pe=new x}onSceneCreated(e){document.body.appendChild(this.#Pe.dom)}onRender(e){this.#Pe.update()}}),oe.registerPlugin(class extends oe{onDocumentKeyDown(e){switch(e.key){case"ArrowLeft":this.houseViewModel.rotateLeft();break;case"ArrowRight":this.houseViewModel.rotateRight();break;case"1":case"2":case"3":case"4":case"5":case"6":const{id:t}=X.getEntity(`key|${e.key}`);this.houseViewModel.activeBlockName==t?this.houseViewModel.rotateRight():this.houseViewModel.setBlockName(t)}}}),oe.registerPlugin(class extends oe{constructor(){super()}onSceneCreated(e){super.onSceneCreated(e),this.houseModel.blocksChanged.subscribeAndNotify(this.#De.bind(this))}#We(e){const t=this.houseViewModel.blockToSceneObjMapping;if(t.has(e))return t.get(e);const{fbxName:s}=X.getEntity("block",e.name),i=this.resourceManager.getObject(s);return i.rotation.set(0,$(-e.direction),0),t.set(e,i),this.scene.add(i),i}#De(){const e=this.houseViewModel.blockToSceneObjMapping;for(const e of this.houseModel.blocks)this.#We(e);this.#ze();const t=[];for(const s of e.keys())this.houseModel.blocks.includes(s)||t.push(s);for(const s of t){const t=e.get(s);e.delete(s),this.scene.remove(t)}}#ze(){const e=this.houseModel.blocks.map(e=>{const{order:t}=X.getEntity("block_shift",e.name);return{block:e,x:e.realX,y:e.realY,width:e.realWidth,height:e.realHeight,name:`${t}`,order:t}}),t=function(e){const t=new Set,s=[];for(const i of e)if(!t.has(i)){const o=[];he(i,t,o,e),s.push(o)}return s}(J.OrderBy(e,e=>e.order));for(let e=0;e<t.length;e++){const s=t.slice(0,e),i=t[e],o=ge(i,s);let n=0,r=0;for(const e of o)switch(e){case"left":n+=42.5;break;case"right":n-=42.5;break;case"up":r+=42.5;break;case"down":r-=42.5}for(const{block:e}of i){const t=this.#We(e);I(e.x,e.y,t.position),t.position.set(t.position.x+n,t.position.y,t.position.z-r)}}}}),oe.registerPlugin(class extends oe{#Ae;#Re=[];#He=!1;constructor(){super();const e=te.Checkbox("Show House Columns",this.#He,()=>(this.#He=!this.#He,this.onHouseBlocksChanged(),this.#He));this.#Ae=e}getWidget(){return[this.#Ae,100]}onHouseBlocksChanged(){const e=new Set(this.#Re);if(this.#He)for(const t of this.houseModel.blocks)for(const[s,i]of this.#Ee(t)){const t=this.#Oe(s,i);if(t){e.delete(t);continue}const o=this.resourceManager.getObject("column");this.scene.add(o),this.#Re.push(o),o.position.set(s,0,i)}for(const t of e)J.Remove(this.#Re,t),this.scene.remove(t)}#Oe(e,t){for(const s of this.#Re){const i=s.position.x,o=s.position.z;if(!(e+1<i||e-1>i||t+1<o||t-1>o))return s}return null}#Fe(e,t){const[s,i]=K(e,t),[o,n]=K(e-1,t-1);return[(o+s)/2,(n+i)/2]}#Ee(e){const t=this.houseViewModel.blockToSceneObjMapping.get(e),[s,i]=K(e.x,e.y),o=t.position.x-s,n=t.position.z-i,r=[this.#Fe(e.realX,e.realY),this.#Fe(e.realX+e.realWidth,e.realY),this.#Fe(e.realX,e.realY+e.realHeight),this.#Fe(e.realX+e.realWidth,e.realY+e.realHeight)],a=[];for(const[e,t]of r)a.push([e+o,t+n]);return a}});class fe extends j{static#Be="⏷";static#Ge="⏵";#Ne;#je;HeaderTitleValue=new _;get HeaderTitle(){return this.HeaderTitleValue.Value}set HeaderTitle(e){this.HeaderTitleValue.Value=e}get BodyWidgets(){return this.#je.Widgets}set BodyWidgets(e){this.#je.Widgets=e}constructor(){super();const e=new L;e.Command.Subscribe(()=>{this.#Le()});const t=new A;t.TextAlignment=[-1,0],t.FontSize=20;const s=new F;s.Constraints.With("height",1).With("bottom",0),s.FillColor="#ccc";const i=this.#Ne=new G;i.Constraints.With("height",48),i.Widgets=[t,s,e];const o=this.#je=new j;o.Padding=[8,4,0,16],o.Spacing=4,this.Widgets=[i,o],this.HeaderTitleValue.Subscribe(()=>{t.Text=fe.#Be+" "+this.HeaderTitle})}#Le(){}}class we{static findBlocks(e){return e instanceof ee?e.blocks:e instanceof ie?we.findBlocks(e.houseModel):e instanceof ne?we.findBlocks(e.houseViewModel):null}static toJsonString(e){const t=we.findBlocks(e);if(0==t.size)return;let s=1e7,i=1e7;for(const e of t)e instanceof Q&&e.forEachCell(function(e,t,o){s=Math.min(s,t),i=Math.min(i,o)});const o=[];for(const e of t)e instanceof Q&&e.forEachCell((e,t,n)=>{o.push({code:e.getCode(t,n),x:t-s,z:n-i})});return JSON.stringify(o,null,2)}}oe.registerPlugin(class extends oe{#Ae;constructor(){super();const e=te.Button("Download",()=>{q(we.toJsonString(this.houseViewModel),"house.json")}),t=te.Button("Download",()=>{q(this.#Xe(),"house.csv")}),s=te.Button("Copy",()=>{const e=this.#Xe();navigator.clipboard.writeText(e)}),i=this.#Ae=new fe;i.HeaderTitle="JSON / CSV",i.BodyWidgets=[te.Text("JSON"),e,te.Text("CSV"),s,t]}getWidget(){return[this.#Ae,200]}#Xe(){const e=this.houseModel.blocks;if(0==e.size)return;let t=1e7,s=1e7,i=-1,o=-1;for(const n of e)n instanceof Q&&n.forEachCell_xz((e,n,r)=>{t=Math.min(t,n),s=Math.min(s,r),i=Math.max(i,n),o=Math.max(o,r)});const n=i-t+1,r=o-s+1,a=Array.from({length:r},()=>Array(n).fill(""));for(const i of e)i instanceof Q&&i.forEachCell_xz((e,i,o)=>{a[o-s][i-t]=e.getCode_xz(i,o)});return a.map(e=>e.join(",")).join("\n")}});class be extends oe{#Ae;#$e=!0;#Ue=[];constructor(){super();const e=te.Checkbox("Show external walls",this.#$e,()=>(this.#$e=!this.#$e,this.onHouseBlocksChanged(),this.#$e)),t=this.#Ae=new fe;t.HeaderTitle="Walls",t.BodyWidgets=[e]}getWidget(){return[this.#Ae,100]}onSceneCreated2(){}static#Ye=[[0,155,$(270)],[100,155,$(270)],[-100,155,$(270)],[0,-155,$(90)],[100,-155,$(90)],[-100,-155,$(90)],[155,0,$(0)],[155,100,$(0)],[155,-100,$(0)],[-155,0,$(180)],[-155,100,$(180)],[-155,-100,$(180)]];static#Ie=[[0,155,$(270)],[100,155,$(270)],[-100,155,$(270)],[0,-455,$(90)],[100,-455,$(90)],[-100,-455,$(90)],[155,0,$(0)],[155,100,$(0)],[155,-100,$(0)],[155,-200,$(0)],[155,-300,$(0)],[155,-400,$(0)],[-155,0,$(180)],[-155,100,$(180)],[-155,-100,$(180)],[-155,-200,$(180)],[-155,-300,$(180)],[-155,-400,$(180)]];static#Ke=new Map([["house_6x3",be.#Ie],["house_3x3_hi",be.#Ye],["house_3x3_lo",be.#Ye]]);onHouseBlocksChanged(){for(const e of this.#Ue)this.scene.remove(e);if(this.#Ue.length=0,this.#$e)for(const e of this.houseModel.blocks){if(!(e instanceof Q))continue;const t=be.#Ke.get(e.name);if(!t)continue;const[s,i]=e.getOriginXZ();for(const[n,r,a]of t){const t=this.resourceManager.getObject("wall-fix");t.position.set(n,0,r),t.position.applyEuler(new o(0,$(e.direction),0)),t.position.add(new p(s,0,i)),t.rotation.set(0,a+$(e.direction),0),this.#Ue.push(t),this.scene.add(t)}}}}oe.registerPlugin(be),function(e){e||(e=document.querySelector("#container"));const t=new ae,s=new ne(t);s.loadPlugins();const i=new se(s);new O(e).Show(i),(new re).init(i.view3dHost.PlatformView,s);var o=document.createElement("img");o.style.position="absolute",o.style.right="0px",o.style.top="0px",o.style.width="100px",o.style.height="100px",o.style.opacity=.7,o.src="./assets/cuby-logo.jpg",i.imageHost.PlatformView.appendChild(o)}();