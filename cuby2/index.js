import{AmbientLight as e,Box3 as t,BoxGeometry as s,Color as i,CubeTextureLoader as o,DirectionalLight as r,Euler as n,GridHelper as a,Group as l,MOUSE as h,Mesh as c,MeshBasicMaterial as u,MeshPhongMaterial as d,MeshStandardMaterial as g,PCFSoftShadowMap as f,PerspectiveCamera as p,PlaneGeometry as x,Raycaster as b,RepeatWrapping as w,Scene as m,TextureLoader as L,Vector2 as V,Vector3 as C,WebGLRenderer as S}from"./threejs/three.module.js";import{FBXLoader as y}from"./threejs/addons/loaders/FBXLoader.js";import{OrbitControls as v}from"./threejs/addons/controls/OrbitControls.js";import{default as A}from"./threejs/addons/libs/stats.module.js";class M{#e;constructor(e){this.#e=e}Dispose(){this.#e()}}class z{#t=[];constructor(){}Add(e){this.#t.push(e)}Clear(){const e=[...this.#t];this.#t.length=0;for(const t of e)t.Dispose()}}class P{#s=[];constructor(){}subscribe(e){this.Subscribe(e)}subscribeAndNotify(e){return this.SubscribeAndNotify(e)}notify(...e){this.Notify(...e)}Subscribe(e){const t=(...t)=>e(...t),s={unsubscribe:()=>{this.#s=this.#s.filter(e=>e.wrapper!==t)}};return this.#s.push(t),s}SubscribeAndNotify(e){const t=this.Subscribe(e);return e(),t}Notify(...e){this.#s.forEach(t=>t(...e))}}class k{#i;#o=[];constructor(e){this.#i=e}get Value(){return this.#i}set Value(e){this.#i=e,this.#r()}Subscribe(e,t=null){const s=this.#o;s.push(e),t&&t.Add(new M(()=>{k.#n(s,e)})),e(this.#i)}#r(){for(const e of this.#o)e(this.#i)}static#n(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}}class _{PlatformViewValue=new k(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}ContentValue=new k(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}SizeValue=new k([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}constructor(){this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(!e)return;const t=this.Size;e.Size=t,e.Position=[0,0]}}class W{#a=new Map;Add(e,t){return this.#a.set(e,t),this}With(e,t){return this.#a.set(e,t),this}Has(e){return this.#a.has(e)}GetOrDefault(e,t){return this.#a.has(e)?this.#a.get(e):t}Get(e){return this.#a.get(e)}TryGet(e){return[this.#a.has(e),this.#a.get(e)]}}class T{OnEvent(e,t){}}class H{PlatformViewValue=new k(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}PositionValue=new k([0,0]);get Position(){return this.PositionValue.Value}set Position(e){this.PositionValue.Value=e}SizeValue=new k([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}VisibleValue=new k(!0);get Visible(){return this.VisibleValue.Value}set Visible(e){this.VisibleValue.Value=e}ConstraintsValue=new k(new W);get Constraints(){return this.ConstraintsValue.Value}set Constraints(e){this.ConstraintsValue.Value=e}ThemeValue=new k(null);get Theme(){return this.ThemeValue.Value}set Theme(e){this.ThemeValue.Value=e}}class N extends H{WidgetsValue=new k(null);get Widgets(){return this.WidgetsValue.Value}set Widgets(e){this.WidgetsValue.Value=e}GesturesValue=new k(null);get Gestures(){return this.GesturesValue.Value}set Gestures(e){this.GesturesValue.Value=e}}class E extends H{static ScrollBarSize=10;ContentValue=new k(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(e){const[,t]=e.Size,s=this.Size[0]-E.ScrollBarSize;e.Size=[s,t]}}}class D extends H{TextValue=new k("");get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new k("black");get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}TextAlignmentValue=new k([0,0]);get TextAlignment(){return this.TextAlignmentValue.Value}set TextAlignment(e){this.TextAlignmentValue.Value=e}FontSizeValue=new k(16);get FontSize(){return this.FontSizeValue.Value}set FontSize(e){this.FontSizeValue.Value=e}get TextSize(){return this.FontSizeValue.Value}set TextSize(e){this.FontSizeValue.Value=e}}class R extends H{DrawFuncValue=new k(null);get DrawFunc(){return this.DrawFuncValue.Value}set DrawFunc(e){this.DrawFuncValue.Value=e}InvalidateVisual(){this.DrawFuncValue.Value=this.DrawFunc}}class O{#l;constructor(e){this.#l=e}#h(e){if(Array.isArray(e)){if(3==e.length)return"#"+e[0].toString(16).padStart(2,"0")+e[1].toString(16).padStart(2,"0")+e[2].toString(16).padStart(2,"0");console.log("#ParseColor | this array not supported yet")}return e}DrawLine(e,t,s,i,o,r){const n=this.#l;n instanceof CanvasRenderingContext2D&&(n.lineWidth=o,n.strokeStyle=this.#h(r),n.beginPath(),n.moveTo(e,t),n.lineTo(s,i),n.stroke())}DrawPath(e,t,s,i,o){const r=this.#l;if(!(r instanceof CanvasRenderingContext2D))return;const n=new Path2D;let a=0;const l=o.length,h=function(){const e=o[a];return a+=1,e};for(;a<l;)switch(h()){case"m":case"move":{const e=h(),t=h();n.moveTo(e,t);break}case"l":case"line":{const e=h(),t=h();n.lineTo(e,t);break}case"a":case"arc":{const e=h(),t=h(),s=h(),i=h(),o=h();n.arcTo(e,t,s,i,o);break}}e&&(r.fillStyle=this.#h(e),r.fill(n)),i&&(t&&n.closePath(),r.lineWidth=s,r.strokeStyle=this.#h(i),r.stroke(n))}}class B{static CreateElement({tagName:e=null,widget:t=null,debugColor:s=null}={}){null==e&&(e="div");const i=document.createElement(e);return i._disposables=new z,i}static SetChildren(e,t){for(;e.fisrtChild;){const t=e.lastChild;t._disposables.Clear(),e.removeChild(t)}for(const s of t)s&&e.appendChild(s)}static GetView(e){if(null==e)return null;if(e instanceof _){const t=B.CreateElement({widget:e,debugColor:"#00000010"});return t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",e.ContentValue.Subscribe(function(){B.SetChildren(t,[B.GetView(e.Content)])},t._disposables),new ResizeObserver(function(){e.Size=[t.offsetWidth,t.offsetHeight]}).observe(t),e.PlatformView=t,t}if(e instanceof E){const t=B.CreateElement({widget:e,debugColor:"#00000015"});return t.style.position="absolute",t.style["overflow-x"]="hidden",t.style["overflow-y"]="scroll",t.style["scrollbar-width"]="thin",t.style["scrollbar-color"]="#00000010 #ffffff10",this.#c(t,e),e.ContentValue.Subscribe(function(){B.SetChildren(t,[B.GetView(e.Content)])},t._disposables),e.PlatformView=t,t}if(e instanceof N){const t=B.CreateElement({widget:e,debugColor:"#ff000005"});return t.style.position="absolute",t.style.overflow="hidden",this.#c(t,e),e.WidgetsValue.Subscribe(function(){const s=e.Widgets?[...e.Widgets.map(function(e){return B.GetView(e)})]:[];B.SetChildren(t,s)},t._disposables),e.GesturesValue.Subscribe(function(){B.#u(t,e)},t._disposables),e.PlatformView=t,t}if(e instanceof D){const t=B.CreateElement({widget:e,debugColor:"#00ff0005"});return t.style.position="absolute",t.style.display="flex",t.style["font-family"]="sans-serif",t.style.overflow="hidden",t.style["white-space"]="nowrap",this.#c(t,e),e.TextValue.Subscribe(function(){t.innerText=e.Text},t._disposables),e.FontSizeValue.Subscribe(function(){t.style["font-size"]=`${e.FontSize}px`},t._disposables),e.TextColorValue.Subscribe(function(){t.style.color=e.TextColor},t._disposables),e.TextAlignmentValue.Subscribe(function(){const[s,i]=e.TextAlignment;switch(s){case-1:case"start":case"left":t.style["justify-content"]="left",t.style["text-align"]="left";break;case 0:case"center":t.style["justify-content"]="center",t.style["text-align"]="center";break;case 1:case"end":case"right":t.style["justify-content"]="right",t.style["text-align"]="right"}switch(i){case-1:case"start":case"top":t.style["align-items"]="flex-start";break;case 0:case"center":t.style["align-items"]="center";break;case 1:case"end":case"bottom":t.style["align-items"]="flex-end"}},t._disposables),e.PlatformView=t,t}if(e instanceof R){const t=B.CreateElement({tagName:"canvas",widget:e});return t.style.position="absolute",this.#c(t,e),e.SizeValue.Subscribe(function(){t.width=""+2*e.Size[0],t.height=""+2*e.Size[1],B.#d(t,e)},t._disposables),e.DrawFuncValue.Subscribe(function(){B.#d(t,e)},t._disposables),e.PlatformView=t,t}return B.CreateElement({widget:e})}static#u(e,t){if(!(e instanceof Element))return void console.log("#SubscribeToEvents() | widget is not instance of Element");const s=t.Gestures;if(s&&s.length>0){const i=function(e){for(const i of s)i.OnEvent(e,t)},o=function(t){e.setPointerCapture(t.pointerId),i(t)},r=function(t){e.releasePointerCapture(t.pointerId),i(t)};e.onpointerdown=o,e.onpointerup=r,e.onpointercancel=i,e.onpointermove=i,e.onpointerenter=i,e.onpointerleave=i,e.onpointerout=i,e.onpointerover=i}else e.onpointerdown=null,e.onpointerup=null,e.onpointercancel=null,e.onpointermove=null,e.onpointerenter=null,e.onpointerleave=null,e.onpointerout=null,e.onpointerover=null}static#d(e,t){if(e.getContext){const s=e.getContext("2d");s.setTransform(1,0,0,1,0,0),s.scale(2,2),s.clearRect(0,0,e.width,e.height);const i=new O(s),o=t.DrawFunc;o&&o(i,t.Size[0],t.Size[1])}}static#c(e,t){t.SizeValue.Subscribe(function(){const s=t.Size;e.style.width=`${s[0]}px`,e.style.height=`${s[1]}px`},e._disposables),t.PositionValue.Subscribe(function(){const s=t.Position;e.style.left=`${s[0]}px`,e.style.top=`${s[1]}px`},e._disposables)}}class I{#g;constructor(e){this.#g=e}Show(e){const t=this.#g;for(;t.fisrtChild;)t.removeChild(t.lastChild);t.appendChild(B.GetView(e))}}class j{static#f="?";static isDev(){return!0===j.#f||!1!==j.#f&&(j.#f=-1!==(document.location+"").indexOf("127.0.0.1"),console.log("debug.#isDebug:",j.#f),j.#f)}static log(...e){this.isDev()&&console.log(...e)}static assert(e,t){!0!==e&&this.log("assert:",e,t)}static throwUndefined(...e){if(this.isDev())for(let t=0;t<e.length;t++)if(void 0===e[t])throw this.log(...e),`undefined is not expected here [${t+1}/${e.length}]`}static throw(e){if(this.isDev())throw e}}function F(e){return Math.PI*e/180}function G(e,t,s){switch(s){case 0:return[e,t];case 90:return function(e,t){return[t,-e]}(e,t);case 180:return function(e,t){return[-e,-t]}(e,t);case 270:return function(e,t){return[-t,e]}(e,t)}j.throw(`unexpected rot(${e}, ${t}, ${s})`)}const U=300;class ${static fromVector(e){return{x:Math.round(e.x/U),z:Math.round(e.z/U)}}static toVector(e,t){return{x:e*U,y:0,z:t*U}}static roundVector(e){const{x:t,z:s}=this.fromVector(e);return this.toVector(t,s)}}class K{#p;#s=[];constructor(e){this.#p=e}get Value(){return this.#p}set Value(e){this.#p=e,this.#r()}Subscribe(e,t=null){const s=this.SubscribeToChanges(e,t);return e(this.#p),s}SubscribeToChanges(e,t=null){const s=(...t)=>e(...t);this.#s.push(s);const i=new M(function(){var e,t,i;e=this.#s,t=s,(i=e.indexOf(t))>-1&&e.splice(i,1)});return t&&t.Add(i),i}#r(){for(const e of this.#s)e(this.#p)}}class X{#x;constructor(e){this.#x=e}ToArray(){return this.#x}ToList(){return this.#x}OrderBy(e){return new X(X.OrderBy(this.#x,e))}Select(e){return new X(X.Select(this.#x,e))}static Select(e,t){return e.map(t)}static OrderBy(e,t){const s=[...e];return s.sort(function(e,s){const i=t(e),o=t(s);return i<o?-1:i>o?1:0}),s}static RemoveAt(e,t){e.splice(t,1)}static Remove(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}static ToArray(e){return[...e]}}function q(e,t){let s=function(e){return e.endsWith(".csv")?"text/csv":e.endsWith(".json")?"application/json":e.endsWith(".txt")?"text/plain":"application/json"}(t);const i=new Blob([e],{type:s}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download=t,r.click(),URL.revokeObjectURL(o)}class J{#b=new y;#w=new o;#m=new Map;#L;#V=new Map;#C=new Map;get materials(){return this.#V}constructor(){}getObject(e){if("column"==e)return this.#S();if("grass"==e)return this.#y();const t=new l;return this.#v(t,e),t}async#v(e,t){this.#m.has(t)||this.#m.set(t,this.#A(t));const s=await this.#m.get(t);e.add(s.clone())}async#A(e){const t=await this.#M(e);return t.scale.set(.1,.1,.1),e.startsWith("a/")?(t.rotation.set(0,F(0),0),t.position.set(-150,0,150),t):(await this.#z(t),t)}async#M(e){return e.startsWith("A13")||e.startsWith("Door")||e.startsWith("Window")||e.startsWith("Roof")?this.#b.loadAsync("assets/models/v5/"+e+".fbx"):await this.#b.loadAsync("assets/models/"+e+".fbx")}async#z(e){const t=[];e.traverse(e=>{e.isMesh&&t.push(e)});for(const e of t)e.material=await this.#P(e.material),e.castShadow=!0,e.receiveShadow=!0}#k(e){return e}async#P(e){const t=e.name;if(this.#V.has(t))return this.#V.get(t);if("M_STENI"!=t)return this.#V.set(t,e),this.#k(e);if(this.#C.has(t)){const e=await this.#C.get(t);return await e,this.#V.get(t)}let s=null;this.#C.set(t,new Promise(e=>s=e));const i=new g;return i.color.copy(e.color),i.map=e.map,i.name=e.name,i.normalMap=e.bumpMap,i.metalness=.3,i.roughness=.4,this.#k(i),i.envMap=await this.#_(),console.log("upgrade material:",e,"new material:",i),this.#V.set(t,i),s(),i}async#_(){return this.#L||(this.#L=(async()=>await this.#w.loadAsync(["assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png"]))()),await this.#L}#W;#T;#S(){return this.#W||(this.#W=new s(10,600,10),this.#W.translate(0,300,0)),this.#T||(this.#T=new u({color:0})),new c(this.#W,this.#T)}#H;#N;#y(){if(this.#H||(this.#H=new s(300,10,300),this.#H.translate(0,-6,0)),!this.#N){const e=(new L).load("assets/textures/grass_2/grass-3.jpg");e.wrapS=w,e.wrapT=w,e.repeat.set(.5,.5),this.#N=new d({map:e})}return new c(this.#H,this.#N)}}class Y{get canvas(){return this.renderer.domElement}get container(){return this.renderer.domElement.parentNode}camera;scene;renderer;#E;dirLight;dirLightCameraHelper;#D=new b;#R=new V;onRenderSignal=new P;#O=()=>{};constructor(t){const s=new p(45,320/240,1,1e4);this.camera=s,this.camera.position.set(1700,800,1600),this.camera.lookAt(0,0,0);const o=new m;this.scene=o,this.scene.background=new i(15790320);const n=new e(6316128,3);o.add(n);const a=new r(16777215,2);a.position.set(1e3,1750,500),a.castShadow=!0,a.shadow.bias=-1e-4,a.shadow.normalBias=.05,a.shadow.radius=2,a.shadow.mapSize.width=2048,a.shadow.mapSize.height=2048,a.shadow.camera.near=1,a.shadow.camera.far=1e4,a.shadow.camera.right=150,a.shadow.camera.left=-250,a.shadow.camera.top=150,a.shadow.camera.bottom=-1250,this.dirLight=a,o.add(a),this.dirLightCameraHelper&&o.add(this.dirLightCameraHelper),this.#E&&(this.#E.position.x=10,this.#E.position.y=10,this.#E.size.width=100,this.#E.size.height=100,this.#E.update()),this.renderer=new S({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=f,t.appendChild(this.renderer.domElement),t.addEventListener("pointermove",this.#B.bind(this)),t.addEventListener("pointerdown",this.#I.bind(this)),document.addEventListener("keydown",this.#j.bind(this)),document.addEventListener("keyup",this.#F.bind(this)),new ResizeObserver(()=>this.#G()).observe(t),this.#G(),this.renderer.setAnimationLoop(()=>this.render())}attach(e){j.assert(e instanceof fe),this.#O=t=>e.forEachPlugin(t)}#B(e){this.#U(e),this.#O(t=>t.onPointerMove(e,this.#D))}#I(e){this.#U(e),this.#O(t=>t.onPointerDown(e,this.#D))}#j(e){this.#O(t=>t.onDocumentKeyDown(e))}#F(e){this.#O(t=>t.onDocumentKeyUp(e))}#U(e){const t=e.layerX,s=e.layerY,i=e.target.offsetWidth,o=e.target.offsetHeight;return this.#R.set(t/i*2-1,1-s/o*2),this.#D.setFromCamera(this.#R,this.camera),!0}#G(){const e=this.container,t=e.offsetWidth,s=e.offsetHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s),this.#E&&(this.#E.position.x=10,this.#E.position.y=10,this.#E.size.width=100,this.#E.size.height=100,this.#E.update()),this.render()}render(){this.onRenderSignal.Notify(),this.#O(e=>e.onRender(this)),this.renderer.render(this.scene,this.camera),this.#E&&this.#E.render(this.renderer)}}class Q{#$;#K;#X=new z;#q;#J=!1;constructor(e,t){this.#$=e,this.#K=t,e.WidgetsValue.Subscribe(()=>this.WidgetsChanged()),e.SizeValue.Subscribe(()=>this.Layout())}WidgetsChanged(){if(this.#X.Clear(),this.#$.Widgets)for(const e of this.#$.Widgets)e.VisibleValue.Subscribe(()=>this.Layout(),this.#X),e.SizeValue.Subscribe(()=>this.Layout(),this.#X);this.Layout()}Layout(){if(this.#J)this.#q=!0;else{this.#q=!1,this.#J=!0;try{this.#K(),this.#q&&this.#K()}finally{this.#J=!1}}}}class Z extends R{RadiusValue=new k(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new k(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new k(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new k(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}constructor(){super(),this.DrawFunc=this.#Y.bind(this);const e=this.InvalidateVisual.bind(this);this.RadiusValue.Subscribe(e),this.FillColorValue.Subscribe(e),this.StrokeColorValue.Subscribe(e),this.StrokeThicknessValue.Subscribe(e)}#Y(e,t,s){const i=this.StrokeColor?this.StrokeThickness/2:0,o=this.Radius,r=i,n=t/2,a=t-i,l=i,h=s/2,c=s-i;e.DrawPath(this.FillColor,!0,this.StrokeThickness,this.StrokeColor,["m",i,s/2,"arc",r,l,n,l,o,"arc",a,l,a,h,o,"arc",a,c,n,c,o,"arc",r,c,r,h,o])}}class ee extends T{#Q=!1;#Z;#ee;#te;#se;constructor(e,{AnimateUp:t,AnimateDown:s,AnimateHover:i}){super(),this.#Z=e,this.#te=s,this.#ee=t,this.#se=i}OnEvent(e,t){if(e instanceof PointerEvent){if("pointerleave"==e.type&&this.#ee&&this.#ee(),"pointermove"==e.type){const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i?this.#Q?this.#te&&this.#te():this.#se&&this.#se():this.#ee&&this.#ee()}if("pointerdown"==e.type)return this.#Q=!0,void(this.#te&&this.#te());if(!1!==this.#Q&&"pointerup"==e.type){this.#Q=!1,this.#ee&&this.#ee();const[s,i]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<i&&this.#Z()}}}}class te extends N{constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;const[t,s]=this.Size;if(!(t<1||s<1))for(const i of e){const e=i.Constraints,[o,r]=te.CalculateSize(t,e,"width","left","right"),[n,a]=te.CalculateSize(s,e,"height","top","bottom");i.Position=[o,n],i.Size=[r,a]}}static CalculateSize(e,t,s,i,o){const r=t.TryGet(s),n=t.TryGet(i),a=t.TryGet(o);let l=0,h=0;if(r[0])h=r[1],l=n[0]?n[1]:a[0]?e-a[1]-r[1]:(e-r[1])/2;else{const t=n[0]?n[1]:0;l=t,h=e-t-(a[0]?a[1]:0)}return[l,h]}}class se extends N{SpacingValue=new k(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;let t=0,s=se.CalculatePixelsPerPercent(e,this.Spacing,this.Size[0]-0,"width","width_proportional","left","right");for(const i of e)t+=this.#ie(i,t,s),t+=this.Spacing}#ie(e,t,s){var i=e.Constraints;const[o,r]=se.CalculateSize(i,"width","width_proportional","left",s);var[n,a]=te.CalculateSize(this.Size[1]-0,i,"height","top","bottom");return e.Position=[t+o,n],e.Size=[r,a],o+r+i.GetOrDefault("right",0)}static CalculateSize(e,t,s,i,o){let[r,n]=e.TryGet(t);return r||(n=e.GetOrDefault(s,1)*o),[e.GetOrDefault(i,0),n]}static CalculatePixelsPerPercent(e,t,s,i,o,r,n){let a=0,l=e.length>1?(e.length-1)*t:0;for(const t of e){const e=t.Constraints;l+=e.GetOrDefault(r,0)+e.GetOrDefault(n,0),e.Has(i)?l+=e.Get(i):a+=e.GetOrDefault(o,1)}var h=s-l;return h>0?h/a:0}}class ie extends N{static#oe=[0,0,0,0];#re;SpacingValue=new k(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}PaddingValue=new k(ie.#oe);get Padding(){return this.PaddingValue.Value}set Padding(e){this.PaddingValue.Value=e}constructor(){super(),this.#re=new Q(this,()=>this.#ne()),this.SizeValue.Subscribe(()=>this.#re.Layout()),this.WidgetsValue.Subscribe(()=>this.#re.Layout())}Layout(){this.#re.Layout()}#ne(){const e=this.Widgets;if(!e)return;const t=e.length,[s,i,o,r]=this.Padding;let n=i;const a=this.Size[0];for(let i=0;i<t;i++){i>0&&(n+=this.Spacing);const t=e[i],r=t.Constraints,l=r.Has("height")?r.Get("height"):t.Size[1],h=r.Has("left")?r.Get("left"):0,c=r.Has("right")?r.Get("right"):0;t.Position=[h+s,n],t.Size=[a-h-c-s-o,l],n+=t.Size[1]}n+=r;const[l,h]=this.Size;h!=n&&(this.Size=[l,n])}}class oe extends te{#ae=new Z;#le=new D;#he=new Z;RadiusValue=new k(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new k(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new k(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new k(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}TextValue=new k(null);get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new k(null);get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}get TextAlignment(){return this.#le.TextAlignment}set TextAlignment(e){this.#le.TextAlignment=e}ClickAction=null;Command=new P;constructor(){super();const e=this;this.Widgets=[this.#ae,this.#le,this.#he],this.Gestures=[new ee(function(){e.OnClick()},{AnimateDown:function(){e.#he.FillColor="#00000010"},AnimateUp:function(){e.#he.FillColor="#00000000"},AnimateHover:function(){e.#he.FillColor="#ffffff10"}})],this.RadiusValue.Subscribe(function(){e.#ae.Radius=e.Radius,e.#he.Radius=e.Radius}),this.FillColorValue.Subscribe(function(){e.#ae.FillColor=e.FillColor}),this.StrokeColorValue.Subscribe(function(){e.#ae.StrokeColor=e.StrokeColor}),this.StrokeThicknessValue.Subscribe(function(){e.#ae.StrokeThickness=e.StrokeThickness}),this.TextValue.Subscribe(function(){e.#le.Text=e.Text}),this.TextColorValue.Subscribe(function(){e.#le.TextColor=e.TextColor})}OnClick(){this.ClickAction&&this.ClickAction(),this.Command.Notify()}}const re="house_6x3";class ne{static#ce;static{const e=ne.#ce=new Map;e.set("block|house_6x3",{id:"house_6x3",width:1,height:2,fbxName:"a/home_6x3"}),e.set("block|house_3x3_hi",{id:"house_3x3_hi",width:1,height:1,fbxName:"a/home_3x3_hi"}),e.set("block|house_3x3_lo",{id:"house_3x3_lo",width:1,height:1,fbxName:"a/home_3x3_lo"}),e.set("block|garage_6x3",{id:"garage_6x3",width:1,height:2,fbxName:"a/garage_6x3"}),e.set("block|veranda_3x3_hi",{id:"veranda_3x3_hi",width:1,height:1,fbxName:"a/veranda_3x3_hi"}),e.set("block|veranda_3x3_lo",{id:"veranda_3x3_lo",width:1,height:1,fbxName:"a/veranda_3x3_lo"}),e.set("block_shift|house_6x3",{canShift:!1,order:0}),e.set("block_shift|house_3x3_hi",{canShift:!1,order:0}),e.set("block_shift|house_3x3_lo",{canShift:!1,order:0}),e.set("block_shift|garage_6x3",{canShift:!0,order:1}),e.set("block_shift|veranda_3x3_hi",{canShift:!0,order:2}),e.set("block_shift|veranda_3x3_lo",{canShift:!0,order:2}),e.set("key|1",{id:"house_6x3",title:"1.House\n6x3"}),e.set("key|2",{id:"house_3x3_hi",title:"2.House\n3x3 Hi"}),e.set("key|3",{id:"house_3x3_lo",title:"3.House\n3x3 Lo"}),e.set("key|4",{id:"garage_6x3",title:"4.Gararage\n6x3"}),e.set("key|5",{id:"veranda_3x3_hi",title:"5.Veranda\n3x3 Hi"}),e.set("key|6",{id:"veranda_3x3_lo",title:"6.Veranda\n3x3 Lo"});const t={allowed:!0};e.set("rules|hor|202|202",t),e.set("rules|hor|203|203",t),e.set("rules|hor|204|204",t),e.set("rules|hor|205|205",t),e.set("rules|hor|207|206",t),e.set("rules|hor|208|209",t),e.set("rules|hor|209|302",t),e.set("rules|hor|209|303",t),e.set("rules|hor|209|304",t),e.set("rules|hor|209|305",t),e.set("rules|hor|302|207",t),e.set("rules|hor|302|302",t),e.set("rules|hor|302|522",t),e.set("rules|hor|302|523",t),e.set("rules|hor|302|526",t),e.set("rules|hor|302|527",t),e.set("rules|hor|303|207",t),e.set("rules|hor|303|303",t),e.set("rules|hor|303|526",t),e.set("rules|hor|303|527",t),e.set("rules|hor|304|204",t),e.set("rules|hor|304|207",t),e.set("rules|hor|304|304",t),e.set("rules|hor|304|524",t),e.set("rules|hor|304|525",t),e.set("rules|hor|304|526",t),e.set("rules|hor|304|527",t),e.set("rules|hor|305|205",t),e.set("rules|hor|305|207",t),e.set("rules|hor|305|305",t),e.set("rules|hor|305|525",t),e.set("rules|hor|305|526",t),e.set("rules|hor|305|527",t),e.set("rules|hor|522|302",t),e.set("rules|hor|522|522",t),e.set("rules|hor|523|302",t),e.set("rules|hor|523|523",t),e.set("rules|hor|524|304",t),e.set("rules|hor|524|524",t),e.set("rules|hor|525|304",t),e.set("rules|hor|525|525",t),e.set("rules|hor|528|302",t),e.set("rules|hor|528|303",t),e.set("rules|hor|528|304",t),e.set("rules|hor|528|305",t),e.set("rules|hor|529|302",t),e.set("rules|hor|529|303",t),e.set("rules|hor|529|304",t),e.set("rules|hor|529|305",t),e.set("rules|ver|203|202",t),e.set("rules|ver|204|205",t),e.set("rules|ver|205|304",t),e.set("rules|ver|206|206",t),e.set("rules|ver|207|207",t),e.set("rules|ver|208|208",t),e.set("rules|ver|209|209",t),e.set("rules|ver|302|203",t),e.set("rules|ver|302|522",t),e.set("rules|ver|302|523",t),e.set("rules|ver|303|302",t),e.set("rules|ver|303|522",t),e.set("rules|ver|303|523",t),e.set("rules|ver|303|526",t),e.set("rules|ver|303|527",t),e.set("rules|ver|303|528",t),e.set("rules|ver|303|529",t),e.set("rules|ver|304|305",t),e.set("rules|ver|305|303",t),e.set("rules|ver|305|526",t),e.set("rules|ver|523|522",t),e.set("rules|ver|524|303",t),e.set("rules|ver|524|304",t),e.set("rules|ver|524|305",t),e.set("rules|ver|524|525",t),e.set("rules|ver|525|303",t),e.set("rules|ver|525|304",t),e.set("rules|ver|525|305",t),e.set("rules|ver|526|303",t),e.set("rules|ver|526|305",t),e.set("rules|ver|526|526",t),e.set("rules|ver|527|305",t),e.set("rules|ver|527|526",t),e.set("rules|ver|527|527",t),e.set("rules|ver|528|305",t),e.set("rules|ver|528|528",t),e.set("rules|ver|529|305",t),e.set("rules|ver|529|528",t),e.set("rules|ver|529|529",t),e.set("rules|hor|202|523",t),e.set("rules|hor|203|303",t),e.set("rules|hor|204|525",t),e.set("rules|hor|205|305",t),e.set("rules|hor|303|203",t),e.set("rules|hor|303|523",t),e.set("rules|hor|523|202",t),e.set("rules|hor|523|303",t),e.set("rules|hor|525|204",t),e.set("rules|hor|525|305",t),e.set("rules|ver|205|303",t),e.set("rules|ver|205|305",t),e.set("rules|ver|303|203",t),e.set("rules|ver|305|203",t),e.set("rules|ver|305|523",t),e.set("rules|hor|527|526",t),e.set("rules|hor|528|529",t),e.set("rules|ver|206|526",t),e.set("rules|ver|207|527",t),e.set("rules|ver|208|528",t),e.set("rules|ver|209|529",t),e.set("rules|ver|526|206",t),e.set("rules|ver|527|207",t),e.set("rules|ver|528|208",t),e.set("rules|ver|529|209",t)}static findEntity(...e){if(0==e.length)return null;const t=e.join("|");return ne.#ce.get(t)||null}static getEntity(...e){if(0==e.length)return null;const t=e.join("|");return ne.#ce.get(t)||(console.log("CMS | entity not found | ",e),null)}static getEntities(...e){const t=e.join("|")+"|",s=[];for(const[e,i]of ne.#ce)e.startsWith(t)&&s.push(i);return s}}class ae{#ue;#de;#ge;#fe;#pe;#xe;constructor(e,t,s,i,o,r){j.throwUndefined(e,t,s,i,o,r),this.#ue=e,this.#de=t,this.#ge=s,this.#fe=i,this.#pe=o,this.#xe=r,Object.freeze(this)}get name(){return this.#ue}get x(){return this.#de}get z(){return this.#ge}get width(){return this.#fe}get height(){return this.#pe}get direction(){return this.#xe}isIntersected(e){if(e instanceof ae){let t=!1;return this.forEachCell((s,i,o)=>{e.forEachCell((e,s,r)=>{i==s&&o==r&&(t=!0)})}),t}return j.throw(`unexpected object ${e}`),!1}forEachCell(e){if(1!=this.#fe||1!=this.#pe){if(1==this.#fe&&2==this.#pe)switch(e(this,this.#de,this.#ge),this.#xe){case 0:return void e(this,this.#de,this.#ge-1);case 90:return void e(this,this.#de+1,this.#ge);case 180:return void e(this,this.#de,this.#ge+1);case 270:return void e(this,this.#de-1,this.#ge)}throw`unexpected block: '${this.#de}x${this.#ge}A${this.#xe}'`}e(this,this.#de,this.#ge)}getOrigin(){return $.toVector(this.x,this.z)}static#be=[{c:303,n:"house_6x3",d:0,o:!0},{c:305,n:"house_6x3",d:180,o:!0},{c:302,n:"house_6x3",d:0,o:!1},{c:304,n:"house_6x3",d:180,o:!1},{c:303,n:"house_3x3_hi",d:0,o:!0},{c:305,n:"house_3x3_hi",d:180,o:!0},{c:302,n:"house_3x3_lo",d:0,o:!0},{c:304,n:"house_3x3_lo",d:180,o:!0},{c:203,n:"garage_6x3",d:0,o:!0},{c:207,n:"garage_6x3",d:90,o:!0},{c:205,n:"garage_6x3",d:180,o:!0},{c:209,n:"garage_6x3",d:270,o:!0},{c:202,n:"garage_6x3",d:0,o:!1},{c:206,n:"garage_6x3",d:90,o:!1},{c:204,n:"garage_6x3",d:180,o:!1},{c:208,n:"garage_6x3",d:270,o:!1},{c:523,n:"veranda_3x3_hi",d:0,o:!0},{c:527,n:"veranda_3x3_hi",d:90,o:!0},{c:525,n:"veranda_3x3_hi",d:180,o:!0},{c:529,n:"veranda_3x3_hi",d:270,o:!0},{c:522,n:"veranda_3x3_lo",d:0,o:!0},{c:526,n:"veranda_3x3_lo",d:90,o:!0},{c:524,n:"veranda_3x3_lo",d:180,o:!0},{c:528,n:"veranda_3x3_lo",d:270,o:!0}];getCode(e,t){const s=this.name,i=this.#xe,o=this.x==e&&this.#ge==t;for(const{c:e,n:t,d:r,o:n}of ae.#be)if(t==s&&r==i&&n==o)return e}static fromCode(e,t,s){let i="",o=0;for(const{c:t,n:s,d:r,o:n}of ae.#be)"house_6x3"!=s&&t==e&&n&&(i=s,o=r);if(""==i)return null;const{width:r,height:n}=ne.getEntity("block",i),a=new ae(i,t,s,r,n,o);return a.getCode(t,s)!=e&&(console.log(a,a.getCode(),e),j.throw("codes MUST be same")),a}}class le{#we=[];constructor(){}get blocks(){return this.#we}blocksChanged=new P;canAdd(e){if(e instanceof ae){for(const t of this.#we)if(t.isIntersected(e))return!1;return le.#me([e,...this.#we])}return!1}add(e){return!!this.canAdd(e)&&(this.#we.push(e),this.blocksChanged.Notify(),!0)}remove(e){const t=this.#we.indexOf(e);if(-1!==t)return this.#we.splice(t,1),this.blocksChanged.Notify(),!0}find(e,t){for(const s of this.#we){let i=!1;if(s.forEachCell((s,o,r)=>{o==e&&r==t&&(i=!0)}),i)return s}return null}printUndefinedRules(){le.#Le.clear(),le.#me(this.#we);const e=[...le.#Le].join("\n");return console.log(e),e}static#me(e){const t=[];for(const s of e)s instanceof ae&&s.forEachCell(function(e,s,i){t.push([e,s,i])});const s=new Map;let i=!0;const o=le.validatePlacementDefaults;for(const[e,r,n]of t){const t=-n,a=e.getCode(r,n);s.has(`${r-1}:${t}`)&&(le.#Ve(s.get(`${r-1}:${t}`),a,"hor",o)||(i=!1)),s.has(`${r+1}:${t}`)&&(le.#Ve(a,s.get(`${r+1}:${t}`),"hor",o)||(i=!1)),s.has(`${r}:${t-1}`)&&(le.#Ve(s.get(`${r}:${t-1}`),a,"ver",o)||(i=!1)),s.has(`${r}:${t+1}`)&&(le.#Ve(a,s.get(`${r}:${t+1}`),"ver",o)||(i=!1)),s.set(`${r}:${t}`,a)}return i}static validatePlacementDefaults=!1;static#Le=new Set;static#Ve(e,t,s,i){if(e&&t){const i=ne.findEntity("rules",s,e,t);if(i)return i.allowed;const o=`${s}|${e}|${t}`;le.#Le.add(o)}return i}}class he{#Ce;activeBlockName;activeDirection=0;activeToolChanged=new P;blockToSceneObjMapping=new Map;pointerCoords=null;pointerOverBlock=null;constructor(e){j.assert(e instanceof le),this.#Ce=e,this.activeBlockName=ne.getEntity("key|1").id}setDirection(e){this.activeDirection=e,this.#Se(),this.#ye()}rotateLeft(){switch(this.activeDirection){case 0:this.activeDirection=270;break;case 90:this.activeDirection=0;break;case 180:this.activeDirection=90;break;case 270:this.activeDirection=180}this.#Se(-1),this.#ye()}rotateRight(){switch(this.activeDirection){case 0:this.activeDirection=90;break;case 90:this.activeDirection=180;break;case 180:this.activeDirection=270;break;case 270:this.activeDirection=0}this.#Se(),this.#ye()}#Se(e){if(this.activeBlockName&&this.activeBlockName.startsWith("house_"))if(-1===e)switch(this.activeDirection){case 90:this.activeDirection=0;break;case 270:this.activeDirection=180}else switch(this.activeDirection){case 90:this.activeDirection=180;break;case 270:this.activeDirection=0}}setBlockName(e){this.activeBlockName=e,this.#Se(),this.#ye()}#ye(){this.activeToolChanged.notify()}canPlaceAtCoords(e){const{width:t,height:s}=ne.getEntity("block",this.activeBlockName),i=new ae(this.activeBlockName,e.x,e.z,t,s,this.activeDirection);return this.#Ce.canAdd(i)}placeAtCoords(e){const{width:t,height:s}=ne.getEntity("block",this.activeBlockName),i=new ae(this.activeBlockName,e.x,e.z,t,s,this.activeDirection);this.#Ce.add(i)}removeAtCoords(e){const t=new ae(null,e.x,e.z,1,1,0),s=[];for(const e of this.#Ce.blocks)e.isIntersected(t)&&s.push(e);for(const e of s)this.#Ce.remove(e)}}class ce extends ie{static#ve="⏷";static#Ae="⏵";#Me;#ze;#Pe;HeaderTitleValue=new k;get HeaderTitle(){return this.HeaderTitleValue.Value}set HeaderTitle(e){this.HeaderTitleValue.Value=e}get BodyWidgets(){return this.#Pe.Widgets}set BodyWidgets(e){this.#Pe.Widgets=e}constructor(){super();const e=new oe;e.Command.Subscribe(()=>{this.#ke()});const t=this.#Me=new D;t.TextAlignment=[-1,0],t.FontSize=20;const s=new Z;s.Constraints.With("height",1).With("bottom",0),s.FillColor="#ccc";const i=this.#ze=new te;i.Constraints.With("height",48),i.Widgets=[t,s,e];const o=this.#Pe=new ie;o.Padding=[8,4,0,16],o.Spacing=4,this.Widgets=[i,o],this.HeaderTitleValue.Subscribe(()=>this.#_e())}#ke(){1==this.Widgets.length?this.Widgets=[this.#ze,this.#Pe]:this.Widgets=[this.#ze],this.#_e()}#_e(){1==this.Widgets.length?this.#Me.Text=ce.#Ae+" "+this.HeaderTitle:this.#Me.Text=ce.#ve+" "+this.HeaderTitle}}class ue{pluginSections=[];#We=[];addSection(e){this.pluginSections.push(e)}addNewSection(e,...t){const s=new ce;s.HeaderTitle=e,s.BodyWidgets=[...t],this.addSection(s)}getSharedSection(e){const t=this.#We.find(t=>t.HeaderTitle==e);if(t)return t;const s=new ce;return s.HeaderTitle=e,s.BodyWidgets=[],this.pluginSections.push(s),this.#We.push(s),s}appendToSharedSection(e,t){const s=this.getSharedSection(e);s.BodyWidgets=[...s.BodyWidgets,t]}}class de{static registeredPluginClasses=[];#Te=null;get initialized(){return null!=this.#Te}get viewManager(){return this.#Te.sceneManager}get scene(){return this.viewManager.scene}get houseViewModel(){return this.#Te.houseViewModel}get toolsModel(){return this.#Te.toolsModel}get houseModel(){return this.#Te.houseModel}get resourceManager(){return this.#Te.resourceManager}onSceneCreated(e){j.assert(e instanceof fe,"onSceneCreated | rootViewModel"),j.assert(!this.initialized,"onSceneCreated | initialized"),this.#Te=e,this.onEnabled();const t=this.houseModel.blocksChanged.subscribeAndNotify(()=>this.onHouseBlocksChanged());j.throwUndefined("subs1",t)}onEnabled(){}onHouseBlocksChanged(){}onRender(){}onPointerMove(e,t){j.throwUndefined(e,t)}onPointerDown(e,t){j.throwUndefined(e,t)}onDocumentKeyDown(e){j.throwUndefined(e)}onDocumentKeyUp(e){j.throwUndefined(e)}getInspectorOrder(){return 0}onBuildInspector(e){j.assert(e instanceof ue)}static registerPlugin(e){de.registeredPluginClasses.push(e)}}class ge extends _{#He;view3dHost;imageHost;constructor(){super();const e=new N,t=new N;t.Constraints.With("top",0),t.Constraints.With("right",0),t.Constraints.With("width",100),t.Constraints.With("height",100);const s=new te;s.Widgets=[e,t];const i=this.#He=new ie;i.Padding=[8,8,8,32];const o=new E;o.Constraints.With("width",300),o.Content=i;const r=new Z;r.Constraints.With("width",5),r.FillColor="#ccc";const n=new se;n.Widgets=[s,r,o],this.view3dHost=e,this.imageHost=t,this.Content=n}attach(e){j.assert(e instanceof fe);const t=new X(e.plugins).OrderBy(e=>e.getInspectorOrder()).ToList(),s=new ue;for(const e of t)e.onBuildInspector(s);this.#He.Widgets=[...s.pluginSections]}}class fe{resourceManager;sceneManager;mainPage;#Ne=[];get plugins(){return this.#Ne}#Ee;get houseViewModel(){return this.#Ee}get toolsModel(){return this.#Ee}#Ce=new le;get houseModel(){return this.#Ce}constructor(e){this.mainPage=new ge,new I(e).Show(this.mainPage),this.resourceManager=new J,this.sceneManager=new Y(this.mainPage.view3dHost.PlatformView),this.#Ee=new he(this.#Ce),this.loadPlugins(),this.sceneManager.attach(this),this.mainPage.attach(this),this.forEachPlugin(e=>e.onSceneCreated(this))}loadPlugins(){for(const e of de.registeredPluginClasses)this.#Ne.push(new e)}forEachPlugin(e){for(const t of this.#Ne)e(t)}}function pe(e,t,s,i){t.add(e),s.push(e);const o=function(e,t){const s=[];for(const i of t)e!==i&&xe(e,i)&&s.push(i);return s}(e,i);for(const r of o)t.has(r)||r.name!==e.name||pe(r,t,s,i)}function xe(e,t){const s=(e.x+e.width===t.x||t.x+t.width===e.x)&&e.y<t.y+t.height&&e.y+e.height>t.y,i=(e.y+e.height===t.y||t.y+t.height===e.y)&&e.x<t.x+t.width&&e.x+e.width>t.x;return s||i}function be(e,t){const s=[];return e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x+e.width===t.x&&s.push("right"),t.x+t.width===e.x&&s.push("left")),e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y+e.height===t.y&&s.push("down"),t.y+t.height===e.y&&s.push("up")),s}function we(e,t){const s=new Set;for(const i of e)for(const e of t){const t=be(i,e);for(const e of t)s.add(e)}return[...s]}function me(e,t){const s=new Set;for(const i of t){const t=we(e,i);for(const e of t)s.add(e)}return[...s]}de.registerPlugin(class extends de{constructor(){super()}onEnabled(){const e=new v(this.viewManager.camera,this.viewManager.renderer.domElement);e.minDistance=500,e.maxDistance=5e3,e.minPolarAngle=F(0),e.maxPolarAngle=F(90),e.target.set(0,175,0),e.mouseButtons={RIGHT:h.ROTATE,MIDDLE:h.PAN},e.update()}});class Le{static Text(e){const t=new D;return t.Text=e,t.TextAlignment=[-1,0],t.Constraints.With("height",32),t}static Button(e,t){const s=new oe;return s.Radius=6,s.StrokeColor="#ccc",s.StrokeThickness=1,s.Text=e,s.Constraints.With("height",32),s.Command.Subscribe(()=>t(s)),s}static Checkbox(e,t,s){const i="☑ "+e,o="☐ "+e,r=new oe;return r.Text=t?i:o,r.TextAlignment=[-1,0],r.Constraints.With("height",32),r.Command.Subscribe(()=>{const e=s();!0===e&&(r.Text=i),!1===e&&(r.Text=o)}),r}static Checkbox2(e,t){if(t instanceof k)return this.Checkbox(e,t.Value,()=>(t.Value=!t.Value,t.Value))}static Radiobox(e,t,s){const i="◉ "+e,o="⭘ "+e,r=new oe;return r.TextAlignment=[-1,0],r.Constraints.With("height",32),r.Command.Subscribe(()=>{s.Value=t}),s.Subscribe(e=>{r.Text=s.Value==t?i:o}),r}static Header(e){const t=new D;return t.Constraints.With("height",32),t.Text=e,t.TextAlignment=[-1,0],t}}de.registerPlugin(class extends de{#De=new k(!1);onEnabled(){this.#De.Subscribe(()=>this.#Re())}onBuildInspector(e){const t=e.getSharedSection("View"),s=Le.Checkbox2("Transparent",this.#De);t.BodyWidgets=[...t.BodyWidgets,s]}onHouseBlocksChanged(){const e=this.houseViewModel.blockToSceneObjMapping;for(const e of this.houseModel.blocks)this.#Oe(e);this.#Be();const t=[];for(const s of e.keys())this.houseModel.blocks.includes(s)||t.push(s);for(const s of t){const t=e.get(s);e.delete(s),this.scene.remove(t)}}#Oe(e){const t=this.houseViewModel.blockToSceneObjMapping;if(t.has(e))return t.get(e);const{fbxName:s}=ne.getEntity("block",e.name),i=this.resourceManager.getObject(s);return i.rotation.set(0,F(-e.direction),0),t.set(e,i),this.scene.add(i),this.#Re(),i}#Be(){const e=[];this.houseModel.blocks.forEach(t=>{t instanceof ae&&t.forEachCell((s,i,o)=>{const{order:r}=ne.getEntity("block_shift",t.name);e.push({block:t,x:i,y:o,width:1,height:1,name:`${r}`,order:r})})});const t=function(e){const t=new Set,s=[];for(const i of e)if(!t.has(i)){const o=[];pe(i,t,o,e),s.push(o)}return s}(X.OrderBy(e,e=>e.order));for(let e=0;e<t.length;e++){const s=t.slice(0,e),i=t[e],o=me(i,s);let r=0,n=0;for(const e of o)switch(e){case"left":r+=42.5;break;case"right":r-=42.5;break;case"up":n+=42.5;break;case"down":n-=42.5}for(const{block:e}of i){const t=this.#Oe(e);t.position.copy($.toVector(e.x,e.z)),t.position.set(t.position.x+r,-1,t.position.z+n)}}}#Re(){const e=this.houseViewModel.blockToSceneObjMapping;for(const t of e.values())t.traverse(e=>{if(e.isMesh){const t=e.material.clone();t.opacity=this.#De.Value?.5:1,t.transparent=this.#De.Value,e.material=t}})}});class Ve extends de{#Ie=new k(!0);#je=[];onEnabled(){this.#Ie.Subscribe(()=>this.onHouseBlocksChanged())}onBuildInspector(e){const t=Le.Checkbox2("Show external walls",this.#Ie),s=e.getSharedSection("View");s.BodyWidgets=[...s.BodyWidgets,t]}static#Fe(){const e=[-1,-1,!1],t=[0,-1,!1],s=[1,-1,!1],i=[-1,0,!1],o=[1,0,!1],r=[-1,1,!1],n=[0,1,!1],a=[1,1,!1],l=[-1,-1,!0],h=[1,-1,!0],c=[-1,0,!0],u=[1,0,!0],d=[-1,1,!0],g=[0,1,!0],f=[1,1,!0],p="Roof 6m full",x="Roof 6m cuted",b="Roof 3m high full",w="Roof 3m high cuted",m="Roof 3m low full",L="Roof 3m low cuted";return new Map([["house_6x3",[{fbx:"A13.1.1 H.WALL. PNL 3877 CR.D",pos:{x:-150,z:-450},degree:90,rules:[]},{fbx:"Window 10x07",pos:{x:-50,z:-450},degree:270,rules:[]},{fbx:"A13.1.1 H.WALL. PNL 1227 UP + 1950 DWN",pos:{x:-50,z:-450},degree:90,rules:[]},{fbx:"A13.1.1 H.WALL. PNL 3877",pos:{x:50,z:-450},degree:90,rules:[]},{fbx:"A13.1.1 H.WALL. PNL 3877",pos:{x:150,z:-450},degree:90,rules:[h]},{fbx:"A13.1.1 H.WALL. PNL 3877 CL.D",pos:{x:150,z:-450},degree:90,rules:[s]},{fbx:"A13.1.1 H.WALL. PNL 4024 CL.E",pos:{x:150,z:-450},degree:0,rules:[s]},{fbx:"A13.1.1 H.WALL. PNL 4292 E12",pos:{x:150,z:-350},degree:0,rules:[s]},{fbx:"A13.1.1 H.WALL. PNL 4560 E11",pos:{x:150,z:-250},degree:0,rules:[s]},{fbx:"A13.1.1 H.WALL. PNL 4828 E10",pos:{x:150,z:-150},degree:0,rules:[s,o]},{fbx:"A13.1.1 H.WALL. PNL 4681 ICR.E",pos:{x:150,z:-150},degree:0,rules:[s,u]},{fbx:"A13.1.1 H.WALL. PNL 4828 ICL.E",pos:{x:150,z:-150},degree:0,rules:[o,h]},{fbx:"Window 20x18",pos:{x:150,z:0},degree:180,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 2446 UP + 850 DWN E9",pos:{x:150,z:-50},degree:0,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 2714 UP + 850 DWN E8",pos:{x:150,z:50},degree:0,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 5498",pos:{x:150,z:150},degree:0,rules:[o,a,g]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICR.E",pos:{x:150,z:150},degree:0,rules:[o,f]},{fbx:"A13.1.1 H.WALL. PNL 5551 CR.E",pos:{x:150,z:150},degree:0,rules:[o,a,n]},{fbx:"A13.1.1 H.WALL. PNL 5551 CR.D",pos:{x:150,z:150},degree:270,rules:[n,o,a]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICR.D",pos:{x:150,z:150},degree:270,rules:[n,f]},{fbx:"Window 10x18",pos:{x:50,z:150},degree:90,rules:[n]},{fbx:"A13.1.1 H.WALL. PNL 2901 UP + 850 DWN",pos:{x:50,z:150},degree:270,rules:[n]},{fbx:"A13.1.1 H.WALL. PNL 5551",pos:{x:-50,z:150},degree:270,rules:[n]},{fbx:"A13.1.1 H.WALL. PNL 5551",pos:{x:-150,z:150},degree:270,rules:[n,r,c]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICL.D",pos:{x:-150,z:150},degree:270,rules:[n,d]},{fbx:"A13.1.1 H.WALL. PNL 5551 CL.D",pos:{x:-150,z:150},degree:270,rules:[n,r,i]},{fbx:"A13.1.1 H.WALL. PNL 5551 CL.E",pos:{x:-150,z:150},degree:180,rules:[i,n,r]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICL.E",pos:{x:-150,z:150},degree:180,rules:[i,d]},{fbx:"A13.1.1 H.WALL. PNL 5364 E6",pos:{x:-150,z:50},degree:180,rules:[i]},{fbx:"A13.1.1 H.WALL. PNL 5096 E5",pos:{x:-150,z:-50},degree:180,rules:[i]},{fbx:"A13.1.1 H.WALL. PNL 4828 E4",pos:{x:-150,z:-150},degree:180,rules:[i,e]},{fbx:"A13.1.1 H.WALL. PNL 4828 ICR.E",pos:{x:-150,z:-150},degree:180,rules:[i,l]},{fbx:"A13.1.1 H.WALL. PNL 4681 ICL.E",pos:{x:-150,z:-150},degree:180,rules:[e,c]},{fbx:"A13.1.1 H.WALL. PNL 4560 E3",pos:{x:-150,z:-250},degree:180,rules:[e]},{fbx:"A13.1.1 H.WALL. PNL 4292 E2",pos:{x:-150,z:-350},degree:180,rules:[e]},{fbx:"A13.1.1 H.WALL. PNL 4024 CR.E",pos:{x:-150,z:-450},degree:180,rules:[e]},{fbx:p,pos:{x:-150,z:-450},degree:270,rules:[n,r,i]},{fbx:p,pos:{x:-150,z:-450},degree:270,rules:[n,r,c]},{fbx:x,pos:{x:-150,z:-450},degree:270,rules:[g]},{fbx:x,pos:{x:-150,z:-450},degree:270,rules:[n,d]},{fbx:p,pos:{x:50,z:-450},degree:270,rules:[n]},{fbx:x,pos:{x:50,z:-450},degree:270,rules:[g]},{fbx:p,pos:{x:-50,z:-450},degree:270,rules:[n]},{fbx:x,pos:{x:-50,z:-450},degree:270,rules:[g]},{fbx:x,pos:{x:150,z:-450},degree:270,rules:[g,o]},{fbx:x,pos:{x:150,z:-450},degree:270,rules:[g,u,s]},{fbx:x,pos:{x:150,z:-450},degree:270,rules:[n,f,o]},{fbx:x,pos:{x:150,z:-450},degree:270,rules:[n,f,u,s]},{fbx:p,pos:{x:150,z:-450},degree:270,rules:[n,a,u,s]},{fbx:p,pos:{x:150,z:-450},degree:270,rules:[n,a,o]}]],["house_3x3_hi",[{fbx:"A13.1.1 H.WALL. PNL 4681 CR.D",pos:{x:-150,z:-150},degree:90,rules:[t,e]},{fbx:"A13.1.1 H.WALL. PNL 4681 ICR.D",pos:{x:-150,z:-150},degree:90,rules:[t,l]},{fbx:"A13.1.1 H.WALL. PNL 4681",pos:{x:-50,z:-150},degree:90,rules:[t]},{fbx:"A13.1.1 H.WALL. PNL 4681",pos:{x:50,z:-150},degree:90,rules:[t]},{fbx:"A13.1.1 H.WALL. PNL 4681",pos:{x:150,z:-150},degree:90,rules:[t,s,u]},{fbx:"A13.1.1 H.WALL. PNL 4681 ICL.D",pos:{x:150,z:-150},degree:90,rules:[t,h]},{fbx:"A13.1.1 H.WALL. PNL 4681 CL.D",pos:{x:150,z:-150},degree:90,rules:[t,s,o]},{fbx:"A13.1.1 H.WALL. PNL 4828 CL.E",pos:{x:150,z:-150},degree:0,rules:[o,t,s]},{fbx:"A13.1.1 H.WALL. PNL 4828 ICL.E",pos:{x:150,z:-150},degree:0,rules:[o,h]},{fbx:"A13.1.1 H.WALL. PNL 5096 E9",pos:{x:150,z:-50},degree:0,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 5364 E8",pos:{x:150,z:50},degree:0,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 5498",pos:{x:150,z:150},degree:0,rules:[o,a,g]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICR.E",pos:{x:150,z:150},degree:0,rules:[o,f]},{fbx:"A13.1.1 H.WALL. PNL 5551 CR.E",pos:{x:150,z:150},degree:0,rules:[o,a,n]},{fbx:"A13.1.1 H.WALL. PNL 5551 CR.D",pos:{x:150,z:150},degree:270,rules:[n,o,a]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICR.D",pos:{x:150,z:150},degree:270,rules:[n,f]},{fbx:"A13.1.1 H.WALL. PNL 5551",pos:{x:50,z:150},degree:270,rules:[n]},{fbx:"A13.1.1 H.WALL. PNL 5551",pos:{x:-50,z:150},degree:270,rules:[n]},{fbx:"A13.1.1 H.WALL. PNL 5551",pos:{x:-150,z:150},degree:270,rules:[n,r,c]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICL.D",pos:{x:-150,z:150},degree:270,rules:[n,d]},{fbx:"A13.1.1 H.WALL. PNL 5551 CL.D",pos:{x:-150,z:150},degree:270,rules:[n,r,i]},{fbx:"A13.1.1 H.WALL. PNL 5551 CL.E",pos:{x:-150,z:150},degree:180,rules:[i,n,r]},{fbx:"A13.1.1 H.WALL. PNL 5484 ICL.E",pos:{x:-150,z:150},degree:180,rules:[i,d]},{fbx:"A13.1.1 H.WALL. PNL 5364 E6",pos:{x:-150,z:50},degree:180,rules:[i]},{fbx:"A13.1.1 H.WALL. PNL 5096 E5",pos:{x:-150,z:-50},degree:180,rules:[i]},{fbx:"A13.1.1 H.WALL. PNL 4828 E4",pos:{x:-150,z:-150},degree:180,rules:[i,e,[0,-1,!0]]},{fbx:"A13.1.1 H.WALL. PNL 4828 ICR.E",pos:{x:-150,z:-150},degree:180,rules:[i,l]},{fbx:"A13.1.1 H.WALL. PNL 4828 CR.E",pos:{x:-150,z:-150},degree:180,rules:[i,e,t]},{fbx:b,pos:{x:150,z:-150},degree:270,rules:[n,o]},{fbx:b,pos:{x:50,z:-150},degree:270,rules:[n]},{fbx:b,pos:{x:-50,z:-150},degree:270,rules:[n]},{fbx:b,pos:{x:-150,z:-150},degree:270,rules:[n,r]},{fbx:w,pos:{x:150,z:-150},degree:270,rules:[g]},{fbx:w,pos:{x:50,z:-150},degree:270,rules:[g]},{fbx:w,pos:{x:-50,z:-150},degree:270,rules:[g]},{fbx:w,pos:{x:-150,z:-150},degree:270,rules:[g]}]],["house_3x3_lo",[{fbx:"A13.1.1 H.WALL. PNL 3877 CR.D",pos:{x:-150,z:-150},degree:90,rules:[i]},{fbx:"A13.1.1 H.WALL. PNL 3877",pos:{x:-50,z:-150},degree:90,rules:[]},{fbx:"A13.1.1 H.WALL. PNL 3877",pos:{x:50,z:-150},degree:90,rules:[]},{fbx:"A13.1.1 H.WALL. PNL 3877",pos:{x:150,z:-150},degree:90,rules:[u]},{fbx:"A13.1.1 H.WALL. PNL 3877 CL.D",pos:{x:150,z:-150},degree:90,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 4024 CL.E",pos:{x:150,z:-150},degree:0,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 4292 E12",pos:{x:150,z:-50},degree:0,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 4560 E11",pos:{x:150,z:50},degree:0,rules:[o]},{fbx:"A13.1.1 H.WALL. PNL 4828 E10",pos:{x:150,z:150},degree:0,rules:[o,a,g]},{fbx:"A13.1.1 H.WALL. PNL 4681 ICR.E",pos:{x:150,z:150},degree:0,rules:[o,f]},{fbx:"A13.1.1 H.WALL. PNL 4748 CR.E",pos:{x:150,z:150},degree:0,rules:[o,a,n]},{fbx:"A13.1.1 H.WALL. PNL 4748 CR.D",pos:{x:150,z:150},degree:270,rules:[n,o,a]},{fbx:"A13.1.1 H.WALL. PNL 4748 ICR.D",pos:{x:150,z:150},degree:270,rules:[n,f]},{fbx:"A13.1.1 H.WALL. PNL 4748",pos:{x:50,z:150},degree:270,rules:[n]},{fbx:"A13.1.1 H.WALL. PNL 4748",pos:{x:-50,z:150},degree:270,rules:[n]},{fbx:"A13.1.1 H.WALL. PNL 4748",pos:{x:-150,z:150},degree:270,rules:[n,r,c]},{fbx:"A13.1.1 H.WALL. PNL 4748 ICL.D",pos:{x:-150,z:150},degree:270,rules:[n,d]},{fbx:"A13.1.1 H.WALL. PNL 4748 CL.D",pos:{x:-150,z:150},degree:270,rules:[n,r,i]},{fbx:"A13.1.1 H.WALL. PNL 4748 CL.E",pos:{x:-150,z:150},degree:180,rules:[i,n,r]},{fbx:"A13.1.1 H.WALL. PNL 4681 ICL.E",pos:{x:-150,z:150},degree:180,rules:[i,d]},{fbx:"A13.1.1 H.WALL. PNL 4560 E3",pos:{x:-150,z:50},degree:180,rules:[i]},{fbx:"A13.1.1 H.WALL. PNL 4292 E2",pos:{x:-150,z:-50},degree:180,rules:[i]},{fbx:"A13.1.1 H.WALL. PNL 4024 CR.E",pos:{x:-150,z:-150},degree:180,rules:[i]},{fbx:m,pos:{x:150,z:-150},degree:270,rules:[n,o]},{fbx:m,pos:{x:50,z:-150},degree:270,rules:[n]},{fbx:m,pos:{x:-50,z:-150},degree:270,rules:[n]},{fbx:m,pos:{x:-150,z:-150},degree:270,rules:[n,r]},{fbx:L,pos:{x:150,z:-150},degree:270,rules:[g]},{fbx:L,pos:{x:50,z:-150},degree:270,rules:[g]},{fbx:L,pos:{x:-50,z:-150},degree:270,rules:[g]},{fbx:L,pos:{x:-150,z:-150},degree:270,rules:[g]}]]])}static#Ge=this.#Fe();onHouseBlocksChanged(){for(const e of this.#je)this.scene.remove(e);if(this.#je.length=0,this.#Ie.Value)for(const e of this.houseModel.blocks){if(!(e instanceof ae))continue;const t=Ve.#Ge.get(e.name);if(!t)continue;const s=e.getOrigin(),i=F(e.direction);for(const{fbx:o,pos:r,degree:a,rules:l}of t){if(!this.#Ue(e,l))continue;const t=this.resourceManager.getObject(o);t.position.set(r.x,0,r.z),t.position.applyEuler(new n(0,i,0)),t.position.add(s),t.rotation.set(0,F(a)+i,0),this.#je.push(t),this.scene.add(t)}}}#Ue(e,t){const s=this.houseModel,{order:i}=ne.getEntity("block_shift",e.name),{x:o,z:r,direction:n}=e;for(let[e,a,l]of t){[e,a]=G(e,a,n);const t=s.find(o+e,r+a);let h=!1;if(null!=t){const{order:e}=ne.getEntity("block_shift",t.name);h=i==e}if(l!=h)return!1}return!0}}de.registerPlugin(Ve),de.registerPlugin(class extends de{#$e=new k(!0);#Ke;constructor(){super();const e=3368499;this.#Ke=new a(6300,21,e,e)}onEnabled(){this.viewManager.scene.add(this.#Ke);for(let e=-10;e<=10;e++){let t=null;for(let s=-10;s<=10;s++){const i=this.resourceManager.getObject("grass");null==t&&(t=i.material.clone(),t.color.setRGB(.8+.02*e,1,.8-.02*e)),i.material=t,i.receiveShadow=!0,this.scene.add(i),i.position.copy($.toVector(s,e))}}this.#$e.Subscribe(()=>this.#Xe())}onBuildInspector(e){e.appendToSharedSection("View",Le.Checkbox2("Show grid",this.#$e))}#Xe(){this.#Ke.visible=this.#$e.Value}}),de.registerPlugin(class extends de{#qe=new K;#Je=new K("");#Ye=new K(!1);#Qe=new K(1);#Ze=new K;#et=new K;onEnabled(){this.#qe.Subscribe(()=>{this.#qe.Value&&(this.#Je.Value=this.#qe.Value.name,this.#Ye.Value=this.#qe.Value.transparent,this.#Qe.Value=this.#qe.Value.opacity,this.#Ze.Value=this.#qe.Value.metalness,this.#et.Value=this.#qe.Value.roughness)})}onBuildInspector(e){e.addNewSection("Material",this.#tt("Name",this.#Je,()=>this.#st(-1),()=>this.#st(1)),this.#tt("Transparent",this.#Ye,()=>this.#it(!1),()=>this.#it(!0)),this.#ot("Opacity",this.#Qe,e=>e.opacity,(e,t)=>e.opacity=t,0,1),this.#ot("Metallness",this.#Ze,e=>e.metalness,(e,t)=>e.metalness=t,0,1),this.#ot("Roughness",this.#et,e=>e.roughness,(e,t)=>e.roughness=t,0,1))}getInspectorOrder(){return 210}#it(e){this.#st(0),this.#qe.Value&&(this.#qe.Value.transparent=e,this.#Ye.Value=e)}#st(e){if(0==this.resourceManager.materials.size)return;const t=[...this.resourceManager.materials.values()],s=new X(t).OrderBy(e=>e.name).ToList();let i=0;if(this.#qe.Value){const t=s.indexOf(this.#qe.Value);-1!=t&&(i=Math.max(0,Math.min(s.length-1,t+e)))}this.#qe.Value=s.at(i)}#ot(e,t,s,i,o,r){const n=e=>{this.#st(0);const n=this.#qe.Value;if(n){const a=s(n),l=Math.max(o,Math.min(r,a+e*(r-o)/20));i(n,l),n.needsUpdate=!0,t.Value=l}};return this.#tt(e,t,()=>n(-1),()=>n(1))}#tt(e,t,s,i){const o=Le.Text(`${e}...`);o.TextAlignment=[0,0];const r=Le.Button("-",s);r.Constraints.With("width",32);const n=Le.Button("+",i);n.Constraints.With("width",32);const a=new se;return a.Constraints.With("height",32),a.Widgets=[r,o,n],t.SubscribeToChanges(()=>{"number"==typeof t.Value?o.Text=`${e}: ${t.Value.toFixed(2)}`:o.Text=`${e}: ${t.Value}`}),a}}),de.registerPlugin(class extends de{#rt;constructor(){super(),this.#rt=new A}onSceneCreated(){document.body.appendChild(this.#rt.dom)}onRender(){this.#rt.update()}});class Ce{#nt;#at;#lt=!1;#ht=null;get visible(){return this.#lt}constructor(){const e=new s(320,100,320);e.translate(0,50,0);const t=new u({color:10305403,transparent:!0,opacity:.5});this.#at=new c(e,t),this.#ht=this.#at}setScene(e){this.#nt!==e&&(this.#nt&&this.#lt&&this.#nt.remove(this.#ht),this.#nt=e,this.#nt&&this.#lt&&this.#nt.add(this.#ht))}setDirection(e){this.#ht.rotation.set(0,F(-e),0)}setModel(e){if(this.#ht==e)return;const t=this.#ht;this.#lt&&this.#nt.remove(this.#ht),this.#ht=e||this.#at,this.#lt&&this.#nt.add(this.#ht),this.#ht.castShadow=!0,this.#ht.position.copy(t.position),this.#ht.rotation.copy(t.rotation)}showAt(e){this.#lt||(this.#lt=!0,this.#nt&&this.#nt.add(this.#ht)),this.#ht.position.copy($.roundVector(e))}hide(){this.#lt&&(this.#lt=!1,this.#nt&&this.#nt.remove(this.#ht))}getCoords(){return $.fromVector(this.#ht.position)}}de.registerPlugin(class extends de{#ct;#ut=new Ce;#dt;#gt;#ft=new k;#pt=[];constructor(){super();const e=new x(6300,6300);e.rotateX(-Math.PI/2),this.#ct=new c(e),this.#ct.visible=!1}onEnabled(){this.scene.add(this.#ct),this.#dt=new Map;for(const{id:e,fbxName:t}of ne.getEntities("block"))this.#dt.set(e,this.resourceManager.getObject(t));this.#ut.setScene(this.scene),this.#ft.Value=this.toolsModel.activeBlockName,this.toolsModel.activeToolChanged.subscribeAndNotify(()=>this.#xt()),this.#ft.Subscribe(e=>{this.houseViewModel.setBlockName(e)})}#xt(){this.houseViewModel.activeBlockName?(this.#ut.setScene(this.scene),this.#ut.setDirection(this.houseViewModel.activeDirection),this.#gt=this.#dt.get(this.houseViewModel.activeBlockName),this.houseViewModel.canPlaceAtCoords(this.#ut.getCoords())?this.#ut.setModel(this.#gt):this.#ut.setModel(null)):this.#ut.setScene(null)}onHouseBlocksChanged(){const e=this.#pt;for(const t of e)this.scene.remove(t);e.length=0;for(const t of this.houseModel.blocks){const{fbxName:s}=ne.getEntity("block",t.name),i=this.resourceManager.getObject(s);i.rotation.set(0,F(-t.direction),0),i.position.copy($.toVector(t.x,t.z));const o=0,r=0;i.position.set(i.position.x+o,-1,i.position.z+r),i.visible=!1,i.blockRef=t,this.scene.add(i),e.push(i)}}onPointerMove(e,t){if(this.#bt(e,t),!this.houseViewModel.activeBlockName)return;const s=t.intersectObject(this.#ct,!0);if(0===s.length)return void this.#ut.hide();const i=s[0];this.#ut.showAt(i.point),this.houseViewModel.canPlaceAtCoords(this.#ut.getCoords())?this.#ut.setModel(this.#gt):this.#ut.setModel(null)}#bt(e,t){{const e=t.intersectObject(this.#ct,!0);if(0===e.length)this.toolsModel.pointerCoords=null;else{const t=e[0];this.toolsModel.pointerCoords=$.roundVector(t.point)}}{let e=null;const s=t.intersectObjects(this.#pt,!0);if(s.length>0){let t=s.at(0).object;for(;null!=t;){if(t.blockRef){e=t.blockRef;break}t=t.parent}}this.toolsModel.pointerOverBlock=e}}onPointerDown(e,t){this.houseViewModel.activeBlockName&&1===e.buttons&&this.#ut.visible&&(this.houseViewModel.canPlaceAtCoords(this.#ut.getCoords())?this.houseViewModel.placeAtCoords(this.#ut.getCoords()):this.houseViewModel.removeAtCoords(this.#ut.getCoords()),this.#ut.setModel(null))}getInspectorOrder(){return-1e3}onBuildInspector(e){const t=[];for(let e=1;e<=6;e+=1){const{id:s,title:i}=ne.getEntity(`key|${e}`);t.push(Le.Radiobox(i.replace("\n"," "),s,this.#ft))}const s=Le.Header("Rotation"),i=Le.Button("↶ Left",()=>{this.houseViewModel.rotateLeft()}),o=Le.Button("↷ Right",()=>{this.houseViewModel.rotateRight()}),r=new se;r.Spacing=4,r.Constraints.With("height",32),r.Widgets=[i,o];const n=new ce;n.HeaderTitle="1. Place modules",n.BodyWidgets=[...t,s,r],e.addSection(n)}onDocumentKeyDown(e){switch(e.key){case"ArrowLeft":this.houseViewModel.rotateLeft();break;case"ArrowRight":this.houseViewModel.rotateRight();break;case"Escape":this.#ft.Value=null;break;case"1":case"2":case"3":case"4":case"5":case"6":{const{id:t}=ne.getEntity(`key|${e.key}`);this.houseViewModel.activeBlockName==t?this.houseViewModel.rotateRight():this.#ft.Value=t;break}}}}),de.registerPlugin(class extends de{#wt=!1;onHouseBlocksChanged(){if(this.#wt)return;this.#wt=!0;const e=[],t=this.houseModel;for(const s of t.blocks){if("house_3x3_hi"!=s.name)continue;let i=null;switch(s.direction){case 0:i=t.find(s.x,s.z-1);break;case 180:i=t.find(s.x,s.z+1)}null!=i&&"house_3x3_lo"==i.name&&e.push([s,i])}for(const[s,i]of e){t.remove(s),t.remove(i);const{width:e,height:o}=ne.getEntity("block",re);t.add(new ae(re,s.x,s.z,e,o,s.direction))}this.#wt=!1}}),de.registerPlugin(class extends de{onBuildInspector(e){e.addNewSection("Rules",Le.Checkbox("Allow if not defined",le.validatePlacementDefaults,()=>(le.validatePlacementDefaults=!le.validatePlacementDefaults,le.validatePlacementDefaults)),Le.Button("Copy rules",()=>this.#mt()))}getInspectorOrder(){return 210}#mt(){const e=this.houseModel.printUndefinedRules();e.length?navigator.clipboard.writeText("new rules:\n"+e):navigator.clipboard.writeText("no new rules found")}});class Se{static toJsonString(e){const t=[];if(e.length>0){let s=e.at(0).x,i=e.at(0).z;for(const t of e)t.forEachCell(function(e,t,o){s=Math.min(s,t),i=Math.min(i,o)});for(const o of e)o.forEachCell((e,o,r)=>{t.push({code:e.getCode(o,r),x:o-s,z:r-i})})}return JSON.stringify(t,null,2)}}de.registerPlugin(class extends de{#Lt;constructor(){super();const e=Le.Button("Download",()=>{q(Se.toJsonString(this.houseModel.blocks),"house.json")}),t=Le.Button("Copy",()=>{const e=this.#Vt();navigator.clipboard.writeText(e)}),s=Le.Button("Save file...",()=>{q(this.#Vt(),"house.csv")}),i=Le.Button("Load file...",()=>this.#Ct()),o=this.#Lt=new ce;o.HeaderTitle="JSON / CSV",o.BodyWidgets=[Le.Text("JSON"),e,Le.Text("CSV"),t,s,i]}getInspectorOrder(){return 200}onBuildInspector(e){e.addSection(this.#Lt)}#Vt(){const e=this.houseModel.blocks;if(0==e.size)return;let t=1e7,s=1e7,i=-1,o=-1;for(const r of e)r instanceof ae&&r.forEachCell((e,r,n)=>{t=Math.min(t,r),s=Math.min(s,n),i=Math.max(i,r),o=Math.max(o,n)});const r=i-t+1,n=o-s+1,a=Array.from({length:n},()=>Array(r).fill(""));for(const i of e)i instanceof ae&&i.forEachCell((e,i,o)=>{a[o-s][i-t]=e.getCode(i,o)});return a.map(e=>e.join(",")).join("\n")}async#Ct(){const e=await new Promise(e=>{const t=document.createElement("input");t.type="file",t.addEventListener("change",t=>{const s=t.target.files;e(s)}),t.click()}),t=[...(await function(e){if(e)return new Promise(t=>{const s=new FileReader;s.addEventListener("load",()=>{t(s.result)}),s.readAsText(e)})}(e[0])).split(/\r?\n|\r|\n/g)].map(e=>e.split(",")),s=t.length,i=t.at(0).length,o=this.houseModel;for(;o.blocks.length>0;)o.remove(o.blocks.at(0));const r=-i/2,n=-s/2;for(let e=0;e<i;e++)for(let i=0;i<s;i++){const s=t.at(i).at(e);if(""==s)continue;const a=ae.fromCode(s,r+e,n+i);null!=a&&(o.add(a)||console.log("skipped:",a,o))}}}),de.registerPlugin(class extends de{#St=[];#yt=new k(!1);onEnabled(){this.#yt.Subscribe(()=>this.onHouseBlocksChanged())}getInspectorOrder(){return 100}onBuildInspector(e){const t=e.getSharedSection("View"),s=Le.Checkbox2("Show House Columns",this.#yt);t.BodyWidgets=[...t.BodyWidgets,s]}onHouseBlocksChanged(){const e=new Set(this.#St);if(this.#yt.Value)for(const t of this.houseModel.blocks)for(const[s,i]of this.#vt(t)){const t=this.#At(s,i);if(t){e.delete(t);continue}const o=this.resourceManager.getObject("column");this.scene.add(o),this.#St.push(o),o.position.set(s,0,i)}for(const t of e)X.Remove(this.#St,t),this.scene.remove(t)}#At(e,t){for(const s of this.#St){const i=s.position.x,o=s.position.z;if(!(e+1<i||e-1>i||t+1<o||t-1>o))return s}return null}#vt(e){const t=this.houseViewModel.blockToSceneObjMapping.get(e);let s=e.x,i=e.x,o=e.z,r=e.z;e.forEachCell((e,t,n)=>{s=Math.min(s,t),i=Math.max(i,t),o=Math.min(o,n),r=Math.max(r,n)});const n=e.getOrigin(),a=t.position,l=a.x-n.x,h=a.z-n.z,c=[$.toVector(s-.5,o-.5),$.toVector(i+.5,o-.5),$.toVector(i+.5,r+.5),$.toVector(s-.5,r+.5)],u=[];for(const{x:e,z:t}of c)u.push([e+l,t+h]);return u}}),de.registerPlugin(class extends de{#Mt=[new C,new C,new C,new C,new C,new C,new C,new C];async onRender(){const e=this.viewManager,s=e.dirLight.shadow.camera,i=new t;if(this.scene.traverse(e=>{if(e.isMesh&&e.castShadow){const t=e.matrixWorld;e.geometry.computeBoundingBox();const o=e.geometry.boundingBox.min,r=e.geometry.boundingBox.max;this.#Mt[0].set(o.x,o.y,o.z),this.#Mt[1].set(r.x,o.y,o.z),this.#Mt[2].set(o.x,r.y,o.z),this.#Mt[3].set(o.x,o.y,r.z),this.#Mt[4].set(r.x,r.y,o.z),this.#Mt[5].set(r.x,o.y,r.z),this.#Mt[6].set(o.x,r.y,r.z),this.#Mt[7].set(r.x,r.y,r.z);for(const e of this.#Mt)e.applyMatrix4(t),e.project(s),i.expandByPoint(e)}}),!i.isEmpty()){const t=(s.right-s.left)/2,o=(s.top-s.bottom)/2,r=(s.far-s.near)/2;s.left=s.left+t*(i.min.x+1),s.right=s.right+t*(i.max.x-1),s.top=s.top+o*(i.max.y-1),s.bottom=s.bottom+o*(i.min.y+1),s.far=s.far+r*(i.max.z-1)+1e3,s.near=s.near+r*(i.min.z+1),s.updateProjectionMatrix(),e.dirLightCameraHelper&&e.dirLightCameraHelper.update()}}}),function(e){e||(e=document.querySelector("#container"));const t=new fe(e);var s=document.createElement("img");s.style.position="absolute",s.style.right="0px",s.style.top="0px",s.style.width="100px",s.style.height="100px",s.style.opacity=.7,s.src="./assets/cuby-logo.jpg",t.mainPage.imageHost.PlatformView.appendChild(s)}();