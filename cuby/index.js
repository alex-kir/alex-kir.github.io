import{AmbientLight as e,Audio as t,AudioListener as s,AudioLoader as o,Box3 as i,BoxGeometry as n,BufferAttribute as r,BufferGeometry as a,Color as l,CubeTextureLoader as h,DirectionalLight as c,Euler as u,Float32BufferAttribute as d,GridHelper as g,Group as f,LineBasicMaterial as p,LineSegments as w,MOUSE as x,MathUtils as b,Mesh as m,MeshBasicMaterial as y,MeshPhongMaterial as S,MeshStandardMaterial as M,PCFSoftShadowMap as v,PerspectiveCamera as P,PlaneGeometry as C,Raycaster as V,RepeatWrapping as k,Scene as z,TextureLoader as T,Vector2 as L,Vector3 as W,WebGLRenderer as E}from"./threejs/three.module.js";import{FBXLoader as N}from"./threejs/addons/loaders/FBXLoader.js";import{OrbitControls as D}from"./threejs/addons/controls/OrbitControls.js";import{LineGeometry as _}from"./threejs/addons/lines/LineGeometry.js";import{LineMaterial as R}from"./threejs/addons/lines/LineMaterial.js";import{default as H}from"./threejs/addons/libs/stats.module.js";class O{Dispose(){}}class A extends O{#e;constructor(e){super(),this.#e=e}Dispose(){this.#e()}}class I extends O{#t=null;#s=!1;Add(e){this.#s?e.Dispose():(null==this.#t&&(this.#t=[]),this.#t.push(e))}Clear(){if(!this.#t||!this.#t.length)return;const e=[...this.#t];this.#t.length=0;for(const t of e)t.Dispose()}Dispose(){this.#s||(this.Clear(),this.#s=!0,this.#t=null)}}class j{#o=[];constructor(){}Subscribe(e,t=null){const s=(...t)=>e(...t);this.#o.push(s);const o=new A(()=>{this.#o=this.#o.filter(e=>e!==s)});return t&&t.Add(o),o}subscribe(e,t=null){return this.Subscribe(e,t)}subscribeAndNotify(e,t=null){return this.SubscribeAndNotify(e,t)}SubscribeAndNotify(e,t=null){const s=this.Subscribe(e,t);return e(),s}Notify(...e){this.#o.forEach(t=>t(...e))}Fire(...e){this.Notify(...e)}notify(...e){this.Notify(...e)}fire(...e){this.Notify(...e)}}class B{#i;#o=[];constructor(e){this.#i=e}get Value(){return this.#i}set Value(e){this.#i!==e&&(this.#i=e,this.#n())}Subscribe(e,t=null){const s=this.SubscribeToChanges(e,t);return e(this.#i),s}SubscribeToChanges(e,t=null){const s=(...t)=>e(...t);this.#o.push(s);const o=new A(()=>B.#r(this.#o,s));return t&&t.Add(o),o}#n(){for(const e of this.#o)e(this.#i)}static#r(e,t){var s=e.indexOf(t);s>-1&&e.splice(s,1)}}class F extends B{}class G{PlatformViewValue=new B(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}ContentValue=new B(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}SizeValue=new B([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}constructor(){this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(!e)return;const t=this.Size;e.Size=t,e.Position=[0,0]}}class U{#a=new Map;set Left(e){this.With("left",e)}set Right(e){this.With("right",e)}set Top(e){this.With("top",e)}set Bottom(e){this.With("bottom",e)}set Width(e){this.With("width",e)}set Height(e){this.With("height",e)}Add(e,t){return this.#a.set(e,t),this}With(e,t){return this.#a.set(e,t),this}Has(e){return this.#a.has(e)}GetOrDefault(e,t){return this.#a.has(e)?this.#a.get(e):t}Get(e){return this.#a.get(e)}TryGet(e){return[this.#a.has(e),this.#a.get(e)]}}class ${OnEvent(){}}class K{PlatformViewValue=new B(null);get PlatformView(){return this.PlatformViewValue.Value}set PlatformView(e){this.PlatformViewValue.Value=e}PositionValue=new B([0,0]);get Position(){return this.PositionValue.Value}set Position(e){this.PositionValue.Value=e}SizeValue=new B([0,0]);get Size(){return this.SizeValue.Value}set Size(e){this.SizeValue.Value=e}VisibleValue=new B(!0);get Visible(){return this.VisibleValue.Value}set Visible(e){this.VisibleValue.Value=e}ConstraintsValue=new B(new U);get Constraints(){return this.ConstraintsValue.Value}set Constraints(e){this.ConstraintsValue.Value=e}ThemeValue=new B(null);get Theme(){return this.ThemeValue.Value}set Theme(e){this.ThemeValue.Value=e}}class X extends K{WidgetsValue=new B(null);get Widgets(){return this.WidgetsValue.Value}set Widgets(e){this.WidgetsValue.Value=e}GesturesValue=new B(null);get Gestures(){return this.GesturesValue.Value}set Gestures(e){this.GesturesValue.Value=e}}class q extends K{static ScrollBarSize=10;ContentValue=new B(null);get Content(){return this.ContentValue.Value}set Content(e){this.ContentValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.ContentValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Content;if(e){const[,t]=e.Size,s=this.Size[0]-q.ScrollBarSize;e.Size=[s,t]}}}class Y extends K{static DefaultFontName="sans-serif";TextValue=new B("");get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new B("black");get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}TextAlignmentValue=new B([0,0]);get TextAlignment(){return this.TextAlignmentValue.Value}set TextAlignment(e){this.TextAlignmentValue.Value=e}FontSizeValue=new B(16);get FontSize(){return this.FontSizeValue.Value}set FontSize(e){this.FontSizeValue.Value=e}get TextSize(){return this.FontSizeValue.Value}set TextSize(e){this.FontSizeValue.Value=e}FontNameValue=new B(null);get FontName(){return this.FontNameValue.Value}set FontName(e){this.FontNameValue.Value=e}}class J extends K{DrawFuncValue=new B(null);get DrawFunc(){return this.DrawFuncValue.Value}set DrawFunc(e){this.DrawFuncValue.Value=e}InvalidateVisual(){const e=this.DrawFunc;this.DrawFuncValue.Value=null,this.DrawFuncValue.Value=e}}class Q{#l;constructor(e){this.#l=e}#h(e){if(Array.isArray(e)){if(3==e.length)return"#"+e[0].toString(16).padStart(2,"0")+e[1].toString(16).padStart(2,"0")+e[2].toString(16).padStart(2,"0");if(4==e.length)return"#"+e[0].toString(16).padStart(2,"0")+e[1].toString(16).padStart(2,"0")+e[2].toString(16).padStart(2,"0")+e[3].toString(16).padStart(2,"0");console.log("#ParseColor | this array not supported yet")}return e}DrawLine(e,t,s,o,i,n){const r=this.#l;r instanceof CanvasRenderingContext2D&&(r.lineWidth=i,r.strokeStyle=this.#h(n),r.beginPath(),r.moveTo(e,t),r.lineTo(s,o),r.stroke())}DrawCircle(e,t,s,o,i){const n=this.#l;n instanceof CanvasRenderingContext2D&&(n.lineWidth=o,n.strokeStyle=this.#h(i),n.beginPath(),n.ellipse(e,t,s,s,0,0,2*Math.PI),n.stroke())}DrawPath(e,t,s,o,i){const n=this.#l;if(!(n instanceof CanvasRenderingContext2D))return;const r=new Path2D;let a=0;const l=i.length,h=function(){const e=i[a];return a+=1,e};for(;a<l;)switch(h()){case"m":case"move":{const e=h(),t=h();r.moveTo(e,t);break}case"l":case"line":{const e=h(),t=h();r.lineTo(e,t);break}case"a":case"arc":{const e=h(),t=h(),s=h(),o=h(),i=h();r.arcTo(e,t,s,o,i);break}}e&&(n.fillStyle=this.#h(e),n.fill(r)),o&&(t&&r.closePath(),n.lineWidth=s,n.strokeStyle=this.#h(o),n.stroke(r))}}class Z{static CreateElement({tagName:e=null,widget:t=null,debugColor:s=null}={}){null==e&&(e="div");const o=document.createElement(e);return o._disposables=new I,o._widget=t,t.PlatformView=o,o}static SetChildrenSingle(e,t){t?Z.SetChildren(e,[t]):Z.SetChildren(e,null)}static SetChildren(e,t){const s=[];for(const o of e.children)t&&o._widget&&t.includes(o._widget)||s.push(o);for(const t of s)e.removeChild(t),t._disposables.Clear(),t._widget&&(t._widget.PlatformView=null),t._widget=null;if(t)for(let s=0;s<t.length;s++){const o=t[s];if(s<e.children.length&&e.children[s]._widget===o)continue;let i=null;for(let t=s+1;t<e.children.length;t++)if(e.children[t]._widget==o){i=e.children[t];break}if(i){e.moveBefore(i,e.children[s]);continue}const n=Z.GetView(o);s<e.children.length?e.insertBefore(n,e.children[s]):e.append(n)}}static GetView(e){if(null==e)return null;if(e instanceof G){const t=Z.CreateElement({widget:e,debugColor:"#00000010"});return t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",e.ContentValue.Subscribe(function(){Z.SetChildrenSingle(t,e.Content)},t._disposables),new ResizeObserver(function(){e.Size=[t.offsetWidth,t.offsetHeight]}).observe(t),t}if(e instanceof q){const t=Z.CreateElement({widget:e,debugColor:"#00000015"});return t.style.position="absolute",t.style["overflow-x"]="hidden",t.style["overflow-y"]="scroll",t.style["scrollbar-width"]="thin",t.style["scrollbar-color"]="#00000010 #ffffff10",this.#c(t,e),e.ContentValue.Subscribe(function(){Z.SetChildrenSingle(t,e.Content)},t._disposables),t}if(e instanceof X){const t=Z.CreateElement({widget:e,debugColor:"#ff000005"});return t.style.position="absolute",t.style.overflow="hidden",this.#c(t,e),e.WidgetsValue.Subscribe(function(){Z.SetChildren(t,e.Widgets)},t._disposables),e.GesturesValue.Subscribe(function(){Z.#u(t,e)},t._disposables),t}if(e instanceof Y){const t=Z.CreateElement({widget:e,debugColor:"#00ff0005"});return t.style.position="absolute",t.style.display="flex",t.style["font-family"]="sans-serif",t.style.overflow="hidden",t.style["white-space"]="nowrap",this.#c(t,e),e.TextValue.Subscribe(function(){t.innerText=e.Text},t._disposables),e.FontSizeValue.Subscribe(function(){t.style["font-size"]=`${e.FontSize}px`},t._disposables),e.TextColorValue.Subscribe(function(){t.style.color=e.TextColor},t._disposables),e.FontNameValue.Subscribe(()=>{t.style["font-family"]=e.FontName??Y.DefaultFontName}),e.TextAlignmentValue.Subscribe(function(){const[s,o]=e.TextAlignment;switch(s){case-1:case"start":case"left":t.style["justify-content"]="left",t.style["text-align"]="left";break;case 0:case"center":t.style["justify-content"]="center",t.style["text-align"]="center";break;case 1:case"end":case"right":t.style["justify-content"]="right",t.style["text-align"]="right"}switch(o){case-1:case"start":case"top":t.style["align-items"]="flex-start";break;case 0:case"center":t.style["align-items"]="center";break;case 1:case"end":case"bottom":t.style["align-items"]="flex-end"}},t._disposables),t}if(e instanceof J){const t=Z.CreateElement({tagName:"canvas",widget:e});return t.style.position="absolute",this.#c(t,e),e.SizeValue.Subscribe(()=>{t.width=""+2*e.Size[0],t.height=""+2*e.Size[1],Z.#d(t,e)},t._disposables),e.DrawFuncValue.Subscribe(()=>{Z.#d(t,e)},t._disposables),t}return Z.CreateElement({widget:e})}static#u(e,t){if(!(e instanceof Element))return void console.log("#SubscribeToEvents() | widget is not instance of Element");const s=t.Gestures;if(s&&s.length>0){const o=function(e){for(const o of s)o.OnEvent(e,t)},i=function(t){e.setPointerCapture(t.pointerId),o(t)},n=function(t){e.releasePointerCapture(t.pointerId),o(t)};e.onpointerdown=i,e.onpointerup=n,e.onpointercancel=o,e.onpointermove=o,e.onpointerenter=o,e.onpointerleave=o,e.onpointerout=o,e.onpointerover=o}else e.onpointerdown=null,e.onpointerup=null,e.onpointercancel=null,e.onpointermove=null,e.onpointerenter=null,e.onpointerleave=null,e.onpointerout=null,e.onpointerover=null}static#d(e,t){if(e.getContext){const s=e.getContext("2d");s.setTransform(1,0,0,1,0,0),s.scale(2,2),s.clearRect(0,0,e.width,e.height);const o=new Q(s),i=t.DrawFunc;i&&i(o,t.Size[0],t.Size[1])}}static#c(e,t){t.SizeValue.Subscribe(function(){const s=t.Size;e.style.width=`${s[0]}px`,e.style.height=`${s[1]}px`},e._disposables),t.PositionValue.Subscribe(function(){const s=t.Position;e.style.left=`${s[0]}px`,e.style.top=`${s[1]}px`},e._disposables),t.VisibleValue.Subscribe(t=>{e.hidden=!t})}}class ee{#g;constructor(e){this.#g=e}Show(e){const t=this.#g;for(;t.fisrtChild;)t.removeChild(t.lastChild);t.appendChild(Z.GetView(e))}}class te{static#f="?";static isDev(){return!0===te.#f||!1!==te.#f&&(te.#f=-1!==(document.location+"").indexOf("127.0.0.1"),te.#f&&console.log("debug.#isDebug:",te.#f),te.#f)}static log(...e){this.isDev()&&console.log(...e)}static assert(e,t){!0!==e&&this.log("assert:",e,t)}static throwUndefined(...e){if(this.isDev())for(let t=0;t<e.length;t++)if(void 0===e[t])throw this.log(...e),`undefined is not expected here [${t+1}/${e.length}]`}static throw(e){if(this.isDev())throw e}}function se(e){return Math.PI*e/180}function oe(e,t,s){switch(s){case 0:return[e,t];case 90:return function(e,t){return[t,-e]}(e,t);case 180:return function(e,t){return[-e,-t]}(e,t);case 270:return function(e,t){return[-t,e]}(e,t)}return te.throw(`unexpected rot(${e}, ${t}, ${s})`),[e,t]}function ie(e,t,s,o){const i=e-s,n=t-o;return i*i+n*n}const ne=300;class re{static fromVector(e){return{x:Math.round(e.x/ne),z:Math.round(e.z/ne)}}static toVector(e,t){return{x:e*ne,y:0,z:t*ne}}static roundVector(e){const{x:t,z:s}=this.fromVector(e);return this.toVector(t,s)}}class ae{#p;constructor(e){this.#p=e}ToArray(){return this.#p}ToList(){return this.#p}OrderBy(e){return new ae(ae.OrderBy(this.#p,e))}Select(e){return new ae(ae.Select(this.#p,e))}static Select(e,t){return e.map(t)}static OrderBy(e,t){const s=[...e];return s.sort(function(e,s){const o=t(e),i=t(s);return o<i?-1:o>i?1:0}),s}static RemoveAt(e,t){e.splice(t,1)}static Remove(e,t){var s=e.indexOf(t);return-1!==s&&(e.splice(s,1),!0)}static ToArray(e){return[...e]}}function le(e,t){let s=function(e){return e.endsWith(".csv")?"text/csv":e.endsWith(".json")?"application/json":e.endsWith(".txt")?"text/plain":"application/json"}(t);const o=new Blob([e],{type:s}),i=URL.createObjectURL(o),n=document.createElement("a");n.href=i,n.download=t,n.click(),URL.revokeObjectURL(i)}class he{#w=new N;#x=new T;#b=new h;#m=new Map;#y;#S=new Map;#M=new Map;get materials(){return this.#S}constructor(){}getObject(e){if("floor"===e)return this.#v();if("column"==e)return this.#P();if("grass"==e)return this.#C();const t=new f;return this.#V(t,e),t}async#V(e,t){this.#m.has(t)||this.#m.set(t,this.#k(t));const s=await this.#m.get(t);e.add(s.clone())}async#k(e){const t=await this.#z(e);return t.scale.set(.1,.1,.1),e.startsWith("a/")?(t.position.set(-150,0,150),t):("Window 20x18"===e&&t.position.set(0,0,50),await this.#T(t),t)}async#z(e){return e.startsWith("A13")||e.startsWith("Door")||e.startsWith("Window")||e.startsWith("Roof")?this.#w.loadAsync("assets/models/v5/"+e+".fbx"):await this.#w.loadAsync("assets/models/"+e+".fbx")}async#T(e){const t=[];e.traverse(e=>{e.isMesh&&t.push(e)});for(const e of t)e.material=await this.#L(e.material),e.castShadow=!0,e.receiveShadow=!0}#W(e){return e}async#L(e){const t=e.name;if(this.#S.has(t))return this.#S.get(t);if("M_STENI"!=t)return this.#S.set(t,e),this.#W(e);if(this.#M.has(t)){const e=await this.#M.get(t);return await e,this.#S.get(t)}let s=null;this.#M.set(t,new Promise(e=>s=e));const o=new M;return o.color.copy(e.color),o.map=e.map,o.name=e.name,o.normalMap=e.bumpMap,o.metalness=.3,o.roughness=.4,this.#W(o),o.envMap=await this.#E(),this.#S.set(t,o),s(),o}async#E(){return this.#y||(this.#y=(async()=>await this.#b.loadAsync(["assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png","assets/textures/sky-cube.png"]))()),await this.#y}#N;#D;#v(){if(this.#N||(this.#N=new n(300,10,300),this.#N.translate(0,40,0)),!this.#D){const e=this.#x.load("assets/textures/floor.jpg");e.wrapS=k,e.wrapT=k,e.repeat.set(2,2),this.#D=new S({map:e})}const e=new m(this.#N,this.#D);return e.receiveShadow=!0,e}#_;#R;#P(){return this.#_||(this.#_=new n(10,600,10),this.#_.translate(0,300,0)),this.#R||(this.#R=new y({color:0})),new m(this.#_,this.#R)}#H;#O;#C(){if(this.#H||(this.#H=new n(300,10,300),this.#H.translate(0,-6,0)),!this.#O){const e=this.#x.load("assets/textures/grass_2/grass-3.jpg");e.wrapS=k,e.wrapT=k,e.repeat.set(.5,.5),this.#O=new S({map:e})}return new m(this.#H,this.#O)}#A;async getInteriorDoorAsync(){return null==this.#A&&(this.#A=await this.#w.loadAsync("assets/models/interior/door_rama.fbx"),this.#A.traverse(e=>{e.isMesh}),this.#A.scale.set(.85,.85,.85)),this.#A.clone()}#I;async getGarageAsync(){if(!this.#I){const e=await this.#w.loadAsync("assets/models/garage/garage.fbx");e.position.set(0,0,0),e.rotation.set(se(-90),0,se(90));const t=new f;t.add(e),this.#I=t}return this.#I.clone()}}class ce{#j=[];do1(e,t,s){e(t),this.#j.push([e,t,e,s])}do2(e,t){e(null),this.#j.push([e,null,t,null])}undo(){if(this.#j.length>0){const[,,e,t]=this.#j.pop();e(t)}}undoAll(){for(;this.#j.length>0;)this.undo()}}const ue={type:"collision_pointer_hittest",handled:!1,intersections:null},de={type:"collision_pointer_enter",handled:!1,intersections:null},ge={type:"collision_pointer_exit",handled:!1,intersections:null},fe={type:"collision_pointer_move",handled:!1,intersections:null},pe={type:"collision_pointer_down",handled:!1,intersections:null},we={type:"collision_pointer_up",handled:!1,intersections:null},xe=new y({color:16711680,transparent:!0,opacity:.25});class be{#B=new ce;showDebugAnnotation=!1;#F=new V;#G=new L;#U=[];#$=null;#K=null;#X(e,t){const s=e.layerX,o=e.layerY,i=e.target.offsetWidth,n=e.target.offsetHeight;this.#G.set(s/i*2-1,1-o/n*2),this.#F.setFromCamera(this.#G,t)}#q(e,t,s){this.#X(e,s),this.#U.length=0,this.#F.intersectObject(t,!0,this.#U)}#Y(){this.#B.undoAll()}#J(){if(!this.showDebugAnnotation)return;if(!this.#U.length)return;const e=this.#U[0].object;this.#B.do1(t=>e.visible=t,!0,e.visible),this.#B.do1(t=>e.material=t,xe,e.material),e.traverseAncestors(e=>{this.#B.do1(t=>e.visible=t,!0,e.visible)})}#Q(e){return be.findIntersection(this.#U,[e])}#Z(){ue.handled=!1;for(const e of this.#U){let t=e.object;for(;null!=t;){if(t.dispatchEvent(ue),ue.handled)return t;t=t.parent}}return null}dispatchPointerMove(e,t,s){this.#Y(),this.#q(e,t,s),this.#J();const o=this.#Z();if(this.#$!==o&&(null!=this.#$&&this.#$.dispatchEvent(ge),this.#$=o,null!=this.#$&&this.#$.dispatchEvent(de)),null!=this.#K)return fe.buttons=e.buttons,fe.intersections=this.#U,fe.intersectionPoint=this.#Q(this.#K)?.point,void this.#K.dispatchEvent(fe);null!=this.#$&&(fe.buttons=e.buttons,fe.intersections=this.#U,fe.intersectionPoint=this.#Q(this.#$)?.point,this.#$.dispatchEvent(fe))}dispatchPointerDown(e,t,s){1===e.buttons&&this.#$&&(this.#q(e,t,s),pe.buttons=e.buttons,pe.intersections=this.#U,pe.intersectionPoint=this.#Q(this.#$)?.point,this.#$.dispatchEvent(pe),this.#K=this.#$)}dispatchPointerUp(e,t,s){this.#K&&(this.#q(e,t,s),we.buttons=e.buttons,we.intersections=this.#U,we.intersectionPoint=this.#Q(this.#K)?.point,this.#K.dispatchEvent(we),this.#K=null)}static findIntersection(e,t){for(const s of e){let e=s.object;for(;null!=e;){if(t.includes(e))return s;e=e.parent}}return null}}class me{get canvas(){return this.renderer.domElement}get container(){return this.renderer.domElement.parentNode}camera;audioListener=new s;scene;renderer;#ee;dirLight;dirLightCameraHelper;#te=new be;onRenderSignal=new j;#se=()=>{};constructor(t){const s=new P(45,320/240,1,1e4);s.position.set(100,2500,1500),s.lookAt(0,0,0),this.camera=s,s.add(this.audioListener);const o=new z;o.background=new l(15790320),this.scene=o;const i=new e(6316128,3);o.add(i);const n=new c(16777215,2);n.position.set(1e3,1750,500),n.castShadow=!0,n.shadow.bias=-1e-4,n.shadow.normalBias=.05,n.shadow.radius=2,n.shadow.mapSize.width=2048,n.shadow.mapSize.height=2048,n.shadow.camera.near=1,n.shadow.camera.far=1e4,n.shadow.camera.right=150,n.shadow.camera.left=-250,n.shadow.camera.top=150,n.shadow.camera.bottom=-1250,this.dirLight=n,o.add(n),this.dirLightCameraHelper&&o.add(this.dirLightCameraHelper),this.#ee&&(this.#ee.position.x=10,this.#ee.position.y=10,this.#ee.size.width=100,this.#ee.size.height=100,this.#ee.update()),this.renderer=new E({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=v,t.appendChild(this.renderer.domElement),t.addEventListener("pointermove",e=>this.#oe(e)),t.addEventListener("pointerdown",e=>this.#ie(e)),t.addEventListener("pointerup",e=>this.#ne(e)),document.addEventListener("keydown",this.#re.bind(this)),document.addEventListener("keyup",this.#ae.bind(this)),new ResizeObserver(()=>this.#le()).observe(t),this.#le(),this.renderer.setAnimationLoop(()=>this.render())}attach(e){te.assert(e instanceof at),this.#se=t=>e.forEachPlugin(t)}#oe(e){this.#te.dispatchPointerMove(e,this.scene,this.camera)}#ie(e){this.#te.dispatchPointerDown(e,this.scene,this.camera)}#ne(e){this.#te.dispatchPointerUp(e,this.scene,this.camera)}#re(e){this.#se(t=>t.onDocumentKeyDown(e))}#ae(e){this.#se(t=>t.onDocumentKeyUp(e))}#le(){const e=this.container,t=e.offsetWidth,s=e.offsetHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s),this.#ee&&(this.#ee.position.x=10,this.#ee.position.y=10,this.#ee.size.width=100,this.#ee.size.height=100,this.#ee.update()),this.render()}render(){this.onRenderSignal.Notify(),this.#se(e=>e.onRender(this)),this.renderer.render(this.scene,this.camera),this.#ee&&this.#ee.render(this.renderer)}}class ye{#he;#ce;#ue=new I;#de;#ge=!1;constructor(e,t){this.#he=e,this.#ce=t,e.WidgetsValue.Subscribe(()=>this.WidgetsChanged()),e.SizeValue.Subscribe(()=>this.Layout())}WidgetsChanged(){if(this.#ue.Clear(),this.#he.Widgets)for(const e of this.#he.Widgets)e.VisibleValue.SubscribeToChanges(()=>this.Layout(),this.#ue),e.SizeValue.SubscribeToChanges(()=>this.Layout(),this.#ue);this.Layout()}Layout(){if(this.#ge)this.#de=!0;else{this.#de=!1,this.#ge=!0;try{this.#ce(),this.#de&&this.#ce()}finally{this.#ge=!1}}}}class Se extends J{RadiusValue=new B(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new B(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new B(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new B(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}constructor(){super(),this.DrawFunc=this.#fe.bind(this);const e=this.InvalidateVisual.bind(this);this.RadiusValue.Subscribe(e),this.FillColorValue.Subscribe(e),this.StrokeColorValue.Subscribe(e),this.StrokeThicknessValue.Subscribe(e)}#fe(e,t,s){const o=this.StrokeColor?this.StrokeThickness/2:0,i=this.Radius,n=o,r=t/2,a=t-o,l=o,h=s/2,c=s-o;e.DrawPath(this.FillColor,!0,this.StrokeThickness,this.StrokeColor,["m",o,s/2,"arc",n,l,r,l,i,"arc",a,l,a,h,i,"arc",a,c,r,c,i,"arc",n,c,n,h,i])}}class Me extends ${#pe=!1;#we;#xe;#be;#me;constructor(e,{AnimateUp:t,AnimateDown:s,AnimateHover:o}){super(),this.#we=e,this.#be=s,this.#xe=t,this.#me=o}OnEvent(e,t){if(e instanceof PointerEvent){if("pointerleave"==e.type&&this.#xe&&this.#xe(),"pointermove"==e.type){const[s,o]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<o?this.#pe?this.#be&&this.#be():this.#me&&this.#me():this.#xe&&this.#xe()}if("pointerdown"==e.type)return this.#pe=!0,void(this.#be&&this.#be());if(!1!==this.#pe&&"pointerup"==e.type){this.#pe=!1,this.#xe&&this.#xe();const[s,o]=t.Size;0<=e.offsetX&&e.offsetX<s&&0<=e.offsetY&&e.offsetY<o&&this.#we()}}}}class ve extends X{static#ye=[0,0,0,0];PaddingValue=new B(ve.#ye);get Padding(){return this.PaddingValue.Value}set Padding(e){this.PaddingValue.Value=e}constructor(){super(),this.SizeValue.Subscribe(this.Layout.bind(this)),this.WidgetsValue.Subscribe(this.Layout.bind(this))}Layout(){const e=this.Widgets;if(!e||0==e.length)return;const[t,s]=this.Size;if(t<1||s<1)return;const[o,i,n,r]=this.Padding,a=t-o-n,l=s-i-r;for(const t of e){const e=t.Constraints,[s,n]=ve.CalculateSize(a,e,"width","left","right"),[r,h]=ve.CalculateSize(l,e,"height","top","bottom");t.Position=[s+o,r+i],t.Size=[n,h]}}static CalculateSize(e,t,s,o,i){const n=t.TryGet(s),r=t.TryGet(o),a=t.TryGet(i);let l=0,h=0;if(n[0])h=n[1],l=r[0]?r[1]:a[0]?e-a[1]-n[1]:(e-n[1])/2;else{const t=r[0]?r[1]:0;l=t,h=e-t-(a[0]?a[1]:0)}return[l,h]}}class Pe extends X{static#ye=[0,0,0,0];#Se;SpacingValue=new B(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}PaddingValue=new B(Pe.#ye);get Padding(){return this.PaddingValue.Value}set Padding(e){this.PaddingValue.Value=e}CollapseInvisibleValue=new B(!1);get CollapseInvisible(){return this.CollapseInvisibleValue.Value}set CollapseInvisible(e){this.CollapseInvisibleValue.Value=e}constructor(){super(),this.#Se=new ye(this,()=>this.#Me())}Layout(){this.#Se.Layout()}#Me(){const e=(this.Widgets??[]).filter(e=>e.Visible);if(!e||0==e.length)return;const[t,,s]=this.Padding;let o=t,i=Pe.CalculatePixelsPerPercent(e,this.Spacing,this.Size[0]-t-s,"width","width_proportional","left","right");for(const t of e)o+=this.#ve(t,o,i),o+=this.Spacing}#ve(e,t,s){const[,o,,i]=this.Padding;var n=e.Constraints;const[r,a]=Pe.CalculateSize(n,"width","width_proportional","left",s);var[l,h]=ve.CalculateSize(this.Size[1]-o-i,n,"height","top","bottom");return e.Position=[t+r,l],e.Size=[a,h],r+a+n.GetOrDefault("right",0)}static CalculateSize(e,t,s,o,i){let[n,r]=e.TryGet(t);return n||(r=e.GetOrDefault(s,1)*i),[e.GetOrDefault(o,0),r]}static CalculatePixelsPerPercent(e,t,s,o,i,n,r){let a=0,l=e.length>1?(e.length-1)*t:0;for(const t of e){const e=t.Constraints;l+=e.GetOrDefault(n,0)+e.GetOrDefault(r,0),e.Has(o)?l+=e.Get(o):a+=e.GetOrDefault(i,1)}var h=s-l;return h>0?h/a:0}}class Ce extends X{static#ye=[0,0,0,0];#Se;SpacingValue=new B(0);get Spacing(){return this.SpacingValue.Value}set Spacing(e){this.SpacingValue.Value=e}PaddingValue=new B(Ce.#ye);get Padding(){return this.PaddingValue.Value}set Padding(e){this.PaddingValue.Value=e}constructor(){super(),this.#Se=new ye(this,()=>this.#Me())}Layout(){this.#Se.Layout()}#Me(){const e=this.Widgets;if(!e)return;const t=e.length,[s,o,i,n]=this.Padding;let r=o;const a=this.Size[0];for(let o=0;o<t;o++){o>0&&(r+=this.Spacing);const t=e[o],n=t.Constraints,l=n.Has("height")?n.Get("height"):t.Size[1],h=n.Has("left")?n.Get("left"):0,c=n.Has("right")?n.Get("right"):0,u=n.Has("top")?n.Get("top"):0,d=n.Has("bottom")?n.Get("bottom"):0;t.Position=[h+s,r+u],t.Size=[a-h-c-s-i,l],r=r+t.Size[1]+u+d}r+=n;const[l,h]=this.Size;h!=r&&(this.Size=[l,r])}}class Ve extends ve{#Pe=new Se;#Ce=new Y;#Ve=new Se;RadiusValue=new B(0);get Radius(){return this.RadiusValue.Value}set Radius(e){this.RadiusValue.Value=e}FillColorValue=new B(null);get FillColor(){return this.FillColorValue.Value}set FillColor(e){this.FillColorValue.Value=e}StrokeColorValue=new B(null);get StrokeColor(){return this.StrokeColorValue.Value}set StrokeColor(e){this.StrokeColorValue.Value=e}StrokeThicknessValue=new B(0);get StrokeThickness(){return this.StrokeThicknessValue.Value}set StrokeThickness(e){this.StrokeThicknessValue.Value=e}TextValue=new B(null);get Text(){return this.TextValue.Value}set Text(e){this.TextValue.Value=e}TextColorValue=new B(null);get TextColor(){return this.TextColorValue.Value}set TextColor(e){this.TextColorValue.Value=e}get TextAlignment(){return this.#Ce.TextAlignment}set TextAlignment(e){this.#Ce.TextAlignment=e}get FontName(){return this.#Ce.FontName}set FontName(e){this.#Ce.FontName=e}get FontSize(){return this.#Ce.FontSize}set FontSize(e){this.#Ce.FontSize=e}ClickAction=null;Command=new j;constructor(){super(),this.Widgets=[this.#Pe,this.#Ce,this.#Ve],this.Gestures=[new Me(()=>{this.OnClick()},{AnimateDown:()=>{this.#Ve.FillColor="#00000010"},AnimateUp:()=>{this.#Ve.FillColor="#00000000"},AnimateHover:()=>{this.#Ve.FillColor="#ffffff10"}})],this.RadiusValue.Subscribe(()=>{this.#Pe.Radius=this.Radius,this.#Ve.Radius=this.Radius}),this.FillColorValue.Subscribe(()=>{this.#Pe.FillColor=this.FillColor}),this.StrokeColorValue.Subscribe(()=>{this.#Pe.StrokeColor=this.StrokeColor}),this.StrokeThicknessValue.Subscribe(()=>{this.#Pe.StrokeThickness=this.StrokeThickness}),this.TextValue.Subscribe(()=>{this.#Ce.Text=this.Text}),this.TextColorValue.Subscribe(()=>{this.#Ce.TextColor=this.TextColor})}OnClick(){this.ClickAction&&this.ClickAction(),this.Command.Notify()}}const ke="house_6x3",ze="house_3x3_lo",Te="house_3x3_hi",Le="garage_6x3",We="veranda_3x3_lo",Ee="veranda_3x3_hi";class Ne{static getWall(e,t){const s=this.#ke.get(e);for(const e of s)if(e.key==t)return e;return null}static getWalls(e){return this.#ke.get(e)}static#ke=(()=>{const e=[{key:"N1",x:-150,z:-150,a:90},{key:"N2",x:-50,z:-150,a:90},{key:"N3",x:50,z:-150,a:90},{key:"N4",x:150,z:-150,a:90},{key:"E1",x:150,z:-150,a:0},{key:"E2",x:150,z:-50,a:0},{key:"E3",x:150,z:50,a:0},{key:"E4",x:150,z:150,a:0},{key:"S1",x:150,z:150,a:270},{key:"S2",x:50,z:150,a:270},{key:"S3",x:-50,z:150,a:270},{key:"S4",x:-150,z:150,a:270},{key:"W1",x:-150,z:150,a:180},{key:"W2",x:-150,z:50,a:180},{key:"W3",x:-150,z:-50,a:180},{key:"W4",x:-150,z:-150,a:180}],t=[{key:"N1",x:-150,z:-450,a:90},{key:"N2",x:-50,z:-450,a:90},{key:"N3",x:50,z:-450,a:90},{key:"N4",x:150,z:-450,a:90},{key:"E1",x:150,z:-450,a:0},{key:"E2",x:150,z:-350,a:0},{key:"E3",x:150,z:-250,a:0},{key:"E4",x:150,z:-150,a:0},{key:"E5",x:150,z:-50,a:0},{key:"E6",x:150,z:50,a:0},{key:"E7",x:150,z:150,a:0},{key:"S1",x:150,z:150,a:270},{key:"S2",x:50,z:150,a:270},{key:"S3",x:-50,z:150,a:270},{key:"S4",x:-150,z:150,a:270},{key:"W1",x:-150,z:150,a:180},{key:"W2",x:-150,z:50,a:180},{key:"W3",x:-150,z:-50,a:180},{key:"W4",x:-150,z:-150,a:180},{key:"W5",x:-150,z:-250,a:180},{key:"W6",x:-150,z:-350,a:180},{key:"W7",x:-150,z:-450,a:180}],s=new Map;return s.set(ke,t),s.set(Te,e),s.set(ze,e),s.set(Le,t),s.set(Ee,e),s.set(We,e),s})()}class De{static#ze;static{const e=De.#ze=new Map;e.set("block|house_6x3",{id:"house_6x3",width:1,height:2,fbxName:"a/home_6x3"}),e.set("block|house_3x3_hi",{id:"house_3x3_hi",width:1,height:1,fbxName:"a/home_3x3_hi"}),e.set("block|house_3x3_lo",{id:"house_3x3_lo",width:1,height:1,fbxName:"a/home_3x3_lo"}),e.set("block|garage_6x3",{id:"garage_6x3",width:1,height:2,fbxName:"a/garage_6x3"}),e.set("block|veranda_3x3_hi",{id:"veranda_3x3_hi",width:1,height:1,fbxName:"a/veranda_3x3_hi"}),e.set("block|veranda_3x3_lo",{id:"veranda_3x3_lo",width:1,height:1,fbxName:"a/veranda_3x3_lo"}),e.set("block_shift|house_6x3",{canShift:!1,order:0}),e.set("block_shift|house_3x3_hi",{canShift:!1,order:0}),e.set("block_shift|house_3x3_lo",{canShift:!1,order:0}),e.set("block_shift|garage_6x3",{canShift:!0,order:1}),e.set("block_shift|veranda_3x3_hi",{canShift:!0,order:2}),e.set("block_shift|veranda_3x3_lo",{canShift:!0,order:2}),e.set("key|1",{id:"house_6x3",title:"1.House\n6x3"}),e.set("key|2",{id:"house_3x3_hi",title:"2.House\n3x3 Hi"}),e.set("key|3",{id:"house_3x3_lo",title:"3.House\n3x3 Lo"}),e.set("key|4",{id:"garage_6x3",title:"4.Gararage\n6x3"}),e.set("key|5",{id:"veranda_3x3_hi",title:"5.Veranda\n3x3 Hi"}),e.set("key|6",{id:"veranda_3x3_lo",title:"6.Veranda\n3x3 Lo"});const t={allowed:!0};e.set("rules|hor|202|202",t),e.set("rules|hor|203|203",t),e.set("rules|hor|204|204",t),e.set("rules|hor|205|205",t),e.set("rules|hor|207|206",t),e.set("rules|hor|208|209",t),e.set("rules|hor|209|302",t),e.set("rules|hor|209|303",t),e.set("rules|hor|209|304",t),e.set("rules|hor|209|305",t),e.set("rules|hor|302|207",t),e.set("rules|hor|302|302",t),e.set("rules|hor|302|522",t),e.set("rules|hor|302|523",t),e.set("rules|hor|302|526",t),e.set("rules|hor|302|527",t),e.set("rules|hor|303|207",t),e.set("rules|hor|303|303",t),e.set("rules|hor|303|526",t),e.set("rules|hor|303|527",t),e.set("rules|hor|304|204",t),e.set("rules|hor|304|207",t),e.set("rules|hor|304|304",t),e.set("rules|hor|304|524",t),e.set("rules|hor|304|525",t),e.set("rules|hor|304|526",t),e.set("rules|hor|304|527",t),e.set("rules|hor|305|205",t),e.set("rules|hor|305|207",t),e.set("rules|hor|305|305",t),e.set("rules|hor|305|525",t),e.set("rules|hor|305|526",t),e.set("rules|hor|305|527",t),e.set("rules|hor|522|302",t),e.set("rules|hor|522|522",t),e.set("rules|hor|523|302",t),e.set("rules|hor|523|523",t),e.set("rules|hor|524|304",t),e.set("rules|hor|524|524",t),e.set("rules|hor|525|304",t),e.set("rules|hor|525|525",t),e.set("rules|hor|528|302",t),e.set("rules|hor|528|303",t),e.set("rules|hor|528|304",t),e.set("rules|hor|528|305",t),e.set("rules|hor|529|302",t),e.set("rules|hor|529|303",t),e.set("rules|hor|529|304",t),e.set("rules|hor|529|305",t),e.set("rules|ver|203|202",t),e.set("rules|ver|204|205",t),e.set("rules|ver|205|304",t),e.set("rules|ver|206|206",t),e.set("rules|ver|207|207",t),e.set("rules|ver|208|208",t),e.set("rules|ver|209|209",t),e.set("rules|ver|302|203",t),e.set("rules|ver|302|522",t),e.set("rules|ver|302|523",t),e.set("rules|ver|303|302",t),e.set("rules|ver|303|522",t),e.set("rules|ver|303|523",t),e.set("rules|ver|303|526",t),e.set("rules|ver|303|527",t),e.set("rules|ver|303|528",t),e.set("rules|ver|303|529",t),e.set("rules|ver|304|305",t),e.set("rules|ver|305|303",t),e.set("rules|ver|305|526",t),e.set("rules|ver|523|522",t),e.set("rules|ver|524|303",t),e.set("rules|ver|524|304",t),e.set("rules|ver|524|305",t),e.set("rules|ver|524|525",t),e.set("rules|ver|525|303",t),e.set("rules|ver|525|304",t),e.set("rules|ver|525|305",t),e.set("rules|ver|526|303",t),e.set("rules|ver|526|305",t),e.set("rules|ver|526|526",t),e.set("rules|ver|527|305",t),e.set("rules|ver|527|526",t),e.set("rules|ver|527|527",t),e.set("rules|ver|528|305",t),e.set("rules|ver|528|528",t),e.set("rules|ver|529|305",t),e.set("rules|ver|529|528",t),e.set("rules|ver|529|529",t),e.set("rules|hor|202|523",t),e.set("rules|hor|203|303",t),e.set("rules|hor|204|525",t),e.set("rules|hor|205|305",t),e.set("rules|hor|303|203",t),e.set("rules|hor|303|523",t),e.set("rules|hor|523|202",t),e.set("rules|hor|523|303",t),e.set("rules|hor|525|204",t),e.set("rules|hor|525|305",t),e.set("rules|ver|205|303",t),e.set("rules|ver|205|305",t),e.set("rules|ver|303|203",t),e.set("rules|ver|305|203",t),e.set("rules|ver|305|523",t),e.set("rules|hor|527|526",t),e.set("rules|hor|528|529",t),e.set("rules|ver|206|526",t),e.set("rules|ver|207|527",t),e.set("rules|ver|208|528",t),e.set("rules|ver|209|529",t),e.set("rules|ver|526|206",t),e.set("rules|ver|527|207",t),e.set("rules|ver|528|208",t),e.set("rules|ver|529|209",t)}static findEntity(...e){if(0==e.length)return null;const t=e.join("|");return De.#ze.get(t)||null}static getEntity(...e){if(0==e.length)return null;const t=e.join("|");return De.#ze.get(t)||(console.log("CMS | entity not found | ",e),null)}static getEntities(...e){const t=e.join("|")+"|",s=[];for(const[e,o]of De.#ze)e.startsWith(t)&&s.push(o);return s}}const _e="Win100x70",Re="Win100x180",He="Win200x180",Oe="Win200x180_slave",Ae="Door";class Ie{key;x;z;a;globalPosition;globalRotation;visible;corner;window;constructor(e,t,s,o){this.key=e,this.x=t,this.z=s,this.a=o}}class je{static codeMap=[{c:303,n:ke,d:0,o:!0},{c:305,n:ke,d:180,o:!0},{c:302,n:ke,d:0,o:!1},{c:304,n:ke,d:180,o:!1},{c:303,n:"house_3x3_hi",d:0,o:!0},{c:305,n:"house_3x3_hi",d:180,o:!0},{c:302,n:"house_3x3_lo",d:0,o:!0},{c:304,n:"house_3x3_lo",d:180,o:!0},{c:203,n:"garage_6x3",d:0,o:!0},{c:207,n:"garage_6x3",d:90,o:!0},{c:205,n:"garage_6x3",d:180,o:!0},{c:209,n:"garage_6x3",d:270,o:!0},{c:202,n:"garage_6x3",d:0,o:!1},{c:206,n:"garage_6x3",d:90,o:!1},{c:204,n:"garage_6x3",d:180,o:!1},{c:208,n:"garage_6x3",d:270,o:!1},{c:523,n:"veranda_3x3_hi",d:0,o:!0},{c:527,n:"veranda_3x3_hi",d:90,o:!0},{c:525,n:"veranda_3x3_hi",d:180,o:!0},{c:529,n:"veranda_3x3_hi",d:270,o:!0},{c:522,n:"veranda_3x3_lo",d:0,o:!0},{c:526,n:"veranda_3x3_lo",d:90,o:!0},{c:524,n:"veranda_3x3_lo",d:180,o:!0},{c:528,n:"veranda_3x3_lo",d:270,o:!0}];static sosediRightLeft=[["N2","N3"],["E2","E3"],["E3","E4"],["E4","E5"],["E5","E6"],["S2","S3"],["W2","W3"],["W3","W4"],["W4","W5"],["W5","W6"]]}class Be{#Te;#Le;#We;#Ee;#Ne;#De;#_e=new Map;get slots(){return this.#_e.values()}constructor(e,t,s,o,i,n){te.throwUndefined(e,t,s,o,i,n),this.#Te=e,this.#Le=t,this.#We=s,this.#Ee=o,this.#Ne=i,this.#De=n}get name(){return this.#Te}get x(){return this.#Le}get z(){return this.#We}get width(){return this.#Ee}get height(){return this.#Ne}get direction(){return this.#De}globalPosition=re.toVector(this.x,this.z);isIntersected(e){if(e instanceof Be){let t=!1;return this.forEachCell((s,o,i)=>{e.forEachCell((e,s,n)=>{o==s&&i==n&&(t=!0)})}),t}return te.throw(`unexpected object ${e}`),!1}forEachCell(e){Be.forEachCell(this.#Le,this.#We,this.#Ee,this.#Ne,this.#De,(t,s)=>{e(this,t,s)})}static forEachCell(e,t,s,o,i,n){if(1!=s||1!=o){if(1==s&&2==o)switch(n(e,t),i){case 0:return void n(e,t-1);case 90:return void n(e+1,t);case 180:return void n(e,t+1);case 270:return void n(e-1,t)}throw`unexpected block: '${e}x${t}A${i}'`}n(e,t)}getOrigin(){return re.toVector(this.x,this.z)}getCode(e,t){return Be.getCode(this.name,this.#Le,this.#We,e,t,this.#De)}static getCode(e,t,s,o,i,n){const r=t==o&&s==i;for(const{c:t,n:s,d:o,o:i}of je.codeMap)if(s==e&&o==n&&i==r)return t;te.throw(`code not found for ${e}.${r}.${n}`)}static fromCode(e,t,s){let o="",i=0;for(const{c:t,n:s,d:n,o:r}of je.codeMap)s!=ke&&t==e&&r&&(o=s,i=n);if(""==o)return null;const{width:n,height:r}=De.getEntity("block",o),a=new Be(o,t,s,n,r,i);return a.getCode(t,s)!=e&&(console.log(a,a.getCode(),e),te.throw("codes MUST be same")),a}getSlotInfo(e){if(!this.#_e.has(e)){const t=Ne.getWall(this.name,e),s=new Ie(e,t.x,t.z,t.a);return s.window=null,s.globalPosition=new W(s.x,0,s.z),s.globalPosition.applyEuler(new u(0,se(this.direction),0)),s.globalPosition.add(this.getOrigin()),s.globalRotation=new u(0,se(s.a+this.direction),0),this.#_e.set(e,s),s}return this.#_e.get(e)}updateSlotInfo(e,t,s){const o=this.getSlotInfo(e);o.visible=t,o.corner=s,null!==s&&(o.window=null)}toggleWindowSlot(e,t){const s=this.getSlotInfo(e);s.window===t||t===He&&s.window===Oe?this.#Re(e,null):this.#Re(e,t)}#He(e){if(!e)return null;const t=e.key;for(const[e,s]of je.sosediRightLeft)if(e===t)return this.getSlotInfo(s);return null}#Oe(e){if(!e)return null;const t=e.key;for(const[e,s]of je.sosediRightLeft)if(s===t)return this.getSlotInfo(e);return null}#Re(e,t){const s=this.getSlotInfo(e);if(!s)return void console.error("#setWindowTo(slotKey, newValue)",e,t);if(null===t){switch(s.window){case Oe:{s.window=null;const e=this.#He(s);return void(e?e.window=null:console.error("WindowNames.Win200x180 (master) not found"))}case He:{s.window=null;const e=this.#Oe(s);return void(e?e.window=null:console.error("WindowNames.Win200x180 (slave) not found"))}}return void(s.window=null)}if(t==Oe)return void console.error("newValue == WindowNames.Win200x180_slave) unexpected");if(t==He){const e=this.#Oe(s);if(!e)return;this.#Re(e.key,null),this.#Re(s.key,null);const t=this.#He(s);t&&this.#Re(t.key,null);const o=this.#Oe(e);return o&&this.#Re(o.key,null),s.window=He,void(e.window=Oe)}s.window=t;const o=this.#He(s);o&&this.#Re(o.key,null);const i=this.#Oe(s);i&&this.#Re(i.key,null)}}class Fe{static create(e,t,s,o){return{x1:Math.min(e,s),z1:Math.min(t,o),x2:Math.max(e,s),z2:Math.max(t,o)}}static getLength(e){const t=Math.abs(e.x2-e.x1),s=Math.abs(e.z2-e.z1);return Math.max(t,s)}static getDir(e,t,s,o){return e===s?t===o?null:"ver":t===o?"hor":null}static isIntersected(e,t){return!(e.x2<=t.x1||t.x2<=e.x1||e.z2<=t.z1||t.z2<=e.z1)}static subtract(e,t){const s=[];if(e.x2<=t.x1||e.x1>=t.x2||e.z2<=t.z1||e.z1>=t.z2)return[e];if(e.x1<t.x1&&s.push({x1:e.x1,z1:e.z1,x2:t.x1,z2:e.z2}),e.x2>t.x2&&s.push({x1:t.x2,z1:e.z1,x2:e.x2,z2:e.z2}),e.z1<t.z1){const o=Math.max(e.x1,t.x1),i=Math.min(e.x2,t.x2);o<=i&&s.push({x1:o,z1:e.z1,x2:i,z2:t.z1})}if(e.z2>t.z2){const o=Math.max(e.x1,t.x1),i=Math.min(e.x2,t.x2);o<=i&&s.push({x1:o,z1:t.z2,x2:i,z2:e.z2})}return s}static union(e,t){return{x1:Math.min(e.x1,t.x1),z1:Math.min(e.z1,t.z1),x2:Math.max(e.x2,t.x2),z2:Math.max(e.z2,t.z2)}}static areWallsCanHealed(e,t){return e.z1===e.z2&&e.z1===t.z1&&e.z1===t.z2?!(e.x2<t.x1||t.x2<e.x1):!(e.x1!==e.x2||e.x1!==t.x1||e.x1!==t.x2||e.z2<t.z1||t.z2<e.z1)}}function Ge(e){return 10*Math.floor(e/10)}function Ue(e){return 20*Math.floor(e/20)}class $e{x1;z1;x2;z2;collider0;colliderParallel;#Ae=null;get dir(){return this.#Ae}constructor({x1:e,z1:t,x2:s,z2:o}){if(s<e&&([e,s]=[s,e]),o<t&&([t,o]=[o,t]),Ge(e)!==e)throw`InterWall2Info() - round - ${e}`;if(Ge(t)!==t)throw`InterWall2Info() - round - ${t}`;if(Ge(s)!==s)throw`InterWall2Info() - round - ${s}`;if(Ge(o)!==o)throw`InterWall2Info() - round - ${o}`;if(this.x1=e,this.z1=t,this.x2=s,this.z2=o,this.#Ae=Fe.getDir(e,t,s,o),"hor"===this.#Ae)this.collider0={x1:e,z1:t-10,x2:s,z2:o+10},this.colliderParallel={x1:e,z1:t-21,x2:s,z2:o+21};else{if("ver"!==this.#Ae)throw"InteriorItemBase() - dir";this.collider0={x1:e-10,z1:t,x2:s+10,z2:o},this.colliderParallel={x1:e-21,z1:t,x2:s+21,z2:o}}}}class Ke extends $e{constructor({x1:e,z1:t,x2:s,z2:o}){if(super({x1:e,z1:t,x2:s,z2:o}),this.x2-this.x1<20&&this.z2-this.z1<20)throw`InteriorWallInfo() - min length ${this.x1}, ${this.z1}, ${this.x2}, ${this.z2}`}}class Xe extends $e{constructor({x1:e,z1:t,x2:s,z2:o}){super({x1:e,z1:t,x2:s,z2:o})}}class qe{static round1=Ge;static round2=Ue;wallsSignal=new j;doorsSignal=new j;#Ie=[];get walls(){return this.#Ie}#je=[];get doors(){return this.#je}canAddWall(e,t,s,o){const i=Fe.getDir(e,t,s,o);if(null==i)throw"canAddWall() - dir";const n=Fe.create(e,t,s,o);for(const e of this.#Ie)if(!Fe.areWallsCanHealed(e,n)&&e.dir===i&&Fe.isIntersected(e.colliderParallel,n))return!1;return!0}addWall(e,t,s,o){if(!this.canAddWall(e,t,s,o))return;const i=Fe.getDir(e,t,s,o);if(null==i)return;const n=Fe.create(e,t,s,o);let r=!1;for(let e=0;e<this.#je.length;e++){const t=this.#je[e];Fe.isIntersected(t.collider0,n)&&(this.#je[e]=null,this.walls.push(new Ke(t)),r=!0)}r&&(this.#je=this.#je.filter(e=>null!=e),this.doorsSignal.notify());const a=["hor"===i?Fe.create(e,t-1,s,o+1):Fe.create(e-1,t,s+1,o)];for(const e of this.#Ie){if(e.dir===i)continue;const t=[];for(const s of a)t.push(...Fe.subtract(s,e.collider0));a.length=0,a.push(...t.filter(e=>Fe.getLength(e)>=20))}for(const n of a)"hor"===i?this.#Ie.push(new Ke({x1:n.x1,z1:t,x2:n.x2,z2:o})):"ver"==i&&this.#Ie.push(new Ke({x1:e,z1:n.z1,x2:s,z2:n.z2}));this.#Be(),this.wallsSignal.notify()}hasAnyAtPoint(e,t){const s=Fe.create(e-1,t-1,e+1,t+1);for(const e of this.#Ie)if(Fe.isIntersected(s,e))return!0;for(const e of this.#je)if(Fe.isIntersected(s,e))return!0;return!1}removeAt(e,t){const s=Fe.create(e-1,t-1,e+1,t+1);for(const e of this.#Ie)if(Fe.isIntersected(s,e))return ae.Remove(this.#Ie,e),void this.wallsSignal.notify()}onBlocksChanged(e){const t=new Set;for(const e of this.#Ie){const s=re.fromVector({x:e.x1,z:e.z1}),o=re.fromVector({x:e.x2,z:e.z2});for(let e=s.x;e<=o.x;e++)t.add(`${e};${s.z}`);for(let e=s.z;e<=o.z;e++)t.add(`${s.x};${e}`)}const s=new Set;e.forEach(e=>{e.forEachCell((e,t,o)=>{s.add(`${t};${o}`)})});const o=t.difference(s);if(0===o.size)return;const i=[...this.#Ie],n=[];for(const e of o){const[t,s]=e.split(";"),o=re.toVector(t,s),r={x1:o.x-150,z1:o.z-150,x2:o.x+150,z2:o.z+150};n.length=0;for(const e of i){const t=Fe.subtract(e,r);n.push(...t)}i.length=0,i.push(...n)}this.#Ie.length=0;for(const e of i)e instanceof Ke?this.#Ie.push(e):this.#Ie.push(new Ke(e));this.wallsSignal.notify()}canToggleDoor(e,t,s){const o="hor"==s?Fe.create(e-40-1,t-1,e+50+1,t+1):Fe.create(e-1,t-40-1,e+1,t+50+1);for(const e of this.#je)if(Fe.isIntersected(e,o))return[!1,e.dir];const i=Fe.create(e-1,t-1,e+1,t+1);for(const e of this.#Ie)if(Fe.isIntersected(e,i))return[!0,e.dir];return[!1,null]}toogleDoor(e,t,s){const o="hor"==s?Fe.create(e-40-1,t-1,e+50+1,t+1):Fe.create(e-1,t-40-1,e+1,t+50+1);for(const e of this.#je)if(Fe.isIntersected(e,o))return ae.Remove(this.#je,e),this.walls.push(new Ke(e)),this.wallsSignal.notify(),void this.doorsSignal.notify();const[i,n]=this.canToggleDoor(e,t);if(!i||s!=n)return;const r="hor"==s?Fe.create(e-40,t-10,e+50,t+10):Fe.create(e-10,t-40,e+10,t+50),a=[];for(const e of this.#Ie){if(!Fe.isIntersected(e,r)){a.push(e);continue}const t=Fe.subtract(e,r);for(const e of t)(e.x2-e.x1>=20||e.z2-e.z1>=20)&&a.push(e)}this.#Ie.length=0;for(const e of a)e instanceof Ke?this.#Ie.push(e):this.#Ie.push(new Ke(e));"hor"===s?this.#je.push(new Xe(Fe.create(e-40,t,e+50,t))):"ver"===s&&this.#je.push(new Xe(Fe.create(e,t-40,e,t+50))),this.wallsSignal.notify(),this.doorsSignal.notify()}#Be(){const e=[...this.#Ie];let t=!1;for(let s=0;s<e.length;s++){let o=e[s];if(null!=o)for(let i=0;i<e.length;i++){if(s==i)continue;let n=e[i];null!=n&&Fe.areWallsCanHealed(o,n)&&(o=new Ke(Fe.union(o,n)),e[s]=o,e[i]=null,t=!0)}}t&&(this.#Ie=e.filter(e=>null!=e),this.wallsSignal.notify())}}function Ye(e,t,s,o){t.add(e),s.push(e);const i=function(e,t){const s=[];for(const o of t)e!==o&&Je(e,o)&&s.push(o);return s}(e,o);for(const n of i)t.has(n)||n.name!==e.name||Ye(n,t,s,o)}function Je(e,t){const s=(e.x+e.width===t.x||t.x+t.width===e.x)&&e.y<t.y+t.height&&e.y+e.height>t.y,o=(e.y+e.height===t.y||t.y+t.height===e.y)&&e.x<t.x+t.width&&e.x+e.width>t.x;return s||o}function Qe(e,t){const s=[];return e.y<t.y+t.height&&e.y+e.height>t.y&&(e.x+e.width===t.x&&s.push("right"),t.x+t.width===e.x&&s.push("left")),e.x<t.x+t.width&&e.x+e.width>t.x&&(e.y+e.height===t.y&&s.push("down"),t.y+t.height===e.y&&s.push("up")),s}function Ze(e,t){const s=new Set;for(const o of e)for(const e of t){const t=Qe(o,e);for(const e of t)s.add(e)}return[...s]}function et(e,t){const s=new Set;for(const o of t){const t=Ze(e,o);for(const e of t)s.add(e)}return[...s]}class tt{#Fe=[];get blocks(){return this.#Fe}blocksChanged=new j;#Ge=new qe;get interior(){return this.#Ge}constructor(){}canAdd2(e,t,s,o){const{width:i,height:n}=De.getEntity("block",e);let r=!1;const a=[];if(Be.forEachCell(t,s,i,n,o,(i,n)=>{null!=this.find(i,n)&&(r=!0);const l=Be.getCode(e,t,s,i,n,o);a.push([l,i,n])}),r)return!1;const l=[...a,...tt.getCellsForValidate(this.#Fe)];return tt.validateCells(l)}addNew(e,t,s,o){const{width:i,height:n}=De.getEntity("block",e);if(this.canAdd2(e,t,s,o)){const r=new Be(e,t,s,i,n,o);return this.#Fe.push(r),this.#Ue(),tt.#$e(this.#Fe),this.interior.onBlocksChanged(this.#Fe),this.blocksChanged.Notify(),r}return null}remove(e){const t=ae.Remove(this.#Fe,e);return t&&(this.#Ue(),tt.#$e(this.#Fe),this.interior.onBlocksChanged(this.#Fe),this.blocksChanged.Notify()),t}setWindowSlot(e,t,s){e.toggleWindowSlot(t,s),this.interior.onBlocksChanged(this.#Fe),this.blocksChanged.Notify()}find(e,t){for(const s of this.#Fe){let o=!1;if(s.forEachCell((s,i,n)=>{i==e&&n==t&&(o=!0)}),o)return s}return null}printUndefinedRules(){tt.#Ke.clear(),tt.#Xe(this.#Fe);const e=[...tt.#Ke].join("\n");return console.log(e),e}#Ue(){const e=(e,t,s)=>{const[o,i]=oe(t,s,e.direction),[n,r]=[e.x+o,e.z+i];return this.find(n,r)},t=(t,s,o,i)=>{const n=e(t,s,o);return!!n&&-1!==i.indexOf(n.name)},s=(e,t)=>e?"internal":t?null:"external",o=(e,t)=>e?t?null:"internal2":t?"internal":null,i=[ze,Te,ke];for(const e of this.#Fe)if(te.assert(1===e.width),e.name==ze||e.name==Te){const o=t(e,-1,0,i),n=t(e,-1,-1,i),r=t(e,0,-1,i),a=t(e,1,-1,i),l=t(e,1,0,i),h=t(e,1,0,i),c=t(e,1,1,i),u=t(e,0,1,i),d=t(e,-1,1,i),g=t(e,-1,0,i);e.updateSlotInfo("N1",!r,s(n,o)),e.updateSlotInfo("N2",!r,null),e.updateSlotInfo("N3",!r,null),e.updateSlotInfo("N4",!r,s(a,l)),e.updateSlotInfo("E1",!l,s(a,r)),e.updateSlotInfo("E2",!l,null),e.updateSlotInfo("E3",!h,null),e.updateSlotInfo("E4",!h,s(c,u)),e.updateSlotInfo("S1",!u,s(c,h)),e.updateSlotInfo("S2",!u,null),e.updateSlotInfo("S3",!u,null),e.updateSlotInfo("S4",!u,s(d,g)),e.updateSlotInfo("W1",!g,s(d,u)),e.updateSlotInfo("W2",!g,null),e.updateSlotInfo("W3",!o,null),e.updateSlotInfo("W4",!o,s(n,r))}else if(e.name==ke){const n=t(e,-1,-1,i),r=t(e,-1,-2,i),a=t(e,0,-2,i),l=t(e,1,-2,i),h=t(e,1,-1,i),c=t(e,1,0,i),u=t(e,1,1,i),d=t(e,0,1,i),g=t(e,-1,1,i),f=t(e,-1,0,i);e.updateSlotInfo("N1",!a,s(r,n)),e.updateSlotInfo("N2",!a,null),e.updateSlotInfo("N3",!a,null),e.updateSlotInfo("N4",!a,s(l,h)),e.updateSlotInfo("E1",!h,s(l,a)),e.updateSlotInfo("E2",!h,null),e.updateSlotInfo("E3",!h,null),e.updateSlotInfo("E4",!h||!c,o(h,c)),e.updateSlotInfo("E5",!c,null),e.updateSlotInfo("E6",!c,null),e.updateSlotInfo("E7",!c,s(u,d)),e.updateSlotInfo("S1",!d,s(u,c)),e.updateSlotInfo("S2",!d,null),e.updateSlotInfo("S3",!d,null),e.updateSlotInfo("S4",!d,s(g,f)),e.updateSlotInfo("W1",!f,s(g,d)),e.updateSlotInfo("W2",!f,null),e.updateSlotInfo("W3",!f,null),e.updateSlotInfo("W4",!f||!n,o(f,n)),e.updateSlotInfo("W5",!n,null),e.updateSlotInfo("W6",!n,null),e.updateSlotInfo("W7",!n,s(r,a))}}static getCellsForValidate(e){const t=[];for(const s of e)s instanceof Be&&s.forEachCell(function(e,s,o){t.push([e.getCode(s,o),s,o])});return t}static validateCells(e){const t=new Map;let s=!0;const o=tt.validatePlacementDefaults;for(const[i,n,r]of e){const e=-r;t.has(`${n-1}:${e}`)&&(tt.#qe(t.get(`${n-1}:${e}`),i,"hor",o)||(s=!1)),t.has(`${n+1}:${e}`)&&(tt.#qe(i,t.get(`${n+1}:${e}`),"hor",o)||(s=!1)),t.has(`${n}:${e-1}`)&&(tt.#qe(t.get(`${n}:${e-1}`),i,"ver",o)||(s=!1)),t.has(`${n}:${e+1}`)&&(tt.#qe(i,t.get(`${n}:${e+1}`),"ver",o)||(s=!1)),t.set(`${n}:${e}`,i)}return s}static#Xe(e){const t=this.getCellsForValidate(e);return this.validateCells(t)}static validatePlacementDefaults=!1;static#Ke=new Set;static#qe(e,t,s,o){if(e&&t){const o=De.findEntity("rules",s,e,t);if(o)return o.allowed;const i=`${s}|${e}|${t}`;tt.#Ke.add(i)}return o}static#$e(e){const t=[];e.forEach(e=>{e instanceof Be&&e.forEachCell((s,o,i)=>{const{order:n}=De.getEntity("block_shift",e.name);t.push({block:e,x:o,y:i,width:1,height:1,name:`${n}`,order:n})})});const s=function(e){const t=new Set,s=[];for(const o of e)if(!t.has(o)){const i=[];Ye(o,t,i,e),s.push(i)}return s}(ae.OrderBy(t,e=>e.order));for(let e=0;e<s.length;e++){const t=s.slice(0,e),o=s[e],i=et(o,t);let n=0,r=0;for(const e of i)switch(e){case"left":n+=42.5;break;case"right":n-=42.5;break;case"up":r+=42.5;break;case"down":r-=42.5}for(const{block:e}of o){const t=e,{x:s,z:o}=re.toVector(t.x,t.z);t.globalPosition={x:s+n,y:0,z:o+r}}}}}class st{#Ye=new B;get activeTool(){return this.#Ye}activeBlockName;activeDirection=0;activeToolChanged=new j;constructor(){this.activeTool.SubscribeToChanges(()=>{this.#Je()})}setDirection(e){this.activeDirection!==e&&(this.activeDirection=e,this.#Qe(),this.#Je())}rotateLeft(){switch(this.activeDirection){case 0:this.activeDirection=270;break;case 90:this.activeDirection=0;break;case 180:this.activeDirection=90;break;case 270:this.activeDirection=180}this.#Qe(-1),this.#Je()}rotateRight(){switch(this.activeDirection){case 0:this.activeDirection=90;break;case 90:this.activeDirection=180;break;case 180:this.activeDirection=270;break;case 270:this.activeDirection=0}this.#Qe(),this.#Je()}#Qe(e){if(this.activeBlockName&&this.activeBlockName.startsWith("house_"))if(-1===e)switch(this.activeDirection){case 90:this.activeDirection=0;break;case 270:this.activeDirection=180}else switch(this.activeDirection){case 90:this.activeDirection=180;break;case 270:this.activeDirection=0}}setBlockName(e){this.activeBlockName!==e&&(this.activeBlockName=e,this.#Qe(),this.#Je())}#Je(){this.activeToolChanged.notify()}}class ot extends Ce{static#Ze="";static#et="";#tt;#st;#ot;HeaderTitleValue=new B;get HeaderTitle(){return this.HeaderTitleValue.Value}set HeaderTitle(e){this.HeaderTitleValue.Value=e}get BodyWidgets(){return this.#ot.Widgets}set BodyWidgets(e){this.#ot.Widgets=e}constructor(){super();const e=new Ve;e.Command.Subscribe(()=>{this.#it()});const t=this.#tt=new Y;t.TextAlignment=[-1,0],t.FontSize=20;const s=new Se;s.Constraints.With("height",1).With("bottom",0),s.FillColor="#ccc";const o=this.#st=new ve;o.Constraints.With("height",48),o.Widgets=[t,s,e];const i=this.#ot=new Ce;i.Padding=[8,4,0,16],i.Spacing=4,this.Widgets=[o,i],this.HeaderTitleValue.Subscribe(()=>this.#nt())}#it(){1==this.Widgets.length?this.Widgets=[this.#st,this.#ot]:this.Widgets=[this.#st],this.#nt()}#nt(){1==this.Widgets.length?this.#tt.Text=ot.#et+" "+this.HeaderTitle:this.#tt.Text=ot.#Ze+" "+this.HeaderTitle}}class it{pluginSections=[];#rt=[];addSection(e){this.pluginSections.push(e)}addNewSection(e,...t){const s=new ot;s.HeaderTitle=e,s.BodyWidgets=[...t],this.addSection(s)}getSharedSection(e){const t=this.#rt.find(t=>t.HeaderTitle==e);if(t)return t;const s=new ot;return s.HeaderTitle=e,s.BodyWidgets=[],this.pluginSections.push(s),this.#rt.push(s),s}appendToSharedSection(e,t){const s=this.getSharedSection(e);s.BodyWidgets=[...s.BodyWidgets,t]}}class nt{static registeredPluginClasses=[];#ue=new I;#at=null;get rootViewModel(){return this.#at}get initialized(){return null!=this.#at}get viewManager(){return this.#at.sceneManager}get sceneManager(){return this.#at.sceneManager}get scene(){return this.sceneManager.scene}get houseViewModel(){return this.#at.houseViewModel}get toolsModel(){return this.#at.toolsModel}get houseModel(){return this.#at.houseModel}get resourceManager(){return this.#at.resourceManager}onSceneCreated(e){te.assert(e instanceof at,"onSceneCreated | rootViewModel"),te.assert(!this.initialized,"onSceneCreated | initialized"),this.#at=e,this.onEnabled(this.#ue),this.houseModel.blocksChanged.subscribeAndNotify(()=>this.onHouseBlocksChanged(),this.#ue)}onEnabled(e){te.assert(e instanceof I)}onHouseBlocksChanged(){}onRender(){}onPointerMove(e,t){te.throwUndefined(e,t)}onPointerDown(e,t){te.throwUndefined(e,t)}onDocumentKeyDown(e){te.throwUndefined(e)}onDocumentKeyUp(e){te.throwUndefined(e)}getInspectorOrder(){return 0}onBuildInspector(e){te.assert(e instanceof it)}static registerPlugin(e){nt.registeredPluginClasses.push(e)}}class rt extends G{#j;view3dHost;imageHost;constructor(){super();const e=new X,t=new X;t.Constraints.With("top",0),t.Constraints.With("right",0),t.Constraints.With("width",100),t.Constraints.With("height",100);const s=new ve;s.Widgets=[e,t];const o=this.#j=new Ce;o.Padding=[8,8,8,32];const i=new q;i.Constraints.With("width",300),i.Content=o;const n=new Se;n.Constraints.With("width",5),n.FillColor="#ccc";const r=new Pe;r.Widgets=[s,n,i],this.view3dHost=e,this.imageHost=t,this.Content=r}attach(e){te.assert(e instanceof at);const t=new ae(e.plugins).OrderBy(e=>e.getInspectorOrder()).ToList(),s=new it;for(const e of t)e.onBuildInspector(s);this.#j.Widgets=[...s.pluginSections]}}class at{resourceManager;sceneManager;mainPage;sharedShowWalls=new F(!0);#lt=[];get plugins(){return this.#lt}#ht=new st;get houseViewModel(){return this.#ht}get toolsModel(){return this.#ht}#ct=new tt;get houseModel(){return this.#ct}constructor(e){this.mainPage=new rt,new ee(e).Show(this.mainPage),this.resourceManager=new he,this.sceneManager=new me(this.mainPage.view3dHost.PlatformView),this.loadPlugins(),this.forEachPlugin(e=>e.onSceneCreated(this)),this.sceneManager.attach(this),this.mainPage.attach(this)}loadPlugins(){for(const e of nt.registeredPluginClasses)this.#lt.push(new e)}forEachPlugin(e){for(const t of this.#lt)e(t)}}nt.registerPlugin(class extends nt{#ut;#dt;onEnabled(e){const t=new D(this.sceneManager.camera,this.sceneManager.renderer.domElement);t.minDistance=100,t.maxDistance=7e3,t.minPolarAngle=se(0),t.maxPolarAngle=se(90),t.target.set(0,0,0),t.mouseButtons={RIGHT:x.ROTATE,MIDDLE:x.PAN},t.update(),this.#ut=t,this.toolsModel.activeToolChanged.Subscribe(()=>this.#gt(),e)}#gt(){const e=this.toolsModel?.activeTool?.Value?.category??"";if(this.#dt!==e&&(this.#dt=e,"interior"===e)){const e=[],t=[];this.houseModel.blocks.forEach(s=>s.forEachCell((s,o,i)=>{e.push(o),t.push(i)})),0==e.length&&e.push(0),0==t.length&&t.push(0);const s=(Math.min(...e)+Math.max(...e))/2,o=(Math.min(...t)+Math.max(...t))/2,i=re.toVector(s,o),n={x:i.x,y:i.y+1950,z:i.z+100};this.#ft(n,i,200)}}#ft(e,t,s=1e3){const o=this.#ut,i=this.#ut.object;o.enabled=!1;const n=i.position.clone(),r=o.target.clone(),a=performance.now(),l=()=>{const h=Math.min((performance.now()-a)/s,1);i.position.lerpVectors(n,e,h),o.target.lerpVectors(r,t,h),o.update(),h<1?requestAnimationFrame(l):(i.position.copy(e),o.target.copy(t),o.enabled=!0)};l()}});class lt{#pt=[];get objects(){return this.#pt}#wt;constructor(e){this.#wt=e}add(e){this.#pt.push(e),this.#wt&&this.#wt.add(e)}remove(e){ae.Remove(this.#pt,e),this.#wt&&this.#wt.remove(e)}clear(){this.removeAll()}removeAll(){for(const e of this.#pt)this.#wt.remove(e);this.#pt.length=0}setScene(e){if(e!==this.#wt){if(this.#wt)for(const e of this.#pt)this.#wt.remove(e);if(this.#wt=e,this.#wt)for(const e of this.#pt)this.#wt.add(e)}}}nt.registerPlugin(class extends nt{#xt=new lt;onEnabled(e){this.#xt.setScene(this.scene),this.rootViewModel.sharedShowWalls.Subscribe(()=>this.onHouseBlocksChanged(),e)}async onHouseBlocksChanged(){if(this.#xt.clear(),this.rootViewModel.sharedShowWalls.Value)for(const e of this.houseModel.blocks)if(e.name===Le){const t=await this.resourceManager.getGarageAsync();t.position.copy(e.globalPosition),t.rotation.set(0,se(-e.direction),0),this.#xt.add(t)}}});class ht{static Text(e){const t=new Y;return t.Text=e,t.TextAlignment=[-1,0],t.Constraints.With("height",32),t}static Button(e,t){const s=new Ve;return s.Radius=6,s.StrokeColor="#ccc",s.StrokeThickness=1,s.Text=e,s.Constraints.With("height",32),s.Command.Subscribe(()=>t(s)),s}static Checkbox(e,t,s){const o=" "+e,i=" "+e,n=new Ve;return n.Text=t?o:i,n.TextAlignment=[-1,0],n.Constraints.With("height",32),n.Command.Subscribe(()=>{const e=s();!0===e&&(n.Text=o),!1===e&&(n.Text=i)}),n}static Checkbox2(e,t){if(t instanceof B)return this.Checkbox(e,t.Value,()=>(t.Value=!t.Value,t.Value))}static Radiobox(e,t,s){const o=" "+e,i=" "+e,n=new Ve;return n.TextAlignment=[-1,0],n.Constraints.With("height",32),n.Command.Subscribe(()=>{s.Value=t}),s.Subscribe(()=>{n.Text=s.Value==t?o:i}),n}static Header(e){const t=new Y;return t.Constraints.With("height",32),t.Text=e,t.TextAlignment=[-1,0],t}static Hotkey(e){const t=new Y;return t.Constraints.Height=20,t.Constraints.Bottom=-20,t.Text=`key: ${e}`,t.TextAlignment=[1,0],t.FontSize=10,t}}nt.registerPlugin(class extends nt{#bt=new B(!1);blockToSceneObjMapping=new Map;onEnabled(e){this.#bt.Subscribe(()=>this.#mt(),e),this.rootViewModel.sharedShowWalls.Subscribe(()=>this.#mt(),e)}onBuildInspector(e){const t=e.getSharedSection("View"),s=ht.Checkbox2("Transparent",this.#bt);t.BodyWidgets=[...t.BodyWidgets,s]}onHouseBlocksChanged(){const e=this.blockToSceneObjMapping;for(const e of this.houseModel.blocks)this.#yt(e);this.#St();const t=[];for(const s of e.keys())this.houseModel.blocks.includes(s)||t.push(s);for(const s of t){const t=e.get(s);e.delete(s),this.scene.remove(t)}}#yt(e){const t=this.blockToSceneObjMapping;if(t.has(e))return t.get(e);const{fbxName:s}=De.getEntity("block",e.name),o=this.resourceManager.getObject(s);return o.rotation.set(0,se(-e.direction),0),t.set(e,o),this.scene.add(o),this.#mt(),o}#St(){this.houseModel.blocks.forEach(e=>{this.#yt(e).position.copy(e.globalPosition)})}#mt(){const e=this.blockToSceneObjMapping;for(const[t,s]of e){let e=.5,o=!0;switch(t.name){case ke:case Te:case ze:case Le:o=!this.rootViewModel.sharedShowWalls.Value}s.traverse(t=>{if(t.isMesh){const s=t.material.clone();s.opacity=this.#bt.Value?e:1,s.transparent=this.#bt.Value,t.material=s}}),s.visible=o}}});class ct{static roofs=(()=>{const e=[1,-1,!1],t=[1,0,!1],s=[-1,1,!1],o=[0,1,!1],i=[1,1,!1],n=[1,0,!0],r=[0,1,!0],a=[1,1,!0],l="Roof 6m full",h="Roof 6m cuted",c="Roof 3m high full",u="Roof 3m high cuted",d="Roof 3m low full",g="Roof 3m low cuted";return new Map([["house_6x3",[{fbx:l,pos:{x:-150,z:-450},degree:270,rules:[o,s,[-1,0,!1]]},{fbx:l,pos:{x:-150,z:-450},degree:270,rules:[o,s,[-1,0,!0]]},{fbx:h,pos:{x:-150,z:-450},degree:270,rules:[r]},{fbx:h,pos:{x:-150,z:-450},degree:270,rules:[o,[-1,1,!0]]},{fbx:l,pos:{x:50,z:-450},degree:270,rules:[o]},{fbx:h,pos:{x:50,z:-450},degree:270,rules:[r]},{fbx:l,pos:{x:-50,z:-450},degree:270,rules:[o]},{fbx:h,pos:{x:-50,z:-450},degree:270,rules:[r]},{fbx:h,pos:{x:150,z:-450},degree:270,rules:[r,t]},{fbx:h,pos:{x:150,z:-450},degree:270,rules:[r,n,e]},{fbx:h,pos:{x:150,z:-450},degree:270,rules:[o,a,t]},{fbx:h,pos:{x:150,z:-450},degree:270,rules:[o,a,n,e]},{fbx:l,pos:{x:150,z:-450},degree:270,rules:[o,i,n,e]},{fbx:l,pos:{x:150,z:-450},degree:270,rules:[o,i,t]}]],["house_3x3_hi",[{fbx:c,pos:{x:150,z:-150},degree:270,rules:[o,t]},{fbx:c,pos:{x:50,z:-150},degree:270,rules:[o]},{fbx:c,pos:{x:-50,z:-150},degree:270,rules:[o]},{fbx:c,pos:{x:-150,z:-150},degree:270,rules:[o,s]},{fbx:u,pos:{x:150,z:-150},degree:270,rules:[r]},{fbx:u,pos:{x:50,z:-150},degree:270,rules:[r]},{fbx:u,pos:{x:-50,z:-150},degree:270,rules:[r]},{fbx:u,pos:{x:-150,z:-150},degree:270,rules:[r]}]],["house_3x3_lo",[{fbx:d,pos:{x:150,z:-150},degree:270,rules:[o,t]},{fbx:d,pos:{x:50,z:-150},degree:270,rules:[o]},{fbx:d,pos:{x:-50,z:-150},degree:270,rules:[o]},{fbx:d,pos:{x:-150,z:-150},degree:270,rules:[o,s]},{fbx:g,pos:{x:150,z:-150},degree:270,rules:[r]},{fbx:g,pos:{x:50,z:-150},degree:270,rules:[r]},{fbx:g,pos:{x:-50,z:-150},degree:270,rules:[r]},{fbx:g,pos:{x:-150,z:-150},degree:270,rules:[r]}]]])})();static floors=(()=>{const e="floor";return new Map([["house_6x3",[{fbx:e,pos:{x:0,z:0},degree:270,rules:[]},{fbx:e,pos:{x:0,z:-300},degree:270,rules:[]}]],["house_3x3_hi",[{fbx:e,pos:{x:0,z:0},degree:270,rules:[]}]],["house_3x3_lo",[{fbx:e,pos:{x:0,z:0},degree:270,rules:[]}]]])})();static#Mt=new Map([["N1",{norm:null,extern:"PNL 3877 CR.D"}],["N2",{norm:"PNL 3877",win1950:"PNL 1227 UP + 1950 DWN"}],["N3",{norm:"PNL 3877",win1950:"PNL 1227 UP + 1950 DWN"}],["N4",{norm:"PNL 3877",extern:"PNL 3877 CL.D"}],["E1",{norm:null,extern:"PNL 4024 CL.E"}],["E2",{norm:"PNL 4292 E12",win1950:"PNL 1642 UP + 1950 DWN E12"}],["E3",{norm:"PNL 4560 E11",win1950:"PNL 1910 UP + 1950 DWN E11"}],["E4",{norm:"PNL 4828 E10",extern:"PNL 4748 CR.E",intern:"PNL 4681 ICR.E"}],["S1",{norm:null,extern:"PNL 4748 CR.D",intern:"PNL 4748 ICR.D"}],["S2",{norm:"PNL 4748",win1950:"PNL 2098 UP + 1950 DWN"}],["S3",{norm:"PNL 4748",win1950:"PNL 2098 UP + 1950 DWN"}],["S4",{norm:"PNL 4748",extern:"PNL 4748 CL.D",intern:"PNL 4748 ICL.D"}],["W1",{norm:null,extern:"PNL 4748 CL.E",intern:"PNL 4681 ICL.E"}],["W2",{norm:"PNL 4560 E3",win1950:"PNL 1910 UP + 1950 DWN E3"}],["W3",{norm:"PNL 4292 E2",win1950:"PNL 1642 UP + 1950 DWN E2"}],["W4",{norm:null,extern:"PNL 4024 CR.E"}]]);static#vt=new Map([["N1",{norm:null,extern:"PNL 4681 CR.D",intern:"PNL 4681 ICR.D"}],["N2",{norm:"PNL 4681",win1950:"PNL 2031 UP + 1950 DWN"}],["N3",{norm:"PNL 4681",win1950:"PNL 2031 UP + 1950 DWN"}],["N4",{norm:"PNL 4681",extern:"PNL 4681 CL.D",intern:"PNL 4681 ICL.D"}],["E1",{norm:null,extern:"PNL 4828 CL.E",intern:"PNL 4828 ICL.E"}],["E2",{norm:"PNL 5096 E9",win1950:"PNL 2446 UP + 1950 DWN E9"}],["E3",{norm:"PNL 5364 E8",win1950:"PNL 2714 UP + 1950 DWN E8"}],["E4",{norm:"PNL 5498",extern:"PNL 5551 CR.E",intern:"PNL 5484 ICR.E"}],["S1",{norm:null,extern:"PNL 5551 CR.D",intern:"PNL 5484 ICR.D"}],["S2",{norm:"PNL 5551",win1950:"PNL 2901 UP + 1950 DWN"}],["S3",{norm:"PNL 5551",win1950:"PNL 2901 UP + 1950 DWN"}],["S4",{norm:"PNL 5551",extern:"PNL 5551 CL.D",intern:"PNL 5484 ICL.D"}],["W1",{norm:null,extern:"PNL 5551 CL.E",intern:"PNL 5484 ICL.E"}],["W2",{norm:"PNL 5364 E6",win1950:"PNL 2714 UP + 1950 DWN E6"}],["W3",{norm:"PNL 5096 E5",win1950:"PNL 2446 UP + 1950 DWN E5"}],["W4",{norm:"PNL 4828 E4",extern:"PNL 4828 CR.E",intern:"PNL 4828 ICR.E"}]]);static#Pt=new Map([["N1",{norm:null,extern:"PNL 3877 CR.D"}],["N2",{norm:"PNL 3877",win1950:"PNL 1227 UP + 1950 DWN"}],["N3",{norm:"PNL 3877",win1950:"PNL 1227 UP + 1950 DWN"}],["N4",{norm:"PNL 3877",extern:"PNL 3877 CL.D"}],["E1",{norm:null,extern:"PNL 4024 CL.E"}],["E2",{norm:"PNL 4292 E12",win1950:"PNL 1642 UP + 1950 DWN E12"}],["E3",{norm:"PNL 4560 E11",win1950:"PNL 1910 UP + 1950 DWN E11"}],["E4",{norm:"PNL 4828 E10",intern:"PNL 4681 ICR.E",intern2:"PNL 4828 ICL.E",win1950:"PNL 2178 UP + 1950 DWN E10"}],["E5",{norm:"PNL 5096 E9",win1950:"PNL 2446 UP + 1950 DWN E9"}],["E6",{norm:"PNL 5364 E8",win1950:"PNL 2714 UP + 1950 DWN E8"}],["E7",{norm:"PNL 5498",extern:"PNL 5551 CR.E",intern:"PNL 5484 ICR.E"}],["S1",{norm:null,extern:"PNL 5551 CR.D",intern:"PNL 5484 ICR.D"}],["S2",{norm:"PNL 5551",win1950:"PNL 2901 UP + 1950 DWN"}],["S3",{norm:"PNL 5551",win1950:"PNL 2901 UP + 1950 DWN"}],["S4",{norm:"PNL 5551",extern:"PNL 5551 CL.D",intern:"PNL 5484 ICL.D"}],["W1",{norm:null,extern:"PNL 5551 CL.E",intern:"PNL 5484 ICL.E"}],["W2",{norm:"PNL 5364 E6",win1950:"PNL 2714 UP + 1950 DWN E6"}],["W3",{norm:"PNL 5096 E5",win1950:"PNL 2446 UP + 1950 DWN E5"}],["W4",{norm:"PNL 4828 E4",intern:"PNL 4828 ICR.E",intern2:"PNL 4681 ICL.E",win1950:"PNL 2178 UP + 1950 DWN E4"}],["W5",{norm:"PNL 4560 E3",win1950:"PNL 1910 UP + 1950 DWN E3"}],["W6",{norm:"PNL 4292 E2",win1950:"PNL 1642 UP + 1950 DWN E2"}],["W7",{norm:null,extern:"PNL 4024 CR.E"}]]);static getFbxMapping(e){switch(e){case ze:return this.#Mt;case Te:return this.#vt;case ke:return this.#Pt;default:return console.error("unexpected block name:",e),null}}}nt.registerPlugin(class extends nt{#Ct=new B(!0);#xt;onEnabled(e){this.#xt=new lt(this.scene),this.rootViewModel.sharedShowWalls.Subscribe(()=>this.onHouseBlocksChanged(),e),this.#Ct.Subscribe(()=>this.onHouseBlocksChanged(),e),this.toolsModel.activeTool.Subscribe(()=>this.#Vt(),e)}onBuildInspector(e){const t=[ht.Checkbox2("Use HD models",this.rootViewModel.sharedShowWalls),ht.Hotkey("R"),ht.Checkbox2("Roofs",this.#Ct)],s=e.getSharedSection("View");s.BodyWidgets=[...s.BodyWidgets,...t]}onDocumentKeyDown(e){82===e.keyCode&&(this.#Ct.Value=!this.#Ct.Value)}#Vt(){"interior"==(this.toolsModel?.activeTool?.Value?.category??"")&&(this.#Ct.Value=!1)}#kt(){if(this.#Ct.Value&&this.rootViewModel.sharedShowWalls.Value)for(const e of this.houseModel.blocks){const t=ct.roofs.get(e.name);if(!t)continue;const s=e.getOrigin();for(const{fbx:o,pos:i,degree:n,rules:r}of t){if(!this.#zt(e,r))continue;const t=this.resourceManager.getObject(o);t.position.set(i.x,0,i.z),t.position.applyEuler(new u(0,se(e.direction),0)),t.position.add(s),t.rotation.set(0,se(n+e.direction),0),this.#xt.add(t)}}}#Tt(){if(this.rootViewModel.sharedShowWalls.Value)for(const e of this.houseModel.blocks){const t=ct.floors.get(e.name);if(!t)continue;const s=e.getOrigin();for(const{fbx:o,pos:i,degree:n,rules:r}of t){if(!this.#zt(e,r))continue;const t=this.resourceManager.getObject(o);t.position.set(i.x,0,i.z),t.position.applyEuler(new u(0,se(e.direction),0)),t.position.add(s),t.rotation.set(0,se(n+e.direction),0),this.#xt.add(t)}}}#Lt(){for(const e of this.houseModel.blocks)switch(e.name){case ke:case ze:case Te:this.#Wt(e)}}onHouseBlocksChanged(){this.#xt.clear(),this.#Lt(),this.#kt(),this.#Tt()}#Wt(e){const t=ct.getFbxMapping(e.name);for(const s of e.slots)if(s.visible){if(this.rootViewModel.sharedShowWalls.Value){const{norm:e,extern:o,intern:i,intern2:n,win1950:r}=t.get(s.key);let a=e;switch("external"===s.corner&&(a=o),"internal"===s.corner&&(a=i),"internal2"===s.corner&&(a=n),s.window){case Ae:a=r.replace("+ 1950 DWN","+ 450 DWN");break;case Re:case He:case Oe:a=r.replace("+ 1950 DWN","+ 850 DWN");break;case _e:a=r}if(a){a.startsWith("PNL")&&(a="A13.1.1 H.WALL. "+a);const e=this.resourceManager.getObject(a);e.position.copy(s.globalPosition),e.rotation.copy(s.globalRotation),this.#xt.add(e)}}if(s.window==_e){const e=this.resourceManager.getObject("Window 10x07");e.position.copy(s.globalPosition),e.rotation.copy(s.globalRotation),e.rotateY(se(180)),this.#xt.add(e)}else if(s.window==Re){const e=this.resourceManager.getObject("Window 10x18");e.position.copy(s.globalPosition),e.rotation.copy(s.globalRotation),e.rotateY(se(180)),this.#xt.add(e)}else if(s.window==He){const e=this.resourceManager.getObject("Window 20x18");e.position.copy(s.globalPosition),e.rotation.copy(s.globalRotation),e.rotateY(se(180)),this.#xt.add(e)}else if(s.window==Ae){const e=this.resourceManager.getObject("Door ext 10x22");e.position.copy(s.globalPosition),e.rotation.copy(s.globalRotation),e.rotateY(se(180)),this.#xt.add(e)}}}#zt(e,t){const s=this.houseModel,{order:o}=De.getEntity("block_shift",e.name),{x:i,z:n,direction:r}=e;for(let[e,a,l]of t){[e,a]=oe(e,a,r);const t=s.find(i+e,n+a);let h=!1;if(null!=t){const{order:e}=De.getEntity("block_shift",t.name);h=o==e}if(l!=h)return!1}return!0}});const ut=new Map;function dt(e,t){const s=Math.floor(e)+":"+Math.floor(t);if(ut.has(s))return ut.get(s);const o=Math.floor(50*Math.random())-10;return ut.set(s,o),o}class gt extends w{constructor(e=4473924){e=new l(e);const t=[],s=[];let o=0;for(let i=-10;i<=10;i++)for(let n=-10;n<=10;n++){const{x:r,z:a}=re.toVector(n-.5,i-.5),{x:l,z:h}=re.toVector(n+.5,i+.5);t.push(r,dt(r,a)+1,a,l,dt(l,a)+1,a),t.push(r,dt(r,a)+1,a,r,dt(r,h)+1,h),e.toArray(s,o),o+=3,e.toArray(s,o),o+=3,e.toArray(s,o),o+=3,e.toArray(s,o),o+=3}const i=new a;i.setAttribute("position",new d(t,3)),i.setAttribute("color",new d(s,3)),super(i,new p({vertexColors:!0,toneMapped:!1})),this.type="LandGridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}nt.registerPlugin(class extends nt{#Et=new B(!0);#Nt;constructor(){super();this.#Nt=new gt(3368499)}onEnabled(){this.viewManager.scene.add(this.#Nt),this.#Dt(),this.#Et.Subscribe(()=>this.#_t())}#Rt(){for(let e=-10;e<=10;e++){let t=null;for(let s=-10;s<=10;s++){const o=this.resourceManager.getObject("grass");null==t&&(t=o.material.clone(),t.color.setRGB(.8+.02*e,1,.8-.02*e)),o.material=t,o.receiveShadow=!0,o.position.copy(re.toVector(s,e)),this.scene.add(o)}}}#Dt(){const e=this.resourceManager.getObject("grass").material,t=new Float32Array([1,0,0,0,.5,.5,1,1,1,0,.5,.5,0,1,1,1,.5,.5,0,0,0,1,.5,.5]),s=new r(t,2);for(let t=-10;t<=10;t++){let o=null;for(let i=-10;i<=10;i++){const{x:n,z:l}=re.toVector(i-.5,t-.5),{x:h,z:c}=re.toVector(i+.5,t+.5),u={x:n,y:dt(n,l),z:l},d={x:h,y:dt(h,l),z:l},g={x:h,y:dt(h,c),z:c},f={x:n,y:dt(n,c),z:c},p=[u,d,g,f].reduce((e,t)=>({x:e.x+t.x,y:e.y+t.y,z:e.z+t.z})),w={x:p.x/4,y:p.y/4,z:p.z/4},x=new a,b=new Float32Array([d.x,d.y,d.z,u.x,u.y,u.z,w.x,w.y,w.z,g.x,g.y,g.z,d.x,d.y,d.z,w.x,w.y,w.z,f.x,f.y,f.z,g.x,g.y,g.z,w.x,w.y,w.z,u.x,u.y,u.z,f.x,f.y,f.z,w.x,w.y,w.z]);x.setAttribute("position",new r(b,3)),x.setAttribute("uv",s),x.computeVertexNormals(),null==o&&(o=e.clone(),o.color.setRGB(.8+.02*t,1,.8-.02*t));const y=new m(x,o);y.receiveShadow=!0,this.scene.add(y)}o=null}}onBuildInspector(e){e.appendToSharedSection("View",ht.Checkbox2("Show grid",this.#Et))}#_t(){this.#Nt.visible=this.#Et.Value}});class ft{#wt;#Ht;#Ot=!1;#At=null;get visible(){return this.#Ot}constructor(){const e=new n(320,100,320);e.translate(0,50,0);const t=new y({color:10305403,transparent:!0,opacity:.5});this.#Ht=new m(e,t),this.#At=this.#Ht}setScene(e){this.#wt!==e&&(this.#wt&&this.#Ot&&this.#wt.remove(this.#At),this.#wt=e,this.#wt&&this.#Ot&&this.#wt.add(this.#At))}setDirection(e){this.#At.rotation.set(0,se(-e),0)}setModel(e){if(this.#At==e)return;const t=this.#At;this.#Ot&&this.#wt&&this.#wt.remove(this.#At),this.#At=e||this.#Ht,this.#Ot&&this.#wt&&this.#wt.add(this.#At),this.#At.castShadow=!0,this.#At.position.copy(t.position),this.#At.rotation.copy(t.rotation)}showAt(e){this.#Ot||(this.#Ot=!0,this.#wt&&this.#wt.add(this.#At)),this.#At.position.copy(re.roundVector(e))}hide(){this.#Ot&&(this.#Ot=!1,this.#wt&&this.#wt.remove(this.#At))}getCoords(){return re.fromVector(this.#At.position)}}nt.registerPlugin(class extends nt{#It={title:"1. House 6x3",isEditHouseTool:!0,blockName:ke};#jt={title:"2. House 3x3 Hi",isEditHouseTool:!0,blockName:Te};#Bt={title:"3. House 3x3 Lo",isEditHouseTool:!0,blockName:ze};#Ft={title:"4. Garage 6x3",isEditHouseTool:!0,blockName:Le};#Gt={title:"5. Terrace 3x3 Hi",isEditHouseTool:!0,blockName:Ee};#Ut={title:"6. Terrace 3x3 Lo",isEditHouseTool:!0,blockName:We};#$t;#Kt=new ft;#Xt;#qt;#xt;pointerCoords=null;pointerOverBlock=null;constructor(){super();const e=new C(6300,6300);e.rotateX(-Math.PI/2),this.#$t=new m(e),this.#$t.visible=!1,this.#$t.addEventListener("collision_pointer_hittest",e=>{e.handled=!0}),this.#$t.addEventListener("collision_pointer_move",e=>{this.#Yt(e)}),this.#$t.addEventListener("collision_pointer_down",e=>{this.#Jt(e)}),this.#$t.addEventListener("collision_pointer_exit",e=>{this.#Qt(e)})}onEnabled(e){this.#xt=new lt(this.scene),this.scene.add(this.#$t),this.#Xt=new Map;for(const{id:e,fbxName:t}of De.getEntities("block"))this.#Xt.set(e,this.resourceManager.getObject(t));this.toolsModel.activeTool.Value=this.#It,e.Add(this.toolsModel.activeToolChanged.SubscribeAndNotify(()=>this.#Vt()))}getInspectorOrder(){return-1e3}onBuildInspector(e){const t=[];t.push(ht.Hotkey("ESC")),t.push(ht.Radiobox("",null,this.toolsModel.activeTool)),t.push(ht.Hotkey("1")),t.push(ht.Radiobox("House 6x3",this.#It,this.toolsModel.activeTool)),t.push(ht.Hotkey("2")),t.push(ht.Radiobox("House 3x3 Hi",this.#jt,this.toolsModel.activeTool)),t.push(ht.Hotkey("3")),t.push(ht.Radiobox("House 3x3 Low",this.#Bt,this.toolsModel.activeTool)),t.push(ht.Hotkey("4")),t.push(ht.Radiobox("Garage 6x3",this.#Ft,this.toolsModel.activeTool)),t.push(ht.Hotkey("5")),t.push(ht.Radiobox("Terrace 3x3 Hi",this.#Gt,this.toolsModel.activeTool)),t.push(ht.Hotkey("6")),t.push(ht.Radiobox("Terrace 3x3 Low",this.#Ut,this.toolsModel.activeTool));const s=ht.Header("Rotation"),o=ht.Button(" Left",()=>{this.toolsModel.rotateLeft()}),i=ht.Button(" Right",()=>{this.toolsModel.rotateRight()}),n=new Pe;n.Spacing=4,n.Constraints.With("height",32),n.Widgets=[o,i];const r=new ot;r.HeaderTitle="Modules",r.BodyWidgets=[...t,ht.Hotkey("ArrowRight"),s,n],e.addSection(r)}#Zt(){const e=this.toolsModel.activeBlockName,t=this.#Kt.getCoords(),s=this.toolsModel.activeDirection;return this.houseModel.canAdd2(e,t.x,t.z,s)}#es(){const e=this.#Kt.getCoords(),t=this.toolsModel.activeBlockName,s=this.toolsModel.activeDirection;this.houseModel.addNew(t,e.x,e.z,s)}#ts(e){if(this.#ss()&&e){const t=this.houseModel.find(e.x,e.z);t&&this.houseModel.remove(t)}}#Vt(){const e=this.toolsModel.activeTool.Value;if(!e?.isEditHouseTool)return this.#Kt.setModel(null),void this.#Kt.setScene(null);this.toolsModel.setBlockName(e.blockName),this.#Kt.setScene(this.scene),this.#Kt.setDirection(this.toolsModel.activeDirection),this.#qt=this.#Xt.get(this.toolsModel.activeBlockName),this.#Zt()?this.#Kt.setModel(this.#qt):this.#Kt.setModel(null)}onHouseBlocksChanged(){this.#xt.removeAll();for(const e of this.houseModel.blocks){const{fbxName:t}=De.getEntity("block",e.name),s=this.resourceManager.getObject(t);s.rotation.set(0,se(-e.direction),0),s.position.copy(re.toVector(e.x,e.z));const o=0,i=0;s.position.set(s.position.x+o,-1,s.position.z+i),s.visible=!1,this.#xt.add(s),s.addEventListener("collision_pointer_hittest",e=>{e.handled=this.#ss()}),s.addEventListener("collision_pointer_down",()=>{this.#ts(e)})}}#ss(){return!!this.toolsModel.activeTool.Value?.isEditHouseTool}#Yt(e){if(!this.#ss())return;const t=e.intersections.find(e=>e.object===this.#$t);if(t){this.pointerCoords=re.fromVector(t.point);const e=this.pointerCoords;this.#Kt.showAt(re.toVector(e.x,e.z))}else this.#Kt.hide();this.#Zt()?this.#Kt.setModel(this.#qt):this.#os()||this.#Kt.setModel(null)}#os(){const e=this.toolsModel.activeBlockName,t=this.#Kt.getCoords(),s=[];switch(e){case ke:s.push([this.#It,ke,0]),s.push([this.#It,ke,180]);break;case Te:case ze:s.push([this.#jt,Te,0]),s.push([this.#jt,Te,180]),s.push([this.#Bt,ze,0]),s.push([this.#Bt,ze,180]);break;case Le:s.push([this.#Ft,Le,0]),s.push([this.#Ft,Le,90]),s.push([this.#Ft,Le,180]),s.push([this.#Ft,Le,270]);break;case We:case Ee:s.push([this.#Ut,We,0]),s.push([this.#Ut,We,90]),s.push([this.#Ut,We,180]),s.push([this.#Ut,We,270]),s.push([this.#Gt,Ee,0]),s.push([this.#Gt,Ee,90]),s.push([this.#Gt,Ee,180]),s.push([this.#Gt,Ee,270])}const o=s.filter(([,e,s])=>this.houseModel.canAdd2(e,t.x,t.z,s));if(1===o.length){const[e,,t]=o[0];return this.toolsModel.activeTool.Value=e,this.toolsModel.setDirection(t),this.#Kt.setModel(this.#qt),!0}return!1}#Jt(){this.#ss()&&this.#Kt.visible&&(this.#Zt()&&this.#es(),this.#Kt.setModel(null))}#Qt(){this.#Kt.hide()}onDocumentKeyDown(e){switch(e.key){case"ArrowLeft":this.#ss()&&this.toolsModel.rotateLeft();break;case"ArrowRight":this.#ss()&&this.toolsModel.rotateRight();break;case"Escape":this.toolsModel.activeTool.Value=null;break;case"1":this.#is(this.#It);break;case"2":this.#is(this.#jt);break;case"3":this.#is(this.#Bt);break;case"4":this.#is(this.#Ft);break;case"5":this.#is(this.#Gt);break;case"6":this.#is(this.#Ut)}}#is(e){this.toolsModel.activeTool.Value===e?this.toolsModel.rotateRight():this.toolsModel.activeTool.Value=e}});const pt="eraser",wt=Ae,xt=_e,bt=Re,mt=He;class yt{static mapWindowKey=(()=>{const e=["N2","N3","E2","E3","S2","S3","W2","W3"],t=new Map;return t.set(ke,["N2","N3","E2","E3","E4","E5","E6","S2","S3","W2","W3","W4","W5","W6"]),t.set(Te,e),t.set(ze,e),t})();static toolCircle=[null,xt,bt,mt,wt,null]}nt.registerPlugin(class extends nt{#ns=new F("");#xt;getInspectorOrder(){return-900}onBuildInspector(e){e.addNewSection("Doors & Windows",ht.Hotkey("W"),ht.Radiobox("Eraser",pt,this.#ns),ht.Radiobox("Window 100x70",xt,this.#ns),ht.Radiobox("Window 100x180",bt,this.#ns),ht.Radiobox("Window 200x180",mt,this.#ns),ht.Radiobox("Door",wt,this.#ns))}onEnabled(e){this.#xt=new lt(this.scene),this.toolsModel.activeToolChanged.Subscribe(()=>{this.onHouseBlocksChanged(),this.toolsModel.activeTool.Value!==this&&(this.#ns.Value="")},e),this.#ns.Subscribe(e=>{e?this.toolsModel.activeTool.Value=this:this.toolsModel.activeTool.Value==this&&(this.toolsModel.activeTool.Value=null)},e)}onHouseBlocksChanged(){if(this.#xt.clear(),this.toolsModel.activeTool.Value===this)for(const e of this.houseModel.blocks){const t=yt.mapWindowKey.get(e.name);if(!t)continue;const s=Ne.getWalls(e.name);if(s)for(const o of s){if(-1===t.indexOf(o.key))continue;const s=e.getSlotInfo(o.key);s.visible&&null===s.corner&&this.#rs(e,o,()=>this.#as(e,o.key))}}}#as(e,t){switch(this.#ns.Value){case xt:case bt:case mt:case wt:this.houseModel.setWindowSlot(e,t,this.#ns.Value);break;case pt:this.houseModel.setWindowSlot(e,t,null)}}onDocumentKeyDown(e){switch(e.keyCode){case 87:{const e=yt.toolCircle.indexOf(this.#ns.Value);this.#ns.Value=yt.toolCircle.at(-1===e?1:e+1);break}}}#rs(e,t,s){const o=new W(t.x,0,t.z);o.applyEuler(new u(0,se(e.direction),0));const i=this.#ls();i.position.copy(e.getOrigin()),i.position.add(o),i.rotation.set(0,se(t.a+e.direction),0),i.addEventListener("collision_pointer_hittest",e=>{e.handled=!0}),i.addEventListener("collision_pointer_down",s),this.#xt.add(i)}#hs;#cs;#ls(){return this.#hs||(this.#hs=new n(10,240,100),this.#hs.translate(20,160,0)),this.#cs||(this.#cs=new y({color:255,transparent:!0,opacity:.1}),this.#cs.name="WallTouchTrigger",this.resourceManager.materials.set(this.#cs.name,this.#cs)),new m(this.#hs,this.#cs)}});class St{#us=null;#ds=0;setScene(){this.#us=null}onMouseEvent(e,t,s){if(t)1===e.buttons&&null===this.#us&&this.onStartDragging(e,t)&&(this.#ds=Date.now(),this.#us="down");else{if(s)return void(Date.now()-this.#ds>200&&"dragging"==this.#us&&(this.onEndDragging(e,t),this.#us=null));switch(this.#us){case"down":this.#us="dragging",this.onDragging(e);break;case"dragging":this.onDragging(e);break;default:this.onMouseOver(e)}}}onMouseOver(){}onStartDragging(){}onDragging(){}onEndDragging(){}}class Mt{static#gs=new Map;static#fs=null;static#ps=null;#ws=46;#xs=45.8;#bs=null;#ms=null;#ys=null;#Ss=null;get sceneObj(){return this.#Ss}constructor({strokeWidth:e,fillColor:t,floorLevel:s}){if(s&&(this.#ws=s,this.#xs=s-.2),null==Mt.#fs){const e=new R;e.color=new l(11141120),e.linewidth=3,e.worldUnits=!0,Mt.#fs=e}if(null==Mt.#ps){const e=new R;e.color=new l(0),e.linewidth=3,e.worldUnits=!0,Mt.#ps=e}if(e&&(this.#bs=new _,this.#ms=new m(this.#bs,Mt.#ps),this.#ms.receiveShadow=!0),t){const e=new l(t),s=e.getHexString();let o=Mt.#gs.get(s);null==o&&(o=new S({color:e}),Mt.#gs.set(s,o)),this.#ys=new m(new C,o)}const o=new f;this.#ms&&o.add(this.#ms),this.#ys&&o.add(this.#ys),this.#Ss=1===o.children.length?o.children.at(0):o}setBlackColor(){this.#ms&&(this.#ms.material=Mt.#ps)}setRedColor(){this.#ms&&(this.#ms.material=Mt.#fs)}setBlackOrRedColor(e){e?this.setBlackColor():this.setRedColor()}makeRectGeom(e,t){if(this.#bs){const s=e/2,o=t/2,i=this.#ws,n=[new W(-s,i,-o),new W(s,i,-o),new W(s,i,o),new W(-s,i,o),new W(-s,i,-o)];this.#bs.setFromPoints(n)}if(this.#ys){const s=new C(e,t);s.rotateX(se(-90)),s.translate(0,this.#xs,0),this.#ys.geometry=s}}makeRectGeom2(e,t,s,o){if(this.#bs){const i=this.#ws,n=[new W(e,i,t),new W(s,i,t),new W(s,i,o),new W(e,i,o),new W(e,i,t)];this.#bs.setFromPoints(n)}if(this.#ys){const i=new C(s-e,o-t);i.rotateX(se(-90)),i.translate((e+s)/2,this.#xs,(t+o)/2),this.#ys.geometry=i}}}class vt extends St{#Ms=new Mt({strokeWidth:3,floorLevel:46});#vs=[-40,-8,50,8,"hor","ver"];#Ps=null;constructor(){super(),this.#Ms.makeRectGeom2(...this.#vs)}setScene(e,t){this.#Ps=t,e.add(this.#Ms.sceneObj),super.setScene(e)}onExit(){this.#Ms.sceneObj.visible=!1}onMouseOver(e){this.#Ms.sceneObj.visible=!0;const t=qe.round1(e.intersectionPoint.x+5),s=qe.round1(e.intersectionPoint.z+5);this.#Ms.sceneObj.position.set(t,0,s);const o=this.#Ms.sceneObj.position,[i,n]=this.#Ps.houseModel.interior.canToggleDoor(o.x,o.z,this.#vs[4]);null!=n&&n!==this.#vs[4]&&this.rotate(),this.#Ms.setBlackOrRedColor(i)}onStartDragging(){const e=this.#Ms.sceneObj.position;return this.#Ps.houseModel.interior.toogleDoor(e.x,e.z,this.#vs[4]),!1}rotate(){const e=this.#vs;this.#vs=[e[1],e[0],e[3],e[2],e[5],e[4]],this.#Ms.makeRectGeom2(...this.#vs)}}class Pt extends St{#Ms=new Mt({strokeWidth:3,floorLevel:46});get#Cs(){return this.#Ms.sceneObj}#Vs=null;#ks=null;#Ps=null;constructor(){super(),this.#Ms.sceneObj.visible=!1}setScene(e,t){e.add(this.#Cs),this.#Ps=t,this.#Cs.visible=!1,this.#Vs=null,this.#ks=null,super.setScene(e)}onExit(){this.#Cs.visible=!1}#zs(e){const t=e.intersectionPoint,s=t.x,o=t.z,i=qe.round1(t.x+5),n=qe.round1(t.z+5),r=qe.round2(t.x+10),a=qe.round2(t.z+10),l=ie(s,o,r,a),h=ie(s,o,i,a),c=ie(s,o,r,n);return h<c&&h<l?[i,a,"hor"]:c<h&&c<l?[r,n,"ver"]:[r,a,"any"]}onMouseOver(e){if(null==e.intersectionPoint)return;const[t,s,o]=this.#zs(e);let i=null;"any"!==o&&"hor"!==o||(i=this.#Ps.houseModel.interior.canAddWall(t-10,s,t+10,s)?"hor":null),null!=i||"any"!==o&&"ver"!==o||(i=this.#Ps.houseModel.interior.canAddWall(t,s-10,t,s+10)?"ver":null),this.#Cs.geometry.setFromPoints("ver"===i?this.#Ts(0,0,0,10):this.#Ts(0,0,10,0)),this.#Cs.position.set(t,0,s),this.#Cs.visible=!0,this.#Ps.houseModel.interior.hasAnyAtPoint(t,s)?this.#Ms.setBlackOrRedColor(!1):this.#Ms.setBlackOrRedColor(null!=i)}onStartDragging(e){if(null==e.intersectionPoint)return;const[t,s,o]=this.#zs(e);if(this.#Ps.houseModel.interior.hasAnyAtPoint(t,s))return this.#Ps.houseModel.interior.removeAt(t,s),!1;const i=this.#Ps.houseModel.interior.canAddWall(t-10,s,t+10,s),n=this.#Ps.houseModel.interior.canAddWall(t,s-10,t,s+10);return i&&n?(this.#Vs=[t,s,o],!0):!i||"any"!==o&&"hor"!==o?!(!n||"any"!==o&&"ver"!==o||(this.#Vs=[t,s,"ver"],0)):(this.#Vs=[t,s,"hor"],!0)}onDragging(e){if(null==this.#Vs||null==e.intersectionPoint)return;const[t,s,o]=this.#Vs;let[i,n]=this.#zs(e);switch(o){case"hor":n=s;break;case"ver":i=t;break;default:Math.abs(i-t)<Math.abs(n-s)?i=t:n=s}i==t&&n==s&&("ver"===o?n=s+10:i=t+10),this.#ks=[i,n],this.#Cs.geometry.setFromPoints(this.#Ls(t,s,i,n)),this.#Cs.position.set(t,0,s),this.#Cs.visible=!0,this.#Ms.setBlackOrRedColor(this.#Ps.houseModel.interior.canAddWall(t,s,i,n))}onEndDragging(){if(null==this.#Vs||null==this.#ks)return;const[e,t,s]=this.#Vs,[o,i]=this.#ks;e>o?this.#Ps.houseModel.interior.addWall(e+10,t,o,i):e<o?this.#Ps.houseModel.interior.addWall(e-10,t,o,i):t>i?this.#Ps.houseModel.interior.addWall(e,t+10,o,i):t<i?this.#Ps.houseModel.interior.addWall(e,t-10,o,i):"ver"===s?this.#Ps.houseModel.interior.addWall(e,t-10,o,i+10):this.#Ps.houseModel.interior.addWall(e-10,t,o+10,i),this.#Vs=null,this.#ks=null,this.#Cs.visible=!1}#Ls(e,t,s,o){return this.#Ts(0,0,s-e,o-t)}#Ts(e,t,s,o){const i=new W(e,45.7,t),n=new W(s,45.7,o),r=n.clone().sub(i).normalize(),a=r.clone().applyAxisAngle(new W(0,1,0),se(90)).clone().multiplyScalar(10);return i.add(r.clone().multiplyScalar(-10)),[i,i.clone().add(a),n.clone().add(a),n.clone().sub(a),i.clone().sub(a),i,n]}}nt.registerPlugin(class extends nt{#Ws={category:"interior",title:"Preview interior wall"};#Es={category:"interior",title:"Add Internal Wall"};#Ns={category:"interior",title:"Add/Remove Internal Door"};#Ds=[];#xt=new lt(null);#_s=new lt(null);#Rs=new lt(null);#Hs=new lt(null);#Os=new Map;#As=new S({color:16777215});#Is=new S({color:7689536});#js;#Bs=new Pt;#Fs=new vt;constructor(){super();const e=new C(299,299);e.rotateX(se(-90)),e.translate(0,45,0);const t=new m(e);t.visible=!1;const s=7829367,o=new g(300,15,s,s);o.position.set(0,45.2,0),o.material.opacity=.6,o.material.transparent=!0,this.#js=new f,this.#js.add(t),this.#js.add(o)}getInspectorOrder(){return-850}onBuildInspector(e){e.addNewSection("Interior",ht.Hotkey("E"),ht.Radiobox("",this.#Ws,this.toolsModel.activeTool),ht.Radiobox("",this.#Es,this.toolsModel.activeTool),ht.Radiobox("",this.#Ns,this.toolsModel.activeTool))}onEnabled(e){this.#xt.setScene(this.scene),this.#Hs.setScene(this.scene),this.#_s.setScene(this.scene),this.#Rs.setScene(this.scene),this.toolsModel.activeTool.Subscribe(()=>{this.onHouseBlocksChanged()},e),this.houseModel.interior.wallsSignal.subscribe(()=>this.#Gs(),e),this.houseModel.interior.doorsSignal.subscribe(()=>this.#Us(),e)}onDocumentKeyDown(e){switch(69===e.keyCode&&(this.toolsModel.activeTool.Value===this.#Es?this.toolsModel.activeTool.Value=this.#Ns:this.toolsModel.activeTool.Value===this.#Ns?this.toolsModel.activeTool.Value=this.#Ws:this.toolsModel.activeTool.Value=this.#Es),e.key){case"ArrowLeft":case"ArrowRight":this.toolsModel.activeTool.Value===this.#Ns&&this.#Fs.rotate()}}onHouseBlocksChanged(){if(this.#xt.clear(),this.#Os.clear(),this.#Ds.length=0,!this.#$s()&&!this.#Ks())return this.#Xs(),void this.#qs();this.#Bs.setScene(this.#xt,this),this.#Fs.setScene(this.#xt,this),this.#Gs(),this.#Us();for(const e of this.houseModel.blocks){switch(e.name){case ke:case ze:case Te:break;default:continue}e.forEachCell((e,t,s)=>{const o=this.#js.clone();o.position.copy(re.toVector(t,s));const i=o.children[0];i.addEventListener("collision_pointer_hittest",e=>e.handled=!0),i.addEventListener("collision_pointer_move",e=>this.#Ys(e,!1,!1)),i.addEventListener("collision_pointer_down",e=>this.#Ys(e,!0,!1)),i.addEventListener("collision_pointer_up",e=>this.#Ys(e,!1,!0)),i.addEventListener("collision_pointer_exit",()=>{this.#Fs.onExit()}),this.#xt.add(o),this.#Ds.push(i)})}}#Ks(){return this.toolsModel.activeTool.Value===this.#Es}#$s(){return this.toolsModel.activeTool.Value===this.#Ns}#Ys(e,t,s){if(!this.#$s())return this.#Ks()?(null==e.intersectionPoint&&(e.intersectionPoint=be.findIntersection(e.intersections,this.#Ds)?.point),void this.#Bs.onMouseEvent(e,t,s)):void 0;this.#Fs.onMouseEvent(e,t,s)}#Us(){this.#Rs.clear();for(const e of this.houseModel.interior.doors){const t=(e.x1+e.x2)/2,s=(e.z1+e.z2)/2,o=Math.max(20,Math.abs(e.x1-e.x2)),i=Math.max(20,Math.abs(e.z1-e.z2)),n=new Mt({strokeWidth:3,fillColor:7689536,floorLevel:45.5});n.makeRectGeom(o,i),n.sceneObj.position.set(t,0,s),this.#Rs.add(n.sceneObj)}}async#qs(){this.#Rs.clear();for(const e of this.houseModel.interior.doors){const t=(e.x2+e.x1)/2,s=(e.z2+e.z1)/2,o=Math.max(20,e.x2-e.x1),i=Math.max(20,e.z2-e.z1),r=new n(o,135,i);r.translate(0,317.5,0);const a=new m(r,this.#As);a.position.set(t,0,s),a.receiveShadow=!0,a.castShadow=!0,this.#Rs.add(a);const l=await this.resourceManager.getInteriorDoorAsync();l.position.set(t,45,s),"hor"===e.dir?l.rotation.set(0,se(90),0):l.rotation.set(0,se(180),0),l.addEventListener("collision_pointer_hittest",e=>e.handled=!0),l.addEventListener("collision_pointer_down",e=>this.#Js(l)),this.#Rs.add(l)}}audioLoader=new o;soundOpen=null;soundClose=null;async#Js(e){const s=e.getObjectByName("door_2");let o,i;if(Math.cos(s.rotation.z)<-.9){if(i=se(180),o=se(255),null==this.soundOpen){const e=await this.audioLoader.loadAsync("assets/models/interior/Wooden_Door_open3.ogg"),s=new t(this.sceneManager.audioListener);s.setBuffer(e),s.setVolume(.5),s.setLoop(!1),this.soundOpen=s}this.soundOpen.play()}else{if(i=se(255),o=se(180),null==this.soundClose){const e=await this.audioLoader.loadAsync("assets/models/interior/Wooden_Door_close2.ogg"),s=new t(this.sceneManager.audioListener);s.setBuffer(e),s.setVolume(.5),s.setLoop(!1),this.soundClose=s}this.soundClose.play()}s.rotation.set(0,0,i);const n=performance.now(),r=()=>{const e=Math.min((performance.now()-n)/300,1);s.rotation.set(0,0,b.lerp(i,o,e)),e<1?requestAnimationFrame(r):s.rotation.set(0,0,o)};r()}#Qs(){this.#Rs.clear();for(const e of this.houseModel.interior.doors){const t=(e.x2+e.x1)/2,s=(e.z2+e.z1)/2,o=Math.max(20,e.x2-e.x1),i=Math.max(20,e.z2-e.z1),r=205,a=new n(o,r,i);a.translate(0,45+r/2,0);const l=new m(a,this.#Is);l.position.set(t,0,s),l.receiveShadow=!0,l.castShadow=!0,this.#Rs.add(l);const h=340,c=new n(o,h-r,i);c.translate(0,45+r+(h-r)/2,0);const u=new m(c,this.#As);u.position.set(t,0,s),u.receiveShadow=!0,u.castShadow=!0,this.#Rs.add(u)}}#Gs(){this.#Hs.clear();for(const e of this.houseModel.interior.walls){const t=(e.x1+e.x2)/2,s=(e.z1+e.z2)/2,o=Math.max(20,Math.abs(e.x1-e.x2)),i=Math.max(20,Math.abs(e.z1-e.z2)),n=new Mt({strokeWidth:3,fillColor:16777215,floorLevel:45.5});n.makeRectGeom(o,i),n.sceneObj.position.set(t,0,s),this.#Hs.add(n.sceneObj)}}#Xs(){this.#Hs.clear();for(const e of this.houseModel.interior.walls){const t=340,s=Math.max(20,Math.abs(e.x1-e.x2)),o=Math.max(20,Math.abs(e.z1-e.z2)),i=new n(s,t,o);i.translate(0,45+t/2,0);const r=new m(i,this.#As);r.position.set((e.x1+e.x2)/2,0,(e.z1+e.z2)/2),r.receiveShadow=!0,r.castShadow=!0,this.#Hs.add(r)}}}),nt.registerPlugin(class extends nt{#Zs=new F;#eo=new F("");#to=new F(!1);#so=new F(1);#oo=new F;#io=new F;onEnabled(){this.#Zs.Subscribe(()=>{this.#Zs.Value&&(this.#eo.Value=this.#Zs.Value.name,this.#to.Value=this.#Zs.Value.transparent,this.#so.Value=this.#Zs.Value.opacity,this.#oo.Value=this.#Zs.Value.metalness,this.#io.Value=this.#Zs.Value.roughness)})}onBuildInspector(e){te.isDev()&&e.addNewSection("Material",this.#no("Name",this.#eo,()=>this.#ro(-1),()=>this.#ro(1)),this.#no("Transparent",this.#to,()=>this.#ao(!1),()=>this.#ao(!0)),this.#lo("Opacity",this.#so,e=>e.opacity,(e,t)=>e.opacity=t,0,1),this.#lo("Metallness",this.#oo,e=>e.metalness,(e,t)=>e.metalness=t,0,1),this.#lo("Roughness",this.#io,e=>e.roughness,(e,t)=>e.roughness=t,0,1))}getInspectorOrder(){return 210}#ao(e){this.#ro(0),this.#Zs.Value&&(this.#Zs.Value.transparent=e,this.#to.Value=e)}#ro(e){if(0==this.resourceManager.materials.size)return;const t=[...this.resourceManager.materials.values()],s=new ae(t).OrderBy(e=>e.name).ToList();let o=0;if(this.#Zs.Value){const t=s.indexOf(this.#Zs.Value);-1!=t&&(o=Math.max(0,Math.min(s.length-1,t+e)))}this.#Zs.Value=s.at(o)}#lo(e,t,s,o,i,n){const r=e=>{this.#ro(0);const r=this.#Zs.Value;if(r){const a=s(r),l=Math.max(i,Math.min(n,a+e*(n-i)/20));o(r,l),r.needsUpdate=!0,t.Value=l}};return this.#no(e,t,()=>r(-1),()=>r(1))}#no(e,t,s,o){const i=ht.Text(`${e}...`);i.TextAlignment=[0,0];const n=ht.Button("-",s);n.Constraints.With("width",32);const r=ht.Button("+",o);r.Constraints.With("width",32);const a=new Pe;return a.Constraints.With("height",32),a.Widgets=[n,i,r],t.SubscribeToChanges(()=>{"number"==typeof t.Value?i.Text=`${e}: ${t.Value.toFixed(2)}`:i.Text=`${e}: ${t.Value}`}),a}}),nt.registerPlugin(class extends nt{#ho;constructor(){super(),this.#ho=new H}onSceneCreated(){document.body.appendChild(this.#ho.dom)}onRender(){this.#ho.update()}}),nt.registerPlugin(class extends nt{#co=!1;onHouseBlocksChanged(){if(this.#co)return;this.#co=!0;const e=[],t=this.houseModel;for(const s of t.blocks){if(s.name!=Te)continue;let o=null;switch(s.direction){case 0:o=t.find(s.x,s.z-1);break;case 180:o=t.find(s.x,s.z+1)}null!=o&&o.name==ze&&e.push([s,o])}for(const[s,o]of e)t.remove(s),t.remove(o),t.addNew(ke,s.x,s.z,s.direction);this.#co=!1}}),nt.registerPlugin(class extends nt{onBuildInspector(e){e.addNewSection("Rules",ht.Checkbox("Allow if not defined",tt.validatePlacementDefaults,()=>(tt.validatePlacementDefaults=!tt.validatePlacementDefaults,tt.validatePlacementDefaults)),ht.Button("Copy rules",()=>this.#uo()))}getInspectorOrder(){return 210}#uo(){const e=this.houseModel.printUndefinedRules();e.length?navigator.clipboard.writeText("new rules:\n"+e):navigator.clipboard.writeText("no new rules found")}});class Ct{static toJsonString(e){const t=[];if(e.length>0){let s=e.at(0).x,o=e.at(0).z;for(const t of e)t.forEachCell(function(e,t,i){s=Math.min(s,t),o=Math.min(o,i)});for(const i of e)i.forEachCell((e,i,n)=>{t.push({code:e.getCode(i,n),x:i-s,z:n-o})})}return JSON.stringify(t,null,2)}}nt.registerPlugin(class extends nt{#do;constructor(){super();const e=ht.Button("Download",()=>{le(Ct.toJsonString(this.houseModel.blocks),"house.json")}),t=ht.Button("Copy",()=>{const e=this.#go();navigator.clipboard.writeText(e)}),s=ht.Button("Save file...",()=>{le(this.#go(),"house.csv")}),o=ht.Button("Load file...",()=>this.#fo()),i=this.#do=new ot;i.HeaderTitle="JSON / CSV",i.BodyWidgets=[ht.Text("JSON"),e,ht.Text("CSV"),t,s,o]}getInspectorOrder(){return 200}onBuildInspector(e){e.addSection(this.#do)}#go(){const e=this.houseModel.blocks;if(0==e.size)return;let t=1e7,s=1e7,o=-1,i=-1;for(const n of e)n instanceof Be&&n.forEachCell((e,n,r)=>{t=Math.min(t,n),s=Math.min(s,r),o=Math.max(o,n),i=Math.max(i,r)});const n=o-t+1,r=i-s+1,a=Array.from({length:r},()=>Array(n).fill(""));for(const o of e)o instanceof Be&&o.forEachCell((e,o,i)=>{a[i-s][o-t]=e.getCode(o,i)});return a.map(e=>e.join(",")).join("\n")}async#fo(){const e=await new Promise(e=>{const t=document.createElement("input");t.type="file",t.addEventListener("change",t=>{const s=t.target.files;e(s)}),t.click()});var t;const s=[...(await(t=e[0],t?new Promise(e=>{const s=new FileReader;s.addEventListener("load",()=>{e(s.result)}),s.readAsText(t)}):Promise.reject())).split(/\r?\n|\r|\n/g)].map(e=>e.split(",")),o=s.length,i=s.at(0).length,n=this.houseModel;for(;n.blocks.length>0;)n.remove(n.blocks.at(0));const r=-i/2,a=-o/2;for(let e=0;e<i;e++)for(let t=0;t<o;t++){const o=s.at(t).at(e);if(""==o)continue;const i=Be.fromCode(o,r+e,a+t);null!=i&&(n.add(i)||console.log("skipped:",i,n))}}}),nt.registerPlugin(class extends nt{#po=[];#wo=new B(!1);onEnabled(){this.#wo.Subscribe(()=>this.onHouseBlocksChanged())}getInspectorOrder(){return 100}onBuildInspector(e){const t=e.getSharedSection("View"),s=ht.Checkbox2("Show House Columns",this.#wo);t.BodyWidgets=[...t.BodyWidgets,s]}onHouseBlocksChanged(){const e=new Set(this.#po);if(this.#wo.Value)for(const t of this.houseModel.blocks)for(const[s,o]of this.#xo(t)){const t=this.#bo(s,o);if(t){e.delete(t);continue}const i=this.resourceManager.getObject("column");this.scene.add(i),this.#po.push(i),i.position.set(s,0,o)}for(const t of e)ae.Remove(this.#po,t),this.scene.remove(t)}#bo(e,t){for(const s of this.#po){const o=s.position.x,i=s.position.z;if(!(e+1<o||e-1>o||t+1<i||t-1>i))return s}return null}#xo(e){const t=this.houseViewModel.blockToSceneObjMapping.get(e);let s=e.x,o=e.x,i=e.z,n=e.z;e.forEachCell((e,t,r)=>{s=Math.min(s,t),o=Math.max(o,t),i=Math.min(i,r),n=Math.max(n,r)});const r=e.getOrigin(),a=t.position,l=a.x-r.x,h=a.z-r.z,c=[re.toVector(s-.5,i-.5),re.toVector(o+.5,i-.5),re.toVector(o+.5,n+.5),re.toVector(s-.5,n+.5)],u=[];for(const{x:e,z:t}of c)u.push([e+l,t+h]);return u}}),nt.registerPlugin(class extends nt{#mo=[new W,new W,new W,new W,new W,new W,new W,new W];async onRender(){const e=this.viewManager,t=e.dirLight.shadow.camera,s=new i;if(this.scene.traverse(e=>{if(e.isMesh&&e.castShadow){const o=e.matrixWorld;e.geometry.computeBoundingBox();const i=e.geometry.boundingBox.min,n=e.geometry.boundingBox.max;this.#mo[0].set(i.x,i.y,i.z),this.#mo[1].set(n.x,i.y,i.z),this.#mo[2].set(i.x,n.y,i.z),this.#mo[3].set(i.x,i.y,n.z),this.#mo[4].set(n.x,n.y,i.z),this.#mo[5].set(n.x,i.y,n.z),this.#mo[6].set(i.x,n.y,n.z),this.#mo[7].set(n.x,n.y,n.z);for(const e of this.#mo)e.applyMatrix4(o),e.project(t),s.expandByPoint(e)}}),!s.isEmpty()){const o=(t.right-t.left)/2,i=(t.top-t.bottom)/2,n=(t.far-t.near)/2;t.left=t.left+o*(s.min.x+1),t.right=t.right+o*(s.max.x-1),t.top=t.top+i*(s.max.y-1),t.bottom=t.bottom+i*(s.min.y+1),t.far=t.far+n*(s.max.z-1)+1e3,t.near=t.near+n*(s.min.z+1),t.updateProjectionMatrix(),e.dirLightCameraHelper&&e.dirLightCameraHelper.update()}}}),function(e){e||(e=document.querySelector("#container"));const t=new at(e);var s=document.createElement("img");s.style.position="absolute",s.style.right="0px",s.style.top="0px",s.style.width="100px",s.style.height="100px",s.style.opacity=.7,s.src="./assets/cuby-logo.jpg",t.mainPage.imageHost.PlatformView.appendChild(s)}();